<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.46" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://springg.us.kg/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html"><meta property="og:site_name" content="mrjason’s Blog"><meta property="og:title" content="电商数仓系统(二)"><meta property="og:description" content="电商数仓系统(二) ##一、DWS/DWT准备 1.1 业务术语 1.2 系统函数 1.2.1 celloect_set 1.2.2 nvl 1.2.3 coalesce 1.2.4日期函数(重要) 二、DWS/DWT层 2.1 DWS/DWT思想 2.2 用户行为数据 2.2.1 每日设备DWS层 建表语句 加载数据 2.2.2 设备主题DWT层 建..."><meta property="og:type" content="article"><meta property="og:image" content="https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic GO/20200709012005.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-10-28T01:58:08.000Z"><meta property="article:author" content="MrJason"><meta property="article:modified_time" content="2024-10-28T01:58:08.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"电商数仓系统(二)","image":["https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic GO/20200709012005.png"],"dateModified":"2024-10-28T01:58:08.000Z","author":[{"@type":"Person","name":"MrJason","url":"https://springg.us.kg"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" href="https://springg.us.kg/rss.xml" title="mrjason’s Blog RSS Feed"><title>电商数仓系统(二) | mrjason’s Blog</title><meta name="description" content="电商数仓系统(二) ##一、DWS/DWT准备 1.1 业务术语 1.2 系统函数 1.2.1 celloect_set 1.2.2 nvl 1.2.3 coalesce 1.2.4日期函数(重要) 二、DWS/DWT层 2.1 DWS/DWT思想 2.2 用户行为数据 2.2.1 每日设备DWS层 建表语句 加载数据 2.2.2 设备主题DWT层 建...">
    <link rel="preload" href="/assets/style-D5zIXRKB.css" as="style"><link rel="stylesheet" href="/assets/style-D5zIXRKB.css">
    <link rel="modulepreload" href="/assets/app-mWs04Xnh.js"><link rel="modulepreload" href="/assets/电商数仓系统(二).html-Bu14sTNS.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">mrjason’s Blog</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="主页"><!--[--><span class="font-icon icon iconfont icon-home" style=""></span><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/demo/" aria-label="导航"><!--[--><span class="font-icon icon iconfont icon-discover" style=""></span><!--]-->导航<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="笔记分类"><!--[--><span class="font-icon icon iconfont icon-edit" style=""></span>笔记分类<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">代码笔记</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Computer-Basics/" aria-label="计算机基础"><!--[--><span class="font-icon icon iconfont icon-windows" style=""></span><!--]-->计算机基础<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Data-Structure/" aria-label="数据结构与算法"><!--[--><span class="font-icon icon iconfont icon-calculate" style=""></span><!--]-->数据结构与算法<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Web/" aria-label="前端笔记"><!--[--><span class="font-icon icon iconfont icon-code" style=""></span><!--]-->前端笔记<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Linux/" aria-label="Linux"><!--[--><span class="font-icon icon iconfont icon-linux" style=""></span><!--]-->Linux<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Python/" aria-label="Python"><!--[--><span class="font-icon icon iconfont icon-python" style=""></span><!--]-->Python<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Database/" aria-label="数据库"><!--[--><span class="font-icon icon iconfont icon-table" style=""></span><!--]-->数据库<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Docker/" aria-label="Docker"><!--[--><span class="font-icon icon iconfont icon-expansion" style=""></span><!--]-->Docker<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Git/" aria-label="Git"><!--[--><span class="font-icon icon iconfont icon-git" style=""></span><!--]-->Git<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Redis/" aria-label="Redis"><!--[--><span class="font-icon icon iconfont icon-lock" style=""></span><!--]-->Redis<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/MiddleWare/" aria-label="中间件"><!--[--><span class="font-icon icon iconfont icon-process" style=""></span><!--]-->中间件<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/posts/BigData/" aria-label="大数据"><!--[--><span class="font-icon icon iconfont icon-hot" style=""></span><!--]-->大数据<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Architect/" aria-label="架构师"><!--[--><span class="font-icon icon iconfont icon-study" style=""></span><!--]-->架构师<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Daily-Thoughts/" aria-label="日常思考"><!--[--><span class="font-icon icon iconfont icon-mark" style=""></span><!--]-->日常思考<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Development-Tools/" aria-label="开发工具"><!--[--><span class="font-icon icon iconfont icon-tool" style=""></span><!--]-->开发工具<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">博客相关</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/blog/" aria-label="博客相关"><!--[--><span class="font-icon icon iconfont icon-blog" style=""></span><!--]-->博客相关<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/posts/Java/" aria-label="Java"><!--[--><span class="font-icon icon iconfont icon-java" style=""></span><!--]-->Java<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/collect.html" aria-label="收藏"><!--[--><span class="font-icon icon iconfont icon-hk-shoucang1" style=""></span><!--]-->收藏<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/news/" aria-label="说说"><!--[--><span class="font-icon icon iconfont icon-news" style=""></span><!--]-->说说<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/visitorsbook.html" aria-label="留言板"><!--[--><span class="font-icon icon iconfont icon-mark" style=""></span><!--]-->留言板<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/friend.html" aria-label="友链"><!--[--><span class="font-icon icon iconfont icon-link" style=""></span><!--]-->友链<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="关于"><!--[--><span class="font-icon icon iconfont icon-info" style=""></span>关于<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/intro.html" aria-label="关于我"><!--[--><span class="font-icon icon iconfont icon-people" style=""></span><!--]-->关于我<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="关于本站"><!--[--><span class="font-icon icon iconfont icon-info" style=""></span><!--]-->关于本站<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/MrjackC/mrjackc.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://foreverblog.cn/go.html" title="穿梭虫洞-随机访问十年之约友链博客" target="_blank" rel="noopener noreferrer" aria-label="wormhole"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor" style="width:1.25rem;height:1.25rem;vertical-align:middle"><path d="M644.608 665.6c192.512-171.008 342.016-395.776 254.464-494.592-27.648-31.232-66.56-45.568-108.032-41.472-34.816 3.584-70.656 20.992-107.008 50.176-116.224-59.904-254.464-55.296-366.592 11.776-86.016 51.2-148.48 134.656-172.544 231.936-18.944 74.24-14.336 152.064 12.8 223.744-44.544 50.688-86.528 154.624-34.816 212.992 21.504 24.576 52.736 35.328 90.112 35.328 114.176-0.512 286.72-100.864 431.616-229.888z m155.648-452.608c14.848-1.536 26.624 2.56 36.352 13.824 9.728 10.752 7.168 39.936-10.752 80.896-18.944-28.672-41.984-55.296-68.096-77.824 17.92-10.752 32.256-15.872 42.496-16.896z m-598.528 517.12c18.944 27.136 40.96 51.712 66.048 73.216-43.008 12.8-72.192 11.776-81.92 1.024-8.704-10.752 0.512-45.056 15.872-74.24z m685.568-246.784c-51.2 75.264-122.368 154.112-200.704 224.256-81.408 72.192-171.008 134.656-254.464 176.64 26.112 5.632 52.224 8.704 78.848 8.704 68.096 0 135.168-18.944 194.048-53.76 124.416-73.216 195.072-211.968 182.272-355.84z m0 0" p-id="4157"></path></svg></a></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://www.travellings.cn/go.html" title="开往" target="_blank" rel="noopener noreferrer" aria-label="travelling"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor" style="width:1.25rem;height:1.25rem;vertical-align:middle"><path d="M658.836 519.32c-22.121 0-40.145 18.431-40.145 40.957 0 22.528 18.023 40.962 40.145 40.962 22.117 0 40.141-18.434 40.141-40.962 0-22.526-18.024-40.957-40.141-40.957zM364.742 519.32c-22.121 0-40.141 18.431-40.141 40.957 0.41 22.528 18.02 40.962 40.141 40.962 22.117 0 40.141-18.434 40.141-40.962 0-22.526-18.024-40.957-40.141-40.957z" p-id="8700"></path><path d="M512 0C229.23 0 0 229.23 0 512s229.23 512 512 512 512-229.23 512-512S794.77 0 512 0z m133.727 804.81c0 7.375-6.145 13.52-13.516 13.52H391.773c-7.371 0-13.515-6.145-13.515-13.52v-13.516c0-7.371 6.144-13.517 13.515-13.517h240.438c7.371 0 13.516 6.146 13.516 13.517v13.516z m120.832 37.273c-12.289 6.965-27.441 2.867-34.406-9.418l-54.887-96.668c-4.504 0.82-9.422 1.23-13.926 1.23H361.054c-4.914 0-9.421-0.41-13.925-1.23l-54.887 96.668c-6.965 12.285-22.527 16.383-34.406 9.418-12.289-6.961-16.383-22.938-9.422-35.223l51.199-90.113c-27.031-19.66-43.418-52.43-40.957-88.883l19.25-293.273c3.277-49.152 34.406-88.066 87.246-88.066h80.281c0-37.684 29.899-67.993 66.762-67.993 36.868 0 66.766 30.309 66.766 67.993h93.391c53.246 0 70.449 38.914 73.727 88.066l19.25 293.273c2.461 36.453-13.926 69.223-40.957 88.883l51.199 90.113c6.964 12.696 2.867 28.262-9.012 35.223z" p-id="8701"></path><path d="M672.352 314.931H351.633c-14.747 0-26.622 12.285-26.622 27.441v108.953c0 15.157 11.875 27.446 26.622 27.446h320.719c14.746 0 26.625-12.289 26.625-27.446V342.372c0-15.156-11.879-27.441-26.625-27.441z" p-id="8702"></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/BigData/" aria-label="01 大数据生态圈"><!---->01 大数据生态圈<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">02 Hive总结</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">04 Flume总结</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">04 接入层</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">05 Zookeeper总结</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">05 数据处理层</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">06 Kafka总结</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">07 Scala总结</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">08 Spark</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">10 Hbase</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">11 数仓</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/BigData/11_%E6%95%B0%E4%BB%93/Hive%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0.html" aria-label="Hive自定义函数"><!---->Hive自定义函数<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E9%A1%B9%E7%9B%AE%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85.html" aria-label="数仓项目补充"><!---->数仓项目补充<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%B8%80).html" aria-label="电商数仓系统"><!---->电商数仓系统<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html" aria-label="电商数仓系统(二)"><!---->电商数仓系统(二)<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->电商数仓系统(二)</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://springg.us.kg" target="_blank" rel="noopener noreferrer">MrJason</a></span><span property="author" content="MrJason"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-28T01:58:08.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon" name="eye"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html" data-page-key="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 55 分钟</span><meta property="timeRequired" content="PT55M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-1-业务术语">1.1 业务术语</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-2-系统函数">1.2 系统函数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#二、dws-dwt层">二、DWS/DWT层</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-1-dws-dwt思想">2.1 DWS/DWT思想</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-2-用户行为数据">2.2 用户行为数据</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-3-业务数据">2.3 业务数据</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-4-脚本">2.4 脚本</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#三、数仓搭建ads层">三、数仓搭建ADS层</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-0-ads层思想">3.0 ADS层思想</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-1-设备主题">3.1 设备主题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-2-会员主题">3.2 会员主题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-商品主题">3.3 商品主题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-4-营销主题">3.4 营销主题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-5-地区主题">3.5 地区主题</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-6-导入脚本">3.6 导入脚本</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="电商数仓系统-二" tabindex="-1"><a class="header-anchor" href="#电商数仓系统-二"><span>电商数仓系统(二)</span></a></h1><hr><p>##一、DWS/DWT准备</p><h3 id="_1-1-业务术语" tabindex="-1"><a class="header-anchor" href="#_1-1-业务术语"><span>1.1 业务术语</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、统计流量相关的需求：使用设备id，如统计活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    b、统计业务相关的指标，使用用户id，如统计下单数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--2. 新增用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、如果一个用户首次打开某APP，那这个用户定义为新增用户；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    b、卸载再安装的设备，不会被算作一次新增。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    c、新增用户包括日新增用户、周新增用户、月新增用户。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、打开应用的用户即为活跃用户，不考虑用户的使用情况。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、每天一台设备打开多次会被计为一个活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 周活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、某个自然周（月）内启动过应用的用户；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、该周（月）内的多次启动只记一个活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 月活跃率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、当月活跃用户 / 总用户数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 6. 沉默用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、用户仅在安装当天（次日）启动一次，后续时间无再启动行为</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、指标可以反映新增用户质量和用户与APP的匹配程度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 7. 版本分布</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、不同版本的周内各天新增用户数，活跃用户数和启动次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、判断APP各个版本之间的优劣和用户行为习惯</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 8. 本周回流用</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、上周未启动应用, 本周启动了应用的用户，且不是本周新增用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 9. 连续n周</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续n周, 每周至少启动一次</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 10. 忠诚用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、连续活跃5周以上的用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 10. 连续活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续两周以上的活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 11. 近期流失用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续n(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-4周)周没有启动应用的用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 12. 留存用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、例如，5月份新增用户200，这200人启动情况：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  6月份：启动人数为100人，5月份新增用户一个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  7月份：启动人数为80人，5月份新增用户二个月后的留存率是40%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  8月份：启动人数为100人，5月份新增用户三个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	c、留存用户一般是统计留存率，同时必须有两个参数：哪个月份的几月的留存率</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 13. 用户新鲜度</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、每天启动应用的新老用户比例</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、用户新鲜度 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 新用户数量 / 当日活跃用户数 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 14. 单次使用时长</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、每次启动使用的时间长度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 15. 日使用时长</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、累计一天内的使用时间长度。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 16. 启动次数计算标准</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;背景&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：IOS平台应用退到后台，是真的退出应用，后台会释放资源</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          Android平台应用退到后台，并不会立即退出应用，因为应用和应用之间存在互相唤醒的问题。</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;统计方式&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        IOS平台应用退到后台就算一次独立的启动</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        Android平台我们规定，两次启动之间的间隔小于30秒，被计算一次启动</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-系统函数" tabindex="-1"><a class="header-anchor" href="#_1-2-系统函数"><span>1.2 系统函数</span></a></h3><h4 id="_1-2-1-celloect-set" tabindex="-1"><a class="header-anchor" href="#_1-2-1-celloect-set"><span>1.2.1 celloect_set</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 作用：将一列数据收集变成一行数据,返回一个数组</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 区别：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      collect_set : 会去重</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      collect_list: 不会去重</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--  3. 案例：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 数据准备：</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">          drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">          create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> stud</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#C678DD;--shiki-dark:#C678DD;">name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, area string, course string, score </span><span style="color:#C678DD;--shiki-dark:#C678DD;">int</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 插入数据：</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;zhang3&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;math&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">88</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;li4&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;math&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">99</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;wang5&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sh&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">92</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;zhao6&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sh&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">54</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;tian7&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">91</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 查询数据：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course , collect_set(area),</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">avg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(score) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            &#39;打印结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            course	_c1	_c2</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            chinese	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;sh&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	79</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            math	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	93</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course ,collset_list(area),</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">avg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(score) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            &#39;打印结果&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            course	_c1	_c2</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            math	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;bj&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	93</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            chinese	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;sh&quot;,&quot;sh&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	79</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-nvl" tabindex="-1"><a class="header-anchor" href="#_1-2-2-nvl"><span>1.2.2 nvl</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 函数：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     nvl（表达式1，表达式2）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 返回值：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      只能传递两个参数，从左往右找，找到一个非null的值，就返回，如果两个表示式都为null，则返回null</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 参数说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.表达式类型：数字型、字符型和日期型</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.两个表达式的数据类型必须相同</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 4. 案例：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lianzp&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">); </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">结果：</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       报错：The </span><span style="color:#C678DD;--shiki-dark:#C678DD;">first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> seconds</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> arguments of </span><span style="color:#C678DD;--shiki-dark:#C678DD;">function</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> NLV should have the same </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;lianzp&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 结果为null</span></span></code></pre></div><h4 id="_1-2-3-coalesce" tabindex="-1"><a class="header-anchor" href="#_1-2-3-coalesce"><span>1.2.3 coalesce</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1.  coalesce(a1, a2, ...) </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2.  作用：- Returns the first non-null argument，返回第一不为null的值</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3.  和nvl主要区别是：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       a、可以有多个参数</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 要求所有参数的类型保持一致：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       The expressions </span><span style="color:#C678DD;--shiki-dark:#C678DD;">after</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COALESCE should all have the same </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span></span></code></pre></div><h4 id="_1-2-4日期函数-重要" tabindex="-1"><a class="header-anchor" href="#_1-2-4日期函数-重要"><span>1.2.4日期函数(重要)</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. date_format函数（根据格式整理日期）</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. date_add函数（加减日期）</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">13</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">15</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. next_day(start_date, day_of_week) </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 返回当期日期的下一个周几。</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. day_of_week：可选参数：</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 可以写前面两个字母，实际开发中，周一和周末使用频率最高</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      	星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    Returns</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> which </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> later than </span><span style="color:#C678DD;--shiki-dark:#C678DD;">start_date</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> named </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> indicated.</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 需求：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          a、需求1：返回下一个周一</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">             select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">13</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          b、需求2：返回本周末：求出下一个周一再减1天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">12</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          c、需求3：返回上个周日，求出下一个周一再减8天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">             select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">05</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. last_day(date) </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     返回当前日期的最后一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     Returns</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">last</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> day</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> of the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">month</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> which the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">date</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> belongs </span><span style="color:#C678DD;--shiki-dark:#C678DD;">to</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> last_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">); </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 当前日期：current_date</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> current_day;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、dws-dwt层" tabindex="-1"><a class="header-anchor" href="#二、dws-dwt层"><span>二、DWS/DWT层</span></a></h2><h3 id="_2-1-dws-dwt思想" tabindex="-1"><a class="header-anchor" href="#_2-1-dws-dwt思想"><span>2.1 DWS/DWT思想</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. dwd层和dws/dwt的区别？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     	DWD层建表时不要考虑用户的需求，而dws和dwd层，以用户需求为驱动，统计各个维度的相关指标；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. dws和dwt都是建宽表，建宽表的目的是优化查询,减少重复查询的步骤。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 用户后续的需求是什么样的呢？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       主要是报表，体现的指标有个数、次数、金额等指标。</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;体现的方式&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：维度 + 时间 + 指标</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;案例&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           a、地区维度：北京地区今天的下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           b、商品维度：1号商品今天下单数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 建宽表的思路：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 一个维度作为一个宽表；</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 字段：以维度作为关键字 + 和该维度相关的所有事实表的度量值</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. DWS和DWT的主要区别：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dws的数据来源于DWD层，站在维度的角度，看事实表的度量值，统计每个主题当天的行为</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt的主要数据来源dws，站在维度的角度，看事实表的开始时间、结束时间、累积到现在的度量值，累积一段时间的度量值，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       统计每个主题累计行为，如统计最近7天的下单金额。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 6. 宽表是应对一些常用的需求，并不是所有的需求都会包含进来，如果一些特殊需求，可以去到dwd层获取数据</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-用户行为数据" tabindex="-1"><a class="header-anchor" href="#_2-2-用户行为数据"><span>2.2 用户行为数据</span></a></h3><h4 id="_2-2-1-每日设备dws层" tabindex="-1"><a class="header-anchor" href="#_2-2-1-每日设备dws层"><span>2.2.1 每日设备DWS层</span></a></h4><ul><li>建表语句</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `mid_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `brand`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `model`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `page_stats`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">page_id:string,page_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;页面访问统计&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">partitioned </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_uv_detail_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>加载数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_start_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        model,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,brand,model</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_page_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            model,      </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;page_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,page_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;page_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,page_count)) page_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                model,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                page_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">                count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) page_count     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_page_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  mid_id ,brand,model,page_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  mid_id ,brand,model</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        page_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_page_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-设备主题dwt层" tabindex="-1"><a class="header-anchor" href="#_2-2-2-设备主题dwt层"><span>2.2.2 设备主题DWT层</span></a></h4><ul><li>建表语句</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `mid_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `brand`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `model`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_date_first`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次活跃时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_date_last`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次活跃时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日活跃次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积活跃天数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_uv_topic&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic old </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        model, </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-业务数据" tabindex="-1"><a class="header-anchor" href="#_2-3-业务数据"><span>2.3 业务数据</span></a></h3><h4 id="_2-3-1-会员行为" tabindex="-1"><a class="header-anchor" href="#_2-3-1-会员行为"><span>2.3.1 会员行为</span></a></h4><h5 id="_2-3-1-1-会员dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-1-1-会员dws层"><span>2.3.1.1 会员DWS层</span></a></h5><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 建表过程：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;准备&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：  事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：找到和用户维度相关的所有事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: 找到这些事实表的所有度量值字段：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：维度主键 + 第二步获取的字段作为dws宽表的字段。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 备注：理论上上述所有事实表都需要进行统计，但是在本案例中，只统计了订单、订单详情表、支付，加购物车四个事实表的数据。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 数据的来源：来自于DWD层</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 表中的数据说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是分区表，每个分区为当天的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 每一行数据代表一个用户当天的行为</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 根据建表字段，确定每个字段来自于哪张表中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 数据存储格式：列式存储 + lzo压缩</span></span></code></pre></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户 id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;登录次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount    </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_detail_stats </span><span style="color:#C678DD;--shiki-dark:#C678DD;">array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">sku_id:string,sku_num:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单明细统计&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日用户行为&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">`dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_user_action_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>第一步：确定各个字段来自哪个表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">user_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户 id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--从dwd_start_log获取 </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;登录次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--从dwd_start_log获取</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_action_log</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount    </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_detail_stats </span><span style="color:#C678DD;--shiki-dark:#C678DD;">array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">sku_id:string,sku_num:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comm</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	  -- dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	 说明：</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 加入购车的数据，需要去启动日志中获取，因为加购事实表是每天一个快照，不保留中间操作的过程，所以去到日志action</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	      	获取，点击一次加购物车操作，记一次加入购物车的次数</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 用户登录次数，从启动日志中获取，启动一次算作今天登录一次，但是要注意有些登录不是会员，所以需要过滤user_id为</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	         null的数据；</span></span></code></pre></div><ul><li>第二步：确定dws一行数据代表什么意思？</li></ul><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>用户行为表的一行数据代表：一个用户今天登陆次数、加购物车数量、下单数量、下单金额等数据</span></span></code></pre></div><ul><li>第三步：确定dwd层所有相关表的同步策略</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_start_log&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：每日新增数据</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_action_log&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：每日新增数据</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_order_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：事务型</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_order_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：事务型</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_payment_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">:事务型</span></span></code></pre></div><ul><li>第四步：从各个表中获取对应的字段</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 1. 获取用户id和登录次数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		  user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	---------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 2. 获取加购物车的次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		 select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id		</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  ------------------------------------------ </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 3. 获取下单的次数和下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_total_amount)  order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   ------------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 4. 获取支付的金额和支付次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		 user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		 count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		 sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   ----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 5. 获取下单明细</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_num&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_num,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_amount&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount))order_detail_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			  user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			  sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  cast</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> demical(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id,sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	   )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>第五步：组装以后插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_start_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_action_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id        </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_order_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_total_amount)  order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_payment_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   tmp_order_detail </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_num&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_num,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_amount&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount)) order_detail_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              cast</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id,sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)   ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_detail_stats       </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_payment_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_payment_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order_detail </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order_detail</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-1-2-会员dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-1-2-会员dwt层"><span>2.3.1.2 会员DWT层</span></a></h5><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt和dws层的字段基本是一一对应的。</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dws是当天的数据，dwt是累积数据，累积涉及到时间，比如累积7天，累积3天</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. dwt和dws的维度字段，我们也可以直接放到表中，后续统计需求可以用到。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. dwt数据说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是维度全量表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 数据源来自于dws层</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 不是分区表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 如何维护dwt表，即如何向这个全量表中插入数据？</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt的数据每天都需要进行更新；</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 更新涉及到新数据和老数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 更新方式：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       a、取累积时间周期的数据；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       b、如果是累积字段，使用聚合函数求值</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       c、如果非累积字段，使用判断语句求当天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       d、然后新旧数据今天合并，由于旧数据不是分区数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         那么累积数据直接使用新表累积值，而非累积字段，采用更新的方式</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户主题宽表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_user_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>分析</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	旧表：dwt前一天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   新表：从dws层获取的累积30天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--如果旧表中有登录时间就使用旧表中的时间，否则使用当天时间</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表中今天的登入次数大于0，那么末次登录时间使用今天时间，否则使用旧时间</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表中的登入次数大于0，那么旧表中数据 + 1 </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 使用新表中累积计算数据，如果为null，则选择0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果旧表中首次下单时间为null且新表中下单次数大于0，那么使用今天时间，否则使用旧表数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表的下单数据大于0，则使用当天时间，否则使用旧表数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 将旧表下单数据和新表下单次数直接相加</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--将旧表下单金额和新表下单金额相加</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--直接使用新表数据，如果新表数据为null，则使用0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--直接使用新表数据，如果新表数据为null，则使用0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付金额&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>装载数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;"> insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dwt_user_topic old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   full join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,login_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天登录次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天加入购物车次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天支付次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天支付金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--累积30天登录次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_last_30d_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_last_30d_amount</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(dt , -</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   )new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-商品行为" tabindex="-1"><a class="header-anchor" href="#_2-3-2-商品行为"><span>2.3.2 商品行为</span></a></h4><h5 id="_2-3-2-1-商品dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-2-1-商品dws层"><span>2.3.2.1 商品DWS层</span></a></h5><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 解析：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表的字段如何创建</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;准备&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：  事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：找到和商品这个维度相关的所有事实表：订单详情、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：获取上述事实表的并取其度量值</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：将商品维度id + 第二步度量值的字段作为dws层的字段，创建商品行为的dws层表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 如何向表中插入数据？</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：根据dws层表的字段，确定每个字段来自于哪个表</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：确定第一步中所有表的同步策略，确定表中存储的数据是什么及每行数据存储的是什么</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：一个一个字段来获取最后进行合并</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表保存什么数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表中每行数据是什么</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 存储格式</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 分区表，每个分区保留当前最新的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 列式存储 + lzo压缩</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日商品行为&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">`dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_sku_action_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>分析过程</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">==================================================</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：订单详情事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单的创建时间为分区数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有的下单的信息</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	   sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) order_num, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单件数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(original_amount_d) order_amount </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单金额	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-------------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：支付事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单支付时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有的支付信息</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 说明： 有一种情况，昨天晚上下单，但是今天才支付,那么下单的sku_id不在支付中，这样可能会导致数据丢失</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 	    </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">				order_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 1. 相关表：退款事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，退款时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有退款的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		      sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount		  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dwd_fact_order_refund_info </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 1. 相关表：加购车</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：周期型快照事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每天一个快照</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_cart_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> create_time </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：收藏表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：周期型快照事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每天一个快照</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_favor_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> create_time </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     -- 1. 相关表：评价事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单支付时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每个分区保留当天的评价数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1201&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_good_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1202&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1203&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1204&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_default_count,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_comment_info </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) order_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_payment </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) payment_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_refund </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) refund_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_refund_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_cart </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),tmp_favor </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;favor_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_appraise </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1201&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_good_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1202&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1203&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1204&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_comment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(favor_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_good_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_mid_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_bad_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_default_count)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_payment</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_refund</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_cart</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_favor</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_appraise</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-2-2-商品dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-2-2-商品dwt层"><span>2.3.2.2 商品DWT层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    spu_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日默认评价数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品主题宽表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_sku_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    sku_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">spu_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">dwt_sku_topic old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_num ,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ))  order_num, </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) order_amount ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_num,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_num,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_amount,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) cart_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,favor_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) favor_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_good_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_good_count,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_mid_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ) ) appraise_mid_count ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_bad_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_bad_count,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_default_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_default_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count30 ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_num) order_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_num) payment_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count) refund_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num) refund_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count) cart_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(favor_count) favor_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_good_count) appraise_good_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_mid_count) appraise_mid_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_bad_count) appraise_bad_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_default_count) appraise_default_count30 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add (</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, -</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id    </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> * </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_sku_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) sku_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> sku_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-4-活动统计" tabindex="-1"><a class="header-anchor" href="#_2-3-4-活动统计"><span>2.3.4 活动统计</span></a></h4><h5 id="_2-3-4-1-活动dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-4-1-活动dws层"><span>2.3.4.1 活动DWS层</span></a></h5><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `activity_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `activity_type`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动类型&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `start_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;开始时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `end_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;结束时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `create_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `display_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `display_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_activity_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>插入数据</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        activity_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> activity_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> activity_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_display </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item activity_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) display_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_display_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item_type</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;activity_id&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_activity </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_activity_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_activity_info_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_op</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_display </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_activity </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-4-2-活动dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-4-2-活动dwt层"><span>2.3.4.2 活动DWT层</span></a></h5><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `activity_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `activity_type`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动类型&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `start_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;开始时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `end_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;结束时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `create_time`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `display_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `display_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_activity_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_activity_info_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-5-地区统计" tabindex="-1"><a class="header-anchor" href="#_2-3-5-地区统计"><span>2.3.5 地区统计</span></a></h4><h5 id="_2-3-5-1-地区dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-5-1-地区dws层"><span>2.3.5.1 地区DWS层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `id`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `province_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `area_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `iso_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_count`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日地区信息表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">`dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_area_stats_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_login </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        area_code,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> area_code</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        province_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> province_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_login</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_base_province pro</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_login </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_login</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-5-2-地区dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-5-2-地区dwt层"><span>2.3.5.2 地区DWT层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `id`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `province_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `area_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `iso_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_day_count`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_last_30d_count`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_last_30d_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_last_30d_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_last_30d_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_last_30d_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_area_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_day_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_day_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        region_name,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,login_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_day_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_day_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_count) login_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> id,province_name,area_code,iso_code,region_id,region_name</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-脚本"><span>2.4 脚本</span></a></h3><h4 id="_2-4-1-dws脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-1-dws脚本"><span>2.4.1 DWS脚本</span></a></h4><ol><li>在/home/atguigu/bin目录下创建脚本dwd_to_dws.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dwd_to_dws.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_start as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        model,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id,brand,model</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_page as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        model,        </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        collect_set(named_struct(&#39;page_id&#39;,page_id,&#39;page_count&#39;,page_count)) page_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            model,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            page_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            count(*) page_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_page_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id,brand,model,page_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id,brand,model</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.mid_id,tmp_page.mid_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.brand,tmp_page.brand),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.model,tmp_page.model),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_start.login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_page.page_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_start </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join tmp_page</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on tmp_start.mid_id=tmp_page.mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and tmp_start.brand=tmp_page.brand</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and tmp_start.model=tmp_page.model;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_login as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cart as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_total_amount) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_payment as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order_detail as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        collect_set(named_struct(&#39;sku_id&#39;,sku_id,&#39;sku_num&#39;,sku_num,&#39;order_count&#39;,order_count,&#39;order_amount&#39;,order_amount)) order_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            sum(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            cast(sum(final_amount_d) as decimal(20,2)) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by user_id,sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_login.user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(cart_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(payment_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_login</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_cart on tmp_login.user_id=tmp_cart.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_order on tmp_login.user_id=tmp_order.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_payment on tmp_login.user_id=tmp_payment.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_order_detail on tmp_login.user_id=tmp_order_detail.user_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(sku_num) order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_amount_d) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_payment as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(sku_num) payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and order_id in</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_refund as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_num) refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_amount) refund_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_refund_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cart as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),tmp_favor as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) favor_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;favor_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_appraise as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1201&#39;,1,0)) appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1202&#39;,1,0)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1203&#39;,1,0)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1204&#39;,1,0)) appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_comment_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(cart_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(favor_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_good_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_mid_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_bad_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_default_count)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_order</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_payment</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count        </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_refund</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_cart</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_favor</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_appraise</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by sku_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_login as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by area_code</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_op as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        province_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by province_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_area_stats_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_login.login_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.payment_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_base_province pro</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_login on pro.area_code=tmp_login.area_code</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_op on pro.id=tmp_op.province_id;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_op as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        activity_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and activity_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by activity_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_display as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item activity_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) display_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_display_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and item_type=&#39;activity_id&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_activity as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_activity_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_activity_info_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.activity_id,tmp_display.activity_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.activity_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.activity_type,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.start_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.end_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.create_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_display.display_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_op</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join tmp_display on tmp_op.activity_id=tmp_display.activity_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_activity on nvl(tmp_op.activity_id,tmp_display.activity_id)=tmp_activity.id;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-2-dwt脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-2-dwt脚本"><span>2.4.2 DWT脚本</span></a></h4><ol><li>在/home/atguigu/bin目录下创建脚本dws_to_dwt.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dws_to_dwt.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.mid_id,old.mid_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.model,old.model),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.brand,old.brand),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.mid_id is null,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.mid_id is not null,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.mid_id is not null, new.login_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.login_count,0)+if(new.login_count&gt;0,1,0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.mid_id=new.mid_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.user_id,old.user_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.login_date_first is null and new.login_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.login_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.login_count,0)+if(new.login_count&gt;0,1,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.order_date_first is null and new.order_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.order_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.order_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.order_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_count,0)+nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_amount,0)+nvl(new.order_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.payment_date_first is null and new.payment_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.payment_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.payment_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.payment_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_count,0)+nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_amount,0)+nvl(new.payment_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_amount,0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,login_count,0)) login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_count,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0)) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(login_count&gt;0,1,0)) login_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add( &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.user_id=new.user_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.sku_id,old.sku_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_info.spu_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_count,0) + nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_num,0) + nvl(new.order_num,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_amount,0) + nvl(new.order_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_count,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_num,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_amount,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_count,0) + nvl(new.refund_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_num,0) + nvl(new.refund_num,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_amount,0) + nvl(new.refund_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.cart_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.cart_count,0) + nvl(new.cart_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.favor_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.favor_count,0) + nvl(new.favor_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_good_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_mid_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_bad_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_default_count30,0)  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_good_count,0) + nvl(new.appraise_good_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_mid_count,0) + nvl(new.appraise_mid_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_bad_count,0) + nvl(new.appraise_bad_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_default_count,0) + nvl(new.appraise_default_count,0) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        spu_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_amount  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_default_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_default_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;, order_count,0 )) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_num ,0 ))  order_num, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0 )) order_amount ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0 )) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_num,0 )) payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0 )) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_count,0 )) refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_num,0 )) refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_amount,0 )) refund_amount,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,cart_count,0 )) cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,favor_count,0 )) favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_good_count,0 )) appraise_good_count,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_mid_count,0 ) ) appraise_mid_count ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_bad_count,0 )) appraise_bad_count,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_default_count,0 )) appraise_default_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_count30 ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_num) order_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_num) payment_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_count) refund_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_num) refund_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_amount) refund_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(cart_count) cart_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(favor_count) favor_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_good_count) appraise_good_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_mid_count) appraise_mid_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_bad_count) appraise_bad_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_default_count) appraise_default_count30 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt &gt;= date_add (&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;, -30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id    </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on new.sku_id = old.sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(select * from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_sku_info where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;) sku_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on nvl(new.sku_id,old.sku_id)= sku_info.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_activity_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.id,old.id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.activity_name,old.activity_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.activity_type,old.activity_type),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.start_time,old.start_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.end_time,old.end_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.create_time,old.create_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.display_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.display_count,0)+nvl(old.display_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count,0)+nvl(old.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount,0.0)+nvl(old.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count,0)+nvl(old.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount,0.0)+nvl(old.payment_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_activity_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_activity_info_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.id=new.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.id,new.id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.province_name,new.province_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.area_code,new.area_code),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.iso_code,new.iso_code),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.region_id,new.region_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.region_name,new.region_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_day_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_day_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,login_count,0)) login_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_count,0)) order_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0.0)) order_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0)) payment_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0.0)) payment_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(login_count) login_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_area_stats_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by id,province_name,area_code,iso_code,region_id,region_name</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.id=new.id;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三、数仓搭建ads层" tabindex="-1"><a class="header-anchor" href="#三、数仓搭建ads层"><span>三、数仓搭建ADS层</span></a></h2><h3 id="_3-0-ads层思想" tabindex="-1"><a class="header-anchor" href="#_3-0-ads层思想"><span>3.0 ADS层思想</span></a></h3><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 解题思路：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：分析指标，明确指标具体的含义，不可有歧义</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：确定数据来源，寻找数据的方式，先从dwt层 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd 层依次往回找，找到能满足需求的表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三表: 找步骤2表的方式：找相关主题的表，因为在ads层的统计指标，也是按照维度 + 时间 + 指标的方式今天统计。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 统计流量，使用用户行为数据，统计和业务相关的指标，使用业务数据。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 老生常谈：知道每一张表中存储了什么数据。每行数据代表什么意思。关键、关键、关键。</span></span></code></pre></div><h3 id="_3-1-设备主题" tabindex="-1"><a class="header-anchor" href="#_3-1-设备主题"><span>3.1 设备主题</span></a></h3><h4 id="_3-1-1-活跃设备数" tabindex="-1"><a class="header-anchor" href="#_3-1-1-活跃设备数"><span>3.1.1 活跃设备数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是活跃设备</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      a、打开应用的用户即为活跃用户，不考虑用户的使用情况。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  b、每天一台设备打开多次会被计为一个活跃用户</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 需求：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;日活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当日活跃的设备数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;周活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当周活跃的设备数,在这一周内，多次活跃也计算为1次</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;月活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当月活跃的设备数,在这一月内，多次活跃也计算为1次</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wk_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当周用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `mn_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当月用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `is_weekend`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y,N是否是周末,用于得到本周最终结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `is_monthend`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y,N是否是月末,用于得到本月最终结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃设备数&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_uv_count/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    wk_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    mn_count ,       </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;N&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  is_weekend ,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">last_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;N&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)    is_monthend</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">         &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_day_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ))  day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last  </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) wk_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  mn_count     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-2-每日新增设备" tabindex="-1"><a class="header-anchor" href="#_3-1-2-每日新增设备"><span>3.1.2 每日新增设备</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `create_date`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `new_mid_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">   BIGINT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增设备数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日新增设备信息数量&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_new_mid_count/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-1-3-留存率" tabindex="-1"><a class="header-anchor" href="#_3-1-3-留存率"><span>3.1.3 留存率</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是留存率？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、例如，5月份新增用户200，这200人启动情况：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  6月份：启动人数为100人，5月份新增用户一个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  7月份：启动人数为80人，5月份新增用户二个月后的留存率是40%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  8月份：启动人数为100人，5月份新增用户三个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	c、留存用户一般是统计留存率，同时必须有两个参数：哪个月份的几月的留存率</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 本案例需要统计的指标是：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    计算每天的1、</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">、3日留存率</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 实现方式</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第一步：统计当天所有的活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第二步：统计昨天的1日留存率，求出昨天的新用户但是今天上线的用户/昨天的新用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第三步：统计前天的2日留存率，求出前天的新用户但是今天上线的用户/前天的新用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    所以需要统计的数量有：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 昨天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 昨天的新用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 前天的新用户</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>![image-20200708203545115](<a href="https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic" target="_blank" rel="noopener noreferrer">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</a> GO/20200709012005.png)</p><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `stat_date`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `create_date`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;设备新增日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `retention_day`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">     int</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;截止当前日期留存天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `retention_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">    bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;留存数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `new_mid_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">     bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;设备新增数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     `retention_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">   decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;留存率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日用户留存情况&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_retention_day_rate/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">             &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  1day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 昨天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_1day ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--昨天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  2day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 前天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_2day ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  3day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 大前天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_3day </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--大前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_1day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          1day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_1day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> /1day_count retention_ratio</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_2day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          2day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_2day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / 2day_count retention_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_3day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          3day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_3day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / 3day_count retention_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-4-沉默用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-4-沉默用户数"><span>3.1.4 沉默用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是沉默用户？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   只在安装当天启动过，且启动时间是在7天前</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现过程</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 统计首次活跃时间 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 最后末次活跃时间，且最后活跃时间在7天前的用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `silent_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;沉默设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_silent_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">login_date_last</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre></div><h4 id="_3-1-5-本周回流用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-5-本周回流用户数"><span>3.1.5 本周回流用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是本周回流用户？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   上周未活跃，本周活跃的设备，且不是本周新增设备</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现步骤：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：获取本周活跃的用户且不是本周新增的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：获取上周的活跃的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三步：第一步获取的用户减少第二步获取的用户就是本周回流的用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wk_dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期所在周&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wastage_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;回流设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_back_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) wk_dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">not</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">             mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)         </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-6-流失用户" tabindex="-1"><a class="header-anchor" href="#_3-1-6-流失用户"><span>3.1.6 流失用户</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是流失用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	最近7天未活跃的设备</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现步骤</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第一步：获取最近活跃时间小于7天</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wastage_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;流失设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_wastage_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">         &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><h4 id="_3-1-7-最近连续三周活跃用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-7-最近连续三周活跃用户数"><span>3.1.7 最近连续三周活跃用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 实现步骤</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步: 从dws层获取前一周、前两周以及当前周的所有活跃的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步： 然后进行内连接，能连接上的，则说明这连续的3周都活跃了，最后按照用户进行分组去重后求count。</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_wk_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_wk_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期,一般用结束周周日日期,如果每天计算一次,可用当天日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wk_dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;持续时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `continuity_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃次数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_continuity_wk_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 1wk_mid</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id     </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    2wk_mid  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    3wk_mid  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">21</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  ads_continuity_wk_count</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 1wk_mid </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 2wk_mid </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 3wk_mid </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-8-最近七天内连续三天活跃" tabindex="-1"><a class="header-anchor" href="#_3-1-8-最近七天内连续三天活跃"><span>3.1.8 最近七天内连续三天活跃</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 思路：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：从dws层获取最近7天的数据,对数据按照用户分组进行开窗，按照活跃时间进行降序排序</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：使用活跃时间减去排名，获取一列</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三步：按照用户和第三步的列进行分组，求count(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 3的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第四步：分组去重</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第五步：求7天内连续3天的活跃用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `wk_dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近7天日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `continuity_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;连续活跃设备数&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_continuity_uv_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>分析</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -- 第一步：从dws层获取最近7天的数据,对数据按照用户分组进行开窗，按照活跃时间进行降序排序</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        row_number</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="color:#C678DD;--shiki-dark:#C678DD;">over</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ) rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t1</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第二步：使用活跃时间减去排名，获取一列</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        dt ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		date_add(dt,-rk) dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t1    </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第三步：按照用户和第三步的列进行分组，求count(*) &gt; =3的用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	    mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t2 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    having</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> 	count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第四步：分组去重</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	     mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t3</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	--第五步：求7天内连续3天的活跃用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">	&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">6</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) wk_dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) continuity_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t4</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) wk_dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) continuity_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    dt ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    date_add(dt,rk) dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                        mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                        dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">                        row_number</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="color:#C678DD;--shiki-dark:#C678DD;">over</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ) rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                )t1</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            )t2 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            having</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        )t3</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )t4</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-会员主题" tabindex="-1"><a class="header-anchor" href="#_3-2-会员主题"><span>3.2 会员主题</span></a></h3><h4 id="_3-2-1-会员主题信息" tabindex="-1"><a class="header-anchor" href="#_3-2-1-会员主题信息"><span>3.2.1 会员主题信息</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 几个指标说明</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 总付费会员数：指付费的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员活跃率 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天会员活跃数量 /  总的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员付费率 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天会员付费人数 /  总的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员新鲜度 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天新增会员数量 / 今天活跃的会员数量</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_users`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_new_users`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_new_payment_users`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增消费会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_users`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;总付费会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `users`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;总会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_users2users`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员活跃率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_users2users`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员付费率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `day_new_users2users`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员新鲜度&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员主题信息表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_topic&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天活跃会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_new_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天新增会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_new_payment_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天新增消费会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_users , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--总付费会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 总会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)    day_users2users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员活跃率</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)  payment_users2users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员付费率</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))    day_new_users2users </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员新鲜度</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic</span></span></code></pre></div><h4 id="_3-2-2-漏斗分析" tabindex="-1"><a class="header-anchor" href="#_3-2-2-漏斗分析"><span>3.2.2 漏斗分析</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是漏斗分析？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   其实是指转化率，同一个会员同一次操作业务过程为：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   浏览页面 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 进入详情的页面 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 加入购物车 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 下单 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 支付</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   理论上从左往右的人数是越来越少，所以称之为漏斗</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 说明：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   理论上：进入详情页面的方式有很多，不止是通过浏览页面，所以我们在计算从浏览页面以后进入详情页面应该是连续的，才能算作从浏览</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   页面到页面详情的转换率，但是在本案例中，比较简单粗暴，处理的方式是：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 统计方式：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计浏览首页的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">:统计今天浏览过详情页面的人数，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                          同一个人多次浏览首页算作1次,数据来源每日设备行为:dwd_page_log</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览商品详情页面的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天浏览过详情页面的人数，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                          同一个用户多次浏览商品详情算作1次，数据来源每日设备行为:dwd_page_log</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加购物车的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天加购物车的人数，数据来源：每日会员行为dws_user_action_daycount</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天下单的人数,数据来源：每日会员行为dws_user_action_daycount</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天支付的人数,数据来源：每日会员行为dws_user_action_daycount</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `home_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览首页人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `good_detail_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览商品详情页人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `home2good_detail_convert_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首页到商品详情转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `cart_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `good_detail2cart_convert_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品详情页到加入购物车转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `cart2order_convert_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车到下单转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order2payment_convert_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单到支付的转化率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户行为漏斗分析&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited  fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_action_convert_day/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车的人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--支付人数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_page </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) home_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览首页人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) good_detail_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览商品详情页人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> /</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) home2good_detail_convert_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--首页到商品详情转化率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        --对用户进行分组，过滤出今天进入首页和详情页的用户，获取当天用户的页面行为，去重后放到一个集合中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 那么一行数据有如下2种情况</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 用户     page_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 243  [&quot;good_detail&quot;,&quot;home&quot;]</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 63   [&quot;home&quot;]</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        collect_set(page_id) pages</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_page_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> page_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     home_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览首页人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     good_detail_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览商品详情页人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     home2good_detail_convert_ratio ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--首页到商品详情转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车的人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     cart_count *</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/good_detail_count good_detail2cart_convert_ratio,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品详情页到加入购物车转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     order_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     order_count *</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/cart_count  cart2order_convert_ratio ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车到下单转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     payment_count,  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--支付人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     payment_count * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / order_count order2payment_convert_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的转化率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_page </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-商品主题" tabindex="-1"><a class="header-anchor" href="#_3-3-商品主题"><span>3.3 商品主题</span></a></h3><h4 id="_3-3-1-商品个数信息" tabindex="-1"><a class="header-anchor" href="#_3-3-1-商品个数信息"><span>3.3.1 商品个数信息</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 需求分析：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_num`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku个数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    统计到目前为止的sku数量</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `spu_num`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu个数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    统计到目前为止的spu数量</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_num`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku个数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `spu_num`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu个数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品个数信息&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_sku </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) sku_num </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--sku个数  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_spu </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) spu_num </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--spu个数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">           &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           spu_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> spu_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">      &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      sku_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      spu_num</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_sku </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_spu </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_spu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-商品销量排名" tabindex="-1"><a class="header-anchor" href="#_3-3-2-商品销量排名"><span>3.3.2 商品销量排名</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 商品销量排名：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是按照什么规则进行排名？本需求是按照当天的产品的支付金额的大小进行排名</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;销量&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品个数信息&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_sale_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span></span></code></pre></div><h4 id="_3-3-3-商品收藏排名" tabindex="-1"><a class="header-anchor" href="#_3-3-3-商品收藏排名"><span>3.3.3 商品收藏排名</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `favor_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;收藏量&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品收藏TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_favor_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-4-商品加入购物车排名" tabindex="-1"><a class="header-anchor" href="#_3-3-4-商品加入购物车排名"><span>3.3.4 商品加入购物车排名</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `cart_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品加入购物车TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_cart_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-5-商品退款率排名-近30天" tabindex="-1"><a class="header-anchor" href="#_3-3-5-商品退款率排名-近30天"><span>3.3.5 商品退款率排名(近30天)</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `refund_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;退款率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品退款率TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_refund_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_count/payment_last_30d_count*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_ratio</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-6-商品差评率" tabindex="-1"><a class="header-anchor" href="#_3-3-6-商品差评率"><span>3.3.6 商品差评率</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `sku_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `appraise_bad_ratio`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品差评率TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_appraise_bad_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">appraise_bad_count/(appraise_good_count+appraise_mid_count+appraise_bad_count+appraise_default_count) appraise_bad_ratio</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h3 id="_3-4-营销主题" tabindex="-1"><a class="header-anchor" href="#_3-4-营销主题"><span>3.4 营销主题</span></a></h3><h4 id="_3-4-1-下单数目统计" tabindex="-1"><a class="header-anchor" href="#_3-4-1-下单数目统计"><span>3.4.1 下单数目统计</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单笔数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_users </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单用户数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日订单总计表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_order_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><p>插入数据</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单笔数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount ) order_amount ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单用户数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span></code></pre></div><p>分析</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-4-2-支付信息统计" tabindex="-1"><a class="header-anchor" href="#_3-4-2-支付信息统计"><span>3.4.2 支付信息统计</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付笔数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_user_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_sku_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付商品数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_avg_time </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单到支付的平均时长，取分钟数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日订单总计表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_payment_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_user </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付笔数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_user_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付人数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">      &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_sku_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付商品数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(unix_timestamp(payment_time)-unix_timestamp(create_time))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)/</span><span style="color:#D19A66;--shiki-dark:#D19A66;">60</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_avg_time </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的平均时长，取分钟数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_time </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付笔数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_user_count ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_sku_count ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付商品数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_avg_time </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的平均时长，取分钟数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_user</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_user</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-品牌复购率-月复购" tabindex="-1"><a class="header-anchor" href="#_3-4-3-品牌复购率-月复购"><span>3.4.3 品牌复购率(月复购)</span></a></h4><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tm_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;品牌id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1级品类id &#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_name string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1级品类名称 &#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buycount   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_twice_last </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;两次以上购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_twice_last_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单次复购率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_3times_last   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment   </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;三次以上购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_3times_last_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;多次复购率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    stat_mn string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计月份&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    stat_date string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)   COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;复购率统计&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_sale_tm_category1_stat_mn/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        user_id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--用户di</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        order_stats_struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品id</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        order_stats_struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品被购买的次数</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 使用侧写的方式，将一个用户当天购买的每个商品的明细（数组）进行侧写，形成多行</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount lateral view explode(order_detail_stats) tmp </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_stats_struct </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--取当天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_sku </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        tm_id, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 品牌id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        category1_id, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一次品类的id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        category1_name </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--一次品类的名字</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_sku_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tm_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_name,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buycount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buyTwiceLast,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">( </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buyTwiceLastRatio,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  buy3timeLast  ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">( </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buy3timeLastRatio ,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) stat_mn,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stat_date</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一级品类</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一级品类的名字</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tm_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 品牌</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 购买同一品牌数量</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_sku</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 按照用户 + 1级品类 + 品牌id分组，得到一个用户购买某一个1级品类的某一品牌的个数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tm_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)tmp</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 按照品牌进行 + </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tm_id, category1_id, category1_name;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-地区主题" tabindex="-1"><a class="header-anchor" href="#_3-5-地区主题"><span>3.5 地区主题</span></a></h3><h4 id="_3-5-1-地区主题信息" tabindex="-1"><a class="header-anchor" href="#_3-5-1-地区主题信息"><span>3.5.1 地区主题信息</span></a></h4><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `dt`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `id`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `province_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `area_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `iso_code`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_id`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `region_name`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `login_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `order_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_count`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    `payment_day_amount`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_area_topic/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_amount</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 直接导入dwt的地区表</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-导入脚本" tabindex="-1"><a class="header-anchor" href="#_3-6-导入脚本"><span>3.6 导入脚本</span></a></h3><ol><li>在/home/atguigu/bin目录下创建脚本dwt_to_ads.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dwt_to_ads.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_uv_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    daycount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    wkcount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    mncount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;Y&#39;,&#39;N&#39;) ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(last_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;Y&#39;,&#39;N&#39;) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)daycount join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count (*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_last&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) wkcount on daycount.dt=wkcount.dt</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count (*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where date_format(login_date_last,&#39;yyyy-MM&#39;)=date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;yyyy-MM&#39;)  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)mncount on daycount.dt=mncount.dt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_new_mid_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_date_first,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by login_date_first;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_silent_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where login_date_first=login_date_last</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and login_date_last&lt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-7);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_back_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">concat(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7),&#39;_&#39;, date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_last&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_first&lt;date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)current_wk</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7*2) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and dt&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7-1) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)last_wk</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on current_wk.mid_id=last_wk.mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where last_wk.mid_id is null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_wastage_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&lt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t1;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_retention_day_rate</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    1,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的1日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    2,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的2日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    3,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的3日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_continuity_wk_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    concat(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7*3),&#39;_&#39;,date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*2)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*3)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*2-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )t1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    having count(*)=3</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t2;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_continuity_uv_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    concat(date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-6),&#39;_&#39;,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select mid_id      </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                date_sub(dt,rank) date_dif</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    rank() over(partition by mid_id order by dt) rank</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                where dt&gt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-6) and dt&lt;=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            )t1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        )t2 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id,date_dif</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        having count(*)&gt;=3</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )t3 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t4;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_count&gt;0,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_count&gt;0,1,0))/count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_uv as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(array_contains(pages,&#39;home&#39;),1,0)) home_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(array_contains(pages,&#39;good_detail&#39;),1,0)) good_detail_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            collect_set(page_id) pages</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_page_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and page_id in (&#39;home&#39;,&#39;good_detail&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cop as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(cart_count&gt;0,1,0)) cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(order_count&gt;0,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_action_convert_day</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.home_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.good_detail_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.good_detail_count/tmp_uv.home_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.cart_count/tmp_uv.good_detail_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.order_count/tmp_cop.cart_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.payment_count/tmp_cop.order_count*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_uv</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join tmp_cop</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on tmp_uv.dt=tmp_cop.dt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) sku_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) tmp_sku_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ) tmp_spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) tmp_spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_sku_num.dt=tmp_spu_num.dt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_sale_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by payment_amount desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_favor_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    favor_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by favor_count desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_cart_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by cart_count desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_refund_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    refund_last_30d_count/payment_last_30d_count*100 refund_ratio</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by refund_ratio desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_appraise_bad_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">appraise_bad_count/(appraise_good_count+appraise_mid_count+appraise_bad_count+appraise_default_count) appraise_bad_ratio</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by appraise_bad_ratio desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_order_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;0,1,0))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_payment_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_user_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_skucount.payment_sku_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_time.payment_avg_time</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_user_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_payment</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_sku_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_skucount on tmp_payment.dt=tmp_skucount.dt</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(unix_timestamp(payment_time)-unix_timestamp(create_time))/count(*)/60 payment_avg_time</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and payment_time is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_time on tmp_payment.dt=tmp_time.dt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_stats_struct.sku_id sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_stats_struct.order_count order_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount lateral view explode(order_detail_stats) tmp as order_stats_struct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where date_format(dt,&#39;yyyy-MM&#39;)=date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;yyyy-MM&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_sku as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        category1_name</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_sku_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    category1_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=1,1,0)) buycount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=2,1,0)) buyTwiceLast,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=2,1,0))/sum( if(order_count&gt;=1,1,0)) buyTwiceLastRatio,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=3,1,0))  buy3timeLast  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=3,1,0))/sum( if(order_count&gt;=1,1,0)) buy3timeLastRatio ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; ,&#39;yyyy-MM&#39;) stat_mn,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; stat_date</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_order.user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.category1_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_order</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    join tmp_sku</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    on tmp_order.sku_id=tmp_sku.id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by tmp_order.user_id,tmp_sku.category1_id,tmp_sku.category1_name,tmp_sku.tm_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by tm_id, category1_id, category1_name;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_day_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from ${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>ods层：24张</span></span>
<span class="line"><span>    log：1张</span></span>
<span class="line"><span>    业务数据：23张。</span></span>
<span class="line"><span>dwd层：19张</span></span>
<span class="line"><span>    log：5张</span></span>
<span class="line"><span>    业务数据：6张维度表，8张事实表</span></span>
<span class="line"><span>dws和dwt层：12张</span></span>
<span class="line"><span>    维度：设备、会员、商品、地区、时间、活动：12张</span></span>
<span class="line"><span>ads层：20张</span></span>
<span class="line"><span>    设备：8张</span></span>
<span class="line"><span>    会员：2张</span></span>
<span class="line"><span>    商品：6张</span></span>
<span class="line"><span>    营销：3张</span></span>
<span class="line"><span>    地区：1张</span></span>
<span class="line"><span>共计：20 + 12 + 19 + 24 = 75张</span></span>
<span class="line"><span>另外：</span></span>
<span class="line"><span>临时表：拉链表：1张</span></span>
<span class="line"><span>       时间表：1张</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><div class="sponsor" data-v-98f29c97><div id="drinks-box" data-v-98f29c97><div id="drinks-box-s" class="drinks-button left-100" data-v-98f29c97><div id="drinks-icons" class="left-100 tr3" data-v-98f29c97><div id="coffee-donate" class="icon-donate" data-v-98f29c97><span class="font-icon icon iconfont icon-hk-flutter" data-v-98f29c97></span> 赞助 </div></div><div id="drinks-button-box" class="tr3 left-100" data-v-98f29c97><div id="drinks-button-bg" class="left-100" data-v-98f29c97></div><div id="github-box" data-v-98f29c97><a href="https://github.com/OrageKK/sponsor-page" target="_blank" data-v-98f29c97>Github</a></div><ul id="donate-buttons" class="list tr3" data-v-98f29c97><li id="paypal_donate" data-v-98f29c97><a href="https://www.paypal.me/oragekk" target="_blank" data-v-98f29c97>Paypal</a></li><!-- <li id="btc_donate" class="donate-button">Bitcoin</li> --><li id="alipay_donate" class="donate-button" data-v-98f29c97>AliPay</li><li id="wechat_donate" class="donate-button2" data-v-98f29c97>WeChat</li></ul></div><div id="drinks-qrcodes" class="left-100 tr3" data-v-98f29c97><div id="drinks-qrcode" data-v-98f29c97></div></div></div></div></div><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/MrjackC/mrjackc.github.io/edit/main/src/posts/BigData/11_数仓/电商数仓系统(二).md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 845886914@qq.com">MrJason</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%B8%80).html" aria-label="电商数仓系统"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->电商数仓系统</div></a><!----></nav><div id="vp-comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">你认为这篇文章怎么样？</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_agree.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_look_down.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sunglasses.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_pick_nose.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_awkward.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sleep.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址(可选)</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" aria-hidden="true" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片" aria-label="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <span>  /  <span class="">300</span></span>  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.3.2</div></div></div><!----><!--]--></main><!--]--><div style="--0dfcb062:;"><footer class="footer-wrapper" style="display:none;"><div class="busuanzi"><span id="busuanzi_container_site_pv" style="display:none;"> 本站总访问量 <span id="busuanzi_value_site_pv"></span>次 <span class="post-meta-divider">|</span></span><span id="busuanzi_container_site_uv" style="display:none;"> 您是本站第 <span id="busuanzi_value_site_uv"></span>位访问者 </span></div><div class="footer-content"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2020-2024 MrJason</div></div><span id="runtime_span"></span><div class="footer-link"><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="https://img.foreverblog.cn/wormhole_1.gif" alt="" style="width:auto;height:32px;" title="穿梭虫洞-随机访问十年之约友链博客"></a><a href="https://www.travellings.cn/go.html" target="_blank"><img src="https://www.travellings.cn/assets/logo.gif" alt="" style="width:auto;height:32px;" title="开往-友链接力"></a></div></footer></div></div><!--]--><!--[--><!----><!----><div></div><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-mWs04Xnh.js" defer></script>
  </body>
</html>
