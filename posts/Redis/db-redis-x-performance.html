<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.46" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mrjason.me/posts/Redis/db-redis-x-performance.html"><meta property="og:site_name" content="mrjason’s Blog"><meta property="og:title" content="Redis进阶 - 性能调优：Redis性能调优详解"><meta property="og:description" content="Redis进阶 - 性能调优：Redis性能调优详解 Redis 的性能问题，涉及到的知识点非常广，几乎涵盖了 CPU、内存、网络、甚至磁盘的方方面面；同时还需要对上文中一些基础或底层有详细的了解。 1. 前言 Redis 作为优秀的内存数据库，其拥有非常高的性能，单个实例的 OPS 能够达到 10W 左右。但也正因此如此，当我们在使用 Redis 时..."><meta property="og:type" content="article"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/image-20220627222146095.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-10-21T07:03:09.000Z"><meta property="article:author" content="MrJason"><meta property="article:modified_time" content="2024-10-21T07:03:09.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redis进阶 - 性能调优：Redis性能调优详解","image":["https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/image-20220627222146095.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019556.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019628.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019679.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019711.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019748.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019783.png","https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019818.png"],"dateModified":"2024-10-21T07:03:09.000Z","author":[{"@type":"Person","name":"MrJason","url":"https://mrjason.me"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" href="https://mrjason.me/rss.xml" title="mrjason’s Blog RSS Feed"><title>Redis进阶 - 性能调优：Redis性能调优详解 | mrjason’s Blog</title><meta name="description" content="Redis进阶 - 性能调优：Redis性能调优详解 Redis 的性能问题，涉及到的知识点非常广，几乎涵盖了 CPU、内存、网络、甚至磁盘的方方面面；同时还需要对上文中一些基础或底层有详细的了解。 1. 前言 Redis 作为优秀的内存数据库，其拥有非常高的性能，单个实例的 OPS 能够达到 10W 左右。但也正因此如此，当我们在使用 Redis 时...">
    <link rel="preload" href="/assets/style-BigB8Od8.css" as="style"><link rel="stylesheet" href="/assets/style-BigB8Od8.css">
    <link rel="modulepreload" href="/assets/app-BhoNqsD-.js"><link rel="modulepreload" href="/assets/db-redis-x-performance.html-Cu9KoiNK.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">mrjason’s Blog</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="主页"><!--[--><span class="font-icon icon iconfont icon-home" style=""></span><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/demo/" aria-label="导航"><!--[--><span class="font-icon icon iconfont icon-discover" style=""></span><!--]-->导航<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="笔记分类"><!--[--><span class="font-icon icon iconfont icon-edit" style=""></span>笔记分类<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">代码笔记</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Computer-Basics/" aria-label="计算机基础"><!--[--><span class="font-icon icon iconfont icon-windows" style=""></span><!--]-->计算机基础<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Data-Structure/" aria-label="数据结构与算法"><!--[--><span class="font-icon icon iconfont icon-calculate" style=""></span><!--]-->数据结构与算法<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Web/" aria-label="前端笔记"><!--[--><span class="font-icon icon iconfont icon-code" style=""></span><!--]-->前端笔记<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Linux/" aria-label="Linux"><!--[--><span class="font-icon icon iconfont icon-linux" style=""></span><!--]-->Linux<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Python/" aria-label="Python"><!--[--><span class="font-icon icon iconfont icon-python" style=""></span><!--]-->Python<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Database/" aria-label="数据库"><!--[--><span class="font-icon icon iconfont icon-table" style=""></span><!--]-->数据库<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Docker/" aria-label="Docker"><!--[--><span class="font-icon icon iconfont icon-expansion" style=""></span><!--]-->Docker<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/posts/Git/" aria-label="Git"><!--[--><span class="font-icon icon iconfont icon-git" style=""></span><!--]-->Git<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/posts/Redis/" aria-label="Redis"><!--[--><span class="font-icon icon iconfont icon-lock" style=""></span><!--]-->Redis<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">博客相关</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/blog/" aria-label="博客相关"><!--[--><span class="font-icon icon iconfont icon-blog" style=""></span><!--]-->博客相关<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/posts/Java/" aria-label="Java"><!--[--><span class="font-icon icon iconfont icon-java" style=""></span><!--]-->Java<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/collect.html" aria-label="收藏"><!--[--><span class="font-icon icon iconfont icon-hk-shoucang1" style=""></span><!--]-->收藏<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/news/" aria-label="说说"><!--[--><span class="font-icon icon iconfont icon-news" style=""></span><!--]-->说说<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/visitorsbook.html" aria-label="留言板"><!--[--><span class="font-icon icon iconfont icon-mark" style=""></span><!--]-->留言板<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/friend.html" aria-label="友链"><!--[--><span class="font-icon icon iconfont icon-link" style=""></span><!--]-->友链<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="关于"><!--[--><span class="font-icon icon iconfont icon-info" style=""></span>关于<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/intro.html" aria-label="关于我"><!--[--><span class="font-icon icon iconfont icon-people" style=""></span><!--]-->关于我<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="关于本站"><!--[--><span class="font-icon icon iconfont icon-info" style=""></span><!--]-->关于本站<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/MrjackC/mrjackc.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://foreverblog.cn/go.html" title="穿梭虫洞-随机访问十年之约友链博客" target="_blank" rel="noopener noreferrer" aria-label="wormhole"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor" style="width:1.25rem;height:1.25rem;vertical-align:middle"><path d="M644.608 665.6c192.512-171.008 342.016-395.776 254.464-494.592-27.648-31.232-66.56-45.568-108.032-41.472-34.816 3.584-70.656 20.992-107.008 50.176-116.224-59.904-254.464-55.296-366.592 11.776-86.016 51.2-148.48 134.656-172.544 231.936-18.944 74.24-14.336 152.064 12.8 223.744-44.544 50.688-86.528 154.624-34.816 212.992 21.504 24.576 52.736 35.328 90.112 35.328 114.176-0.512 286.72-100.864 431.616-229.888z m155.648-452.608c14.848-1.536 26.624 2.56 36.352 13.824 9.728 10.752 7.168 39.936-10.752 80.896-18.944-28.672-41.984-55.296-68.096-77.824 17.92-10.752 32.256-15.872 42.496-16.896z m-598.528 517.12c18.944 27.136 40.96 51.712 66.048 73.216-43.008 12.8-72.192 11.776-81.92 1.024-8.704-10.752 0.512-45.056 15.872-74.24z m685.568-246.784c-51.2 75.264-122.368 154.112-200.704 224.256-81.408 72.192-171.008 134.656-254.464 176.64 26.112 5.632 52.224 8.704 78.848 8.704 68.096 0 135.168-18.944 194.048-53.76 124.416-73.216 195.072-211.968 182.272-355.84z m0 0" p-id="4157"></path></svg></a></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://www.travellings.cn/go.html" title="开往" target="_blank" rel="noopener noreferrer" aria-label="travelling"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor" style="width:1.25rem;height:1.25rem;vertical-align:middle"><path d="M658.836 519.32c-22.121 0-40.145 18.431-40.145 40.957 0 22.528 18.023 40.962 40.145 40.962 22.117 0 40.141-18.434 40.141-40.962 0-22.526-18.024-40.957-40.141-40.957zM364.742 519.32c-22.121 0-40.141 18.431-40.141 40.957 0.41 22.528 18.02 40.962 40.141 40.962 22.117 0 40.141-18.434 40.141-40.962 0-22.526-18.024-40.957-40.141-40.957z" p-id="8700"></path><path d="M512 0C229.23 0 0 229.23 0 512s229.23 512 512 512 512-229.23 512-512S794.77 0 512 0z m133.727 804.81c0 7.375-6.145 13.52-13.516 13.52H391.773c-7.371 0-13.515-6.145-13.515-13.52v-13.516c0-7.371 6.144-13.517 13.515-13.517h240.438c7.371 0 13.516 6.146 13.516 13.517v13.516z m120.832 37.273c-12.289 6.965-27.441 2.867-34.406-9.418l-54.887-96.668c-4.504 0.82-9.422 1.23-13.926 1.23H361.054c-4.914 0-9.421-0.41-13.925-1.23l-54.887 96.668c-6.965 12.285-22.527 16.383-34.406 9.418-12.289-6.961-16.383-22.938-9.422-35.223l51.199-90.113c-27.031-19.66-43.418-52.43-40.957-88.883l19.25-293.273c3.277-49.152 34.406-88.066 87.246-88.066h80.281c0-37.684 29.899-67.993 66.762-67.993 36.868 0 66.766 30.309 66.766 67.993h93.391c53.246 0 70.449 38.914 73.727 88.066l19.25 293.273c2.461 36.453-13.926 69.223-40.957 88.883l51.199 90.113c6.964 12.696 2.867 28.262-9.012 35.223z" p-id="8701"></path><path d="M672.352 314.931H351.633c-14.747 0-26.622 12.285-26.622 27.441v108.953c0 15.157 11.875 27.446 26.622 27.446h320.719c14.746 0 26.625-12.289 26.625-27.446V342.372c0-15.156-11.879-27.441-26.625-27.441z" p-id="8702"></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-introduce.html" aria-label="Redis入门 - Redis概念和基础"><!---->Redis入门 - Redis概念和基础<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-data-types.html" aria-label="Redis入门 - 数据类型：5种基础数据类型详解"><!---->Redis入门 - 数据类型：5种基础数据类型详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-data-type-special.html" aria-label="Redis入门 - 3种特殊类型详解"><!---->Redis入门 - 3种特殊类型详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-data-type-stream.html" aria-label="Redis进阶 - 数据类型：Stream详解"><!---->Redis进阶 - 数据类型：Stream详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-redis-object.html" aria-label="Redis进阶 - 数据类型：对象机制详解"><!---->Redis进阶 - 数据类型：对象机制详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-rdb-aof.html" aria-label="Redis进阶 - 持久化：RDB和AOF机制详解"><!---->Redis进阶 - 持久化：RDB和AOF机制详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-pub-sub.html" aria-label="Redis进阶 - 消息传递：发布订阅模式详解"><!---->Redis进阶 - 消息传递：发布订阅模式详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-event.html" aria-label="Redis进阶 - 事件：Redis事件机制详解"><!---->Redis进阶 - 事件：Redis事件机制详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-trans.html" aria-label="Redis进阶 - 事务：Redis事务详解"><!---->Redis进阶 - 事务：Redis事务详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-copy.html" aria-label="Redis进阶 - 高可用：主从复制详解"><!---->Redis进阶 - 高可用：主从复制详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-y-install-sentinel.html" aria-label="Redis进阶 - 高可用：哨兵机制（Redis Sentinel）详解"><!---->Redis进阶 - 高可用：哨兵机制（Redis Sentinel）详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-cluster.html" aria-label="Redis进阶 - 高可拓展：分片技术（Redis Cluster）详解"><!---->Redis进阶 - 高可拓展：分片技术（Redis Cluster）详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-consistency.html" aria-label="Redis进阶 - 如何保障MySQL和Redis的数据一致性？"><!---->Redis进阶 - 如何保障MySQL和Redis的数据一致性？<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-cache.html" aria-label="Redis进阶 -  Redis缓存问题：一致性, 穿击, 穿透, 雪崩, 污染等"><!---->Redis进阶 -  Redis缓存问题：一致性, 穿击, 穿透, 雪崩, 污染等<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-x-hot-key.html" aria-label="Redis进阶 - Redis热key问题"><!---->Redis进阶 - Redis热key问题<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/posts/Redis/db-redis-x-performance.html" aria-label="Redis进阶 - 性能调优：Redis性能调优详解"><!---->Redis进阶 - 性能调优：Redis性能调优详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-overview.html" aria-label="Redis面试 - redis问题总结"><!---->Redis面试 - redis问题总结<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-overview-detail.html" aria-label="Redis面试 - redis问题总结(答案版)"><!---->Redis面试 - redis问题总结(答案版)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-basic.html" aria-label="Redis面试 - 常规问题"><!---->Redis面试 - 常规问题<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-datatype.html" aria-label="Redis面试 - 数据类型和数据结构"><!---->Redis面试 - 数据类型和数据结构<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-persistence.html" aria-label="Redis面试 - 持久化和内存"><!---->Redis面试 - 持久化和内存<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-tran.html" aria-label="Redis面试 - 事务"><!---->Redis面试 - 事务<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-master-salve.html" aria-label="Redis面试 - 集群-主从复制"><!---->Redis面试 - 集群-主从复制<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-sentinel.html" aria-label="Redis面试 - 集群-哨兵机制"><!---->Redis面试 - 集群-哨兵机制<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-apply.html" aria-label="Redis面试 - 应用场景"><!---->Redis面试 - 应用场景<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-cluster.html" aria-label="Redis面试 - 集群-分片技术"><!---->Redis面试 - 集群-分片技术<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-new.html" aria-label="Redis面试 - 新版本"><!---->Redis面试 - 新版本<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-z-interview-other.html" aria-label="Redis面试 -  其他特性"><!---->Redis面试 -  其他特性<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-question-double-write.html" aria-label="Redis保证缓存与数据库双写时的数据一致性"><!---->Redis保证缓存与数据库双写时的数据一致性<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-y-install.html" aria-label="Redis安装"><!---->Redis安装<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-y-action-bloom.html" aria-label="Redis布隆过滤器"><!---->Redis布隆过滤器<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-cache-penetration.html" aria-label="Redis缓存穿透"><!---->Redis缓存穿透<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-question-ache-valanche.html" aria-label="Redis缓存雪崩"><!---->Redis缓存雪崩<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-questuin-cache-warm-up.html" aria-label="Redis缓存预热"><!---->Redis缓存预热<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-y-action-client.html" aria-label="redis连接客户端选择：Jedis,Redisson,Lettuce"><!---->redis连接客户端选择：Jedis,Redisson,Lettuce<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-hash.html" aria-label="Redis集群：hash寻址算法"><!---->Redis集群：hash寻址算法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-sentinel-install.html" aria-label="Redis集群搭建详解"><!---->Redis集群搭建详解<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-y-action-springboot.html" aria-label="Spring Boot集成redis使用"><!---->Spring Boot集成redis使用<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-y-action.html" aria-label="SpringBoot集成redis项目范例"><!---->SpringBoot集成redis项目范例<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-x-quest-key.html" aria-label="如何解决 Redis 的并发竞争 Key 问题"><!---->如何解决 Redis 的并发竞争 Key 问题<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/db-redis-y-install-remote.html" aria-label="开启远程访问"><!---->开启远程访问<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/redis-y-action-gen-test-data.html" aria-label="批量生成redis测试数据方法"><!---->批量生成redis测试数据方法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/%E7%AC%AC%E4%B8%80%E7%AB%A0%20Redis%E5%9F%BA%E7%A1%80.html" aria-label="第一章 Redis基础"><!---->第一章 Redis基础<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/posts/Redis/%E7%AC%AC%E4%BA%8C%E7%AB%A0%20Redis%E9%AB%98%E7%BA%A7.html" aria-label="第二章：Redis高级"><!---->第二章：Redis高级<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Redis进阶 - 性能调优：Redis性能调优详解</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://mrjason.me" target="_blank" rel="noopener noreferrer">MrJason</a></span><span property="author" content="MrJason"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-21T07:03:09.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon" name="eye"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/posts/Redis/db-redis-x-performance.html" data-page-key="/posts/Redis/db-redis-x-performance.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 41 分钟</span><meta property="timeRequired" content="PT41M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color7 clickable" role="navigation">数据库</span><span class="page-category-item color3 clickable" role="navigation">Redis</span><!--]--><meta property="articleSection" content="数据库,Redis"></span><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-前言">1. 前言</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-redis真的变慢了吗">2. Redis真的变慢了吗？</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-1-什么是基准性能">2.1 什么是基准性能？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-2-具体如何做">2.2 具体如何做？</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-使用复杂度过高的命令">3. 使用复杂度过高的命令</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-操作bigkey">4. 操作bigkey</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-1-查看bigkey-的分布情况">4.1 查看bigkey 的分布情况</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-2-解决方案">4.2 解决方案</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-集中过期">5. 集中过期</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-1-为什么集中过期会导致-redis-延迟变大">5.1 为什么集中过期会导致 Redis 延迟变大？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-那遇到这种情况-如何分析和排查">5.2 那遇到这种情况，如何分析和排查？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-规避问题">5.3 规避问题</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-实例内存达到上限">6. 实例内存达到上限</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_6-1-问题原因">6.1 问题原因</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_6-2-解决">6.2 解决</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-fork耗时严重">7. fork耗时严重</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-1-优化方案">7.1 优化方案</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8-开启内存大页">8. 开启内存大页</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-1-什么是内存大页">8.1 什么是内存大页？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-2-这对-redis-会有什么影响呢">8.2 这对 Redis 会有什么影响呢？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-3-那如何解决这个问题">8.3 那如何解决这个问题？</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-开启aof">9. 开启AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_10-绑定cpu">10. 绑定CPU</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_10-1-为什么">10.1 为什么？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_10-2-那如何解决这个问题呢">10.2 那如何解决这个问题呢？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_10-3-如何再进一步优化">10.3 如何再进一步优化？</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_11-使用swap">11. 使用Swap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_12-碎片整理">12. 碎片整理</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_13-网络带宽过载">13. 网络带宽过载</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_14-其他原因">14. 其他原因</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_15-总结">15. 总结</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_16-后记">16. 后记</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#参考文章">参考文章</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="redis进阶-性能调优-redis性能调优详解" tabindex="-1"><a class="header-anchor" href="#redis进阶-性能调优-redis性能调优详解"><span>Redis进阶 - 性能调优：Redis性能调优详解</span></a></h1><blockquote><p>Redis 的性能问题，涉及到的知识点非常广，几乎涵盖了 CPU、内存、网络、甚至磁盘的方方面面；同时还需要对上文中一些基础或底层有详细的了解。</p></blockquote><h2 id="_1-前言" tabindex="-1"><a class="header-anchor" href="#_1-前言"><span>1. 前言</span></a></h2><blockquote><p>Redis 作为优秀的内存数据库，其拥有非常高的性能，单个实例的 OPS 能够达到 10W 左右。但也正因此如此，当我们在使用 Redis 时，如果发现操作延迟变大的情况，就会与我们的预期不符。</p></blockquote><p>你也许或多或少地，也遇到过以下这些场景：</p><ul><li>在 Redis 上执行同样的命令，为什么有时响应很快，有时却很慢？</li><li>为什么 Redis 执行 SET、DEL 命令耗时也很久？</li><li>为什么我的 Redis 突然慢了一波，之后又恢复正常了？</li><li>为什么我的 Redis 稳定运行了很久，突然从某个时间点开始变慢了？</li><li>...</li></ul><p>如果你并不清楚 Redis 内部的实现原理，那么在排查这种延迟问题时就会一头雾水。</p><p>如果你也遇到了以上情况，那么，这篇文章将会给你一个「全面」的问题排查思路，并且针对这些导致变慢的场景，我还会给你一个高效的解决方案。</p><h2 id="_2-redis真的变慢了吗" tabindex="-1"><a class="header-anchor" href="#_2-redis真的变慢了吗"><span>2. Redis真的变慢了吗？</span></a></h2><blockquote><p>首先，在开始之前，你需要弄清楚 Redis 是否真的变慢了？</p></blockquote><p>如果你发现你的业务服务 API 响应延迟变长，首先你需要先排查服务内部，究竟是哪个环节拖慢了整个服务。</p><p>比较高效的做法是，在服务内部集成链路追踪，也就是在服务访问外部依赖的出入口，记录下每次请求外部依赖的响应延时。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/image-20220627222146095.png" alt="image-20220627222146095" tabindex="0" loading="lazy"><figcaption>image-20220627222146095</figcaption></figure><p>如果你发现确实是操作 Redis 的这条链路耗时变长了，那么此刻你需要把焦点关注在业务服务到 Redis 这条链路上。</p><p>从你的业务服务到 Redis 这条链路变慢的原因可能也有 2 个：</p><ul><li>业务服务器到 Redis 服务器之间的网络存在问题，例如网络线路质量不佳，网络数据包在传输时存在延迟、丢包等情况</li><li>Redis 本身存在问题，需要进一步排查是什么原因导致 Redis 变慢</li></ul><p>通常来说，第一种情况发生的概率比较小，如果是服务器之间网络存在问题，那部署在这台业务服务器上的所有服务都会发生网络延迟的情况，此时你需要联系网络运维同事，让其协助解决网络问题。</p><p>我们这篇文章，重点关注的是第二种情况。</p><p>也就是从 Redis 角度来排查，是否存在导致变慢的场景，以及都有哪些因素会导致 Redis 的延迟增加，然后针对性地进行优化。</p><p>排除网络原因，如何确认你的 Redis 是否真的变慢了？</p><p>首先，你需要对 Redis 进行基准性能测试，了解你的 Redis 在生产环境服务器上的基准性能。</p><h3 id="_2-1-什么是基准性能" tabindex="-1"><a class="header-anchor" href="#_2-1-什么是基准性能"><span>2.1 <strong>什么是基准性能</strong>？</span></a></h3><p>简单来讲，基准性能就是指 Redis 在一台负载正常的机器上，其最大的响应延迟和平均响应延迟分别是怎样的？</p><p>为什么要测试基准性能？我参考别人提供的响应延迟，判断自己的 Redis 是否变慢不行吗？</p><p>答案是否定的。</p><p>因为 Redis 在不同的软硬件环境下，它的性能是各不相同的。</p><p>例如，我的机器配置比较低，当延迟为 2ms 时，我就认为 Redis 变慢了，但是如果你的硬件配置比较高，那么在你的运行环境下，可能延迟是 0.5ms 时就可以认为 Redis 变慢了。</p><p>所以，你只有了解了你的 Redis 在生产环境服务器上的基准性能，才能进一步评估，当其延迟达到什么程度时，才认为 Redis 确实变慢了。</p><h3 id="_2-2-具体如何做" tabindex="-1"><a class="header-anchor" href="#_2-2-具体如何做"><span>2.2 <strong>具体如何做</strong>？</span></a></h3><p>为了避免业务服务器到 Redis 服务器之间的网络延迟，你需要直接在 Redis 服务器上测试实例的响应延迟情况。执行以下命令，就可以测试出这个实例 60 秒内的最大响应延迟：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-cli</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -h</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 6379</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --intrinsic-latency</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 60</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 15</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 17</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 18</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 31</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 32</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 59</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Max</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency</span><span style="color:#98C379;--shiki-dark:#98C379;"> so</span><span style="color:#98C379;--shiki-dark:#98C379;"> far:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 72</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds.</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">1428669267</span><span style="color:#98C379;--shiki-dark:#98C379;"> total</span><span style="color:#98C379;--shiki-dark:#98C379;"> runs</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (avg </span><span style="color:#98C379;--shiki-dark:#98C379;">latency:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.0420</span><span style="color:#98C379;--shiki-dark:#98C379;"> microseconds</span><span style="color:#98C379;--shiki-dark:#98C379;"> /</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 42.00</span><span style="color:#98C379;--shiki-dark:#98C379;"> nanoseconds</span><span style="color:#98C379;--shiki-dark:#98C379;"> per</span><span style="color:#98C379;--shiki-dark:#98C379;"> run</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">).</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Worst</span><span style="color:#98C379;--shiki-dark:#98C379;"> run</span><span style="color:#98C379;--shiki-dark:#98C379;"> took</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1429x</span><span style="color:#98C379;--shiki-dark:#98C379;"> longer</span><span style="color:#98C379;--shiki-dark:#98C379;"> than</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> average</span><span style="color:#98C379;--shiki-dark:#98C379;"> latency.</span></span></code></pre></div><p>从输出结果可以看到，这 60 秒内的最大响应延迟为 72 微秒（0.072毫秒）。</p><p>你还可以使用以下命令，查看一段时间内 Redis 的最小、最大、平均访问延迟：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-cli</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -h</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 6379</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --latency-history</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -i</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.13</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (100 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.01 seconds range</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.12</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (99 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.01 seconds range</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.13</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (99 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.01 seconds range</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (99 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.01 seconds range</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.13</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (98 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.00 seconds range</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">min:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0,</span><span style="color:#98C379;--shiki-dark:#98C379;"> max:</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.08</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (99 </span><span style="color:#98C379;--shiki-dark:#98C379;">samples</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) -- 1.01 seconds range</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">...</span></span></code></pre></div><p>以上输出结果是，每间隔 1 秒，采样 Redis 的平均操作耗时，其结果分布在 0.08 ~ 0.13 毫秒之间。</p><p>了解了基准性能测试方法，那么你就可以按照以下几步，来判断你的 Redis 是否真的变慢了：</p><ul><li>在相同配置的服务器上，测试一个正常 Redis 实例的基准性能</li><li>找到你认为可能变慢的 Redis 实例，测试这个实例的基准性能</li><li>如果你观察到，这个实例的运行延迟是正常 Redis 基准性能的 2 倍以上，即可认为这个 Redis 实例确实变慢了</li></ul><p>确认是 Redis 变慢了，那如何排查是哪里发生了问题呢？</p><p>下面跟着我的思路，我们从易到难，一步步来分析可能导致 Redis 变慢的因素。</p><h2 id="_3-使用复杂度过高的命令" tabindex="-1"><a class="header-anchor" href="#_3-使用复杂度过高的命令"><span>3. 使用复杂度过高的命令</span></a></h2><blockquote><p>首先，第一步，你需要去查看一下 Redis 的慢日志（slowlog）。</p></blockquote><p>Redis 提供了慢日志命令的统计功能，它记录了有哪些命令在执行时耗时比较久。</p><p>查看 Redis 慢日志之前，你需要设置慢日志的阈值。例如，设置慢日志的阈值为 5 毫秒，并且保留最近 500 条慢日志记录：</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"># 命令执行耗时超过 </span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 毫秒，记录慢日志</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">CONFIG </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SET</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> slowlog-</span><span style="color:#C678DD;--shiki-dark:#C678DD;">log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-slower-than </span><span style="color:#D19A66;--shiki-dark:#D19A66;">5000</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"># 只保留最近 </span><span style="color:#D19A66;--shiki-dark:#D19A66;">500</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 条慢日志</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">CONFIG </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SET</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> slowlog-max-len </span><span style="color:#D19A66;--shiki-dark:#D19A66;">500</span></span></code></pre></div><p>设置完成之后，所有执行的命令如果操作耗时超过了 5 毫秒，都会被 Redis 记录下来。</p><p>此时，你可以执行以下命令，就可以查询到最近记录的慢日志：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">127.0.0.1:6379</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">SLOWLOG</span><span style="color:#98C379;--shiki-dark:#98C379;"> get</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 5</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 32693       </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 慢日志ID</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1593763337  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 执行时间戳</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 5299        </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 执行耗时(微秒)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;LRANGE&quot;</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           # 具体执行的命令和参数</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;user_list:2000&quot;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;0&quot;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;-1&quot;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 32692</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1593763337</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) (</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">integer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 5044</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) 1) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;GET&quot;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;user_info:1000&quot;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">...</span></span></code></pre></div><p>通过查看慢日志，我们就可以知道在什么时间点，执行了哪些命令比较耗时。</p><p>如果你的应用程序执行的 Redis 命令有以下特点，那么有可能会导致操作延迟变大：</p><ul><li><strong>经常使用 O(N) 以上复杂度的命令，例如 SORT、SUNION、ZUNIONSTORE 聚合类命令</strong></li><li>使用 O(N) 复杂度的命令，但 N 的值非常大</li></ul><p><strong>第一种情况导致变慢的原因在于，Redis 在操作内存数据时，时间复杂度过高，要花费更多的 CPU 资源。</strong></p><p><strong>第二种情况导致变慢的原因在于，Redis 一次需要返回给客户端的数据过多，更多时间花费在数据协议的组装和网络传输过程中。</strong></p><p>另外，我们还可以从资源使用率层面来分析，如果你的应用程序操作 Redis 的 OPS 不是很大，但 Redis 实例的 CPU 使用率却很高，那么很有可能是使用了复杂度过高的命令导致的。</p><p>除此之外，我们都知道，Redis 是单线程处理客户端请求的，如果你经常使用以上命令，那么当 Redis 处理客户端请求时，一旦前面某个命令发生耗时，就会导致后面的请求发生排队，对于客户端来说，响应延迟也会变长。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019556.png" alt="image-20220627223154759" tabindex="0" loading="lazy"><figcaption>image-20220627223154759</figcaption></figure><p>针对这种情况如何解决呢？</p><p>答案很简单，你可以使用以下方法优化你的业务：</p><ul><li>尽量不使用 O(N) 以上复杂度过高的命令，对于数据的聚合操作，放在客户端做</li><li>执行 O(N) 命令，保证 N 尽量的小（推荐 N &lt;= 300），每次获取尽量少的数据，让 Redis 可以及时处理返回</li></ul><h2 id="_4-操作bigkey" tabindex="-1"><a class="header-anchor" href="#_4-操作bigkey"><span>4. 操作bigkey</span></a></h2><blockquote><p>如果你查询慢日志发现，并不是复杂度过高的命令导致的，而都是 SET / DEL 这种简单命令出现在慢日志中，那么你就要怀疑你的实例否写入了 bigkey。</p></blockquote><p>Redis 在写入数据时，需要为新的数据分配内存，相对应的，当从 Redis 中删除数据时，它会释放对应的内存空间。</p><p><strong>如果一个 key 写入的 value 非常大，那么 Redis 在分配内存时就会比较耗时</strong>。同样的，当删除这个 key 时，释放内存也会比较耗时，这种类型的 key 我们一般称之为 bigkey。</p><p>此时，你需要检查你的业务代码，是否存在写入 bigkey 的情况。你需要评估写入一个 key 的数据大小，尽量避免一个 key 存入过大的数据。</p><h3 id="_4-1-查看bigkey-的分布情况" tabindex="-1"><a class="header-anchor" href="#_4-1-查看bigkey-的分布情况"><span>4.1 查看bigkey 的分布情况</span></a></h3><p><strong>如果已经写入了 bigkey，那有没有什么办法可以扫描出实例中 bigkey 的分布情况呢</strong>？</p><p>答案是可以的。</p><p>Redis 提供了扫描 bigkey 的命令，执行以下命令就可以扫描出，一个实例中 bigkey 的分布情况，输出结果是以类型维度展示的：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-cli</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -h</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 127.0.0.1</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 6379</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --bigkeys</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -i</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.01</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">--------</span><span style="color:#98C379;--shiki-dark:#98C379;"> summary</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -------</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Sampled</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 829675</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys</span><span style="color:#98C379;--shiki-dark:#98C379;"> in</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> keyspace!</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Total</span><span style="color:#98C379;--shiki-dark:#98C379;"> key</span><span style="color:#98C379;--shiki-dark:#98C379;"> length</span><span style="color:#98C379;--shiki-dark:#98C379;"> in</span><span style="color:#98C379;--shiki-dark:#98C379;"> bytes</span><span style="color:#98C379;--shiki-dark:#98C379;"> is</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10059825</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (avg </span><span style="color:#98C379;--shiki-dark:#98C379;">len</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 12.13</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Biggest</span><span style="color:#98C379;--shiki-dark:#98C379;"> string</span><span style="color:#98C379;--shiki-dark:#98C379;"> found</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;key:291880&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> has</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#98C379;--shiki-dark:#98C379;"> bytes</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Biggest</span><span style="color:#98C379;--shiki-dark:#98C379;">   list</span><span style="color:#98C379;--shiki-dark:#98C379;"> found</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;mylist:004&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> has</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 40</span><span style="color:#98C379;--shiki-dark:#98C379;"> items</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Biggest</span><span style="color:#98C379;--shiki-dark:#98C379;">    set</span><span style="color:#98C379;--shiki-dark:#98C379;"> found</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;myset:2386&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> has</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 38</span><span style="color:#98C379;--shiki-dark:#98C379;"> members</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Biggest</span><span style="color:#98C379;--shiki-dark:#98C379;">   hash</span><span style="color:#98C379;--shiki-dark:#98C379;"> found</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;myhash:3574&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> has</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 37</span><span style="color:#98C379;--shiki-dark:#98C379;"> fields</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Biggest</span><span style="color:#98C379;--shiki-dark:#98C379;">   zset</span><span style="color:#98C379;--shiki-dark:#98C379;"> found</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;myzset:2704&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> has</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 42</span><span style="color:#98C379;--shiki-dark:#98C379;"> members</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">36313</span><span style="color:#98C379;--shiki-dark:#98C379;"> strings</span><span style="color:#98C379;--shiki-dark:#98C379;"> with</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 363130</span><span style="color:#98C379;--shiki-dark:#98C379;"> bytes</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (04.38% </span><span style="color:#98C379;--shiki-dark:#98C379;">of</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg</span><span style="color:#98C379;--shiki-dark:#98C379;"> size</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10.00</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">787393</span><span style="color:#98C379;--shiki-dark:#98C379;"> lists</span><span style="color:#98C379;--shiki-dark:#98C379;"> with</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 896540</span><span style="color:#98C379;--shiki-dark:#98C379;"> items</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (94.90% </span><span style="color:#98C379;--shiki-dark:#98C379;">of</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg</span><span style="color:#98C379;--shiki-dark:#98C379;"> size</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1.14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">1994</span><span style="color:#98C379;--shiki-dark:#98C379;"> sets</span><span style="color:#98C379;--shiki-dark:#98C379;"> with</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 40052</span><span style="color:#98C379;--shiki-dark:#98C379;"> members</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (00.24% </span><span style="color:#98C379;--shiki-dark:#98C379;">of</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg</span><span style="color:#98C379;--shiki-dark:#98C379;"> size</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 20.09</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">1990</span><span style="color:#98C379;--shiki-dark:#98C379;"> hashs</span><span style="color:#98C379;--shiki-dark:#98C379;"> with</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 39632</span><span style="color:#98C379;--shiki-dark:#98C379;"> fields</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (00.24% </span><span style="color:#98C379;--shiki-dark:#98C379;">of</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg</span><span style="color:#98C379;--shiki-dark:#98C379;"> size</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 19.92</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">1985</span><span style="color:#98C379;--shiki-dark:#98C379;"> zsets</span><span style="color:#98C379;--shiki-dark:#98C379;"> with</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 39750</span><span style="color:#98C379;--shiki-dark:#98C379;"> members</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (00.24% </span><span style="color:#98C379;--shiki-dark:#98C379;">of</span><span style="color:#98C379;--shiki-dark:#98C379;"> keys,</span><span style="color:#98C379;--shiki-dark:#98C379;"> avg</span><span style="color:#98C379;--shiki-dark:#98C379;"> size</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 20.03</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果提示 Couldn&#39;t determine DBSIZE!，则需要输入密码</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis-cli</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -h</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 192.168.1.1</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 6379</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -a</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;123&quot;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --bigkeys</span></span></code></pre></div><p>从输出结果我们可以很清晰地看到，每种数据类型所占用的最大内存 / 拥有最多元素的 key 是哪一个，以及每种数据类型在整个实例中的占比和平均大小 / 元素数量。</p><p>其实，使用这个命令的原理，就是 Redis 在内部执行了 SCAN 命令，遍历整个实例中所有的 key，然后针对 key 的类型，分别执行 STRLEN、LLEN、HLEN、SCARD、ZCARD 命令，来获取 String 类型的长度、容器类型（List、Hash、Set、ZSet）的元素个数。</p><p>这里我需要提醒你的是，当执行这个命令时，要注意 2 个问题：</p><ul><li>对线上实例进行 bigkey 扫描时，Redis 的 OPS 会突增，为了降低扫描过程中对 Redis 的影响，最好控制一下扫描的频率，指定 -i 参数即可，它表示扫描过程中每次扫描后休息的时间间隔，单位是秒</li><li>扫描结果中，对于容器类型（List、Hash、Set、ZSet）的 key，只能扫描出元素最多的 key。但一个 key 的元素多，不一定表示占用内存也多，你还需要根据业务情况，进一步评估内存占用情况</li></ul><h3 id="_4-2-解决方案" tabindex="-1"><a class="header-anchor" href="#_4-2-解决方案"><span>4.2 解决方案</span></a></h3><p><strong>那针对 bigkey 导致延迟的问题，有什么好的解决方案呢</strong>？</p><p>这里有两点可以优化：</p><ul><li>业务应用尽量避免写入 bigkey</li><li>如果你使用的 Redis 是 4.0 以上版本，用 UNLINK 命令替代 DEL，此命令可以把释放 key 内存的操作，放到后台线程中去执行，从而降低对 Redis 的影响</li><li>如果你使用的 Redis 是 6.0 以上版本，可以开启 lazy-free 机制（lazyfree-lazy-user-del = yes），在执行 DEL 命令时，释放内存也会放到后台线程中执行</li></ul><p>但即便可以使用方案 2，我也不建议你在实例中存入 bigkey。</p><p>这是因为 bigkey 在很多场景下，依旧会产生性能问题。例如，bigkey 在分片集群模式下，对于数据的迁移也会有性能影响，以及我后面即将讲到的数据过期、数据淘汰、透明大页，都会受到 bigkey 的影响。</p><h2 id="_5-集中过期" tabindex="-1"><a class="header-anchor" href="#_5-集中过期"><span>5. 集中过期</span></a></h2><blockquote><p>如果你发现，平时在操作 Redis 时，并没有延迟很大的情况发生，但在某个时间点突然出现一波延时，其现象表现为：<strong>变慢的时间点很有规律，例如某个整点，或者每间隔多久就会发生一波延迟</strong>。如果是出现这种情况，那么你需要排查一下，业务代码中是否存在设置大量 key 集中过期的情况。</p></blockquote><p>如果有大量的 key 在某个固定时间点集中过期，在这个时间点访问 Redis 时，就有可能导致延时变大。</p><h3 id="_5-1-为什么集中过期会导致-redis-延迟变大" tabindex="-1"><a class="header-anchor" href="#_5-1-为什么集中过期会导致-redis-延迟变大"><span>5.1 <strong>为什么集中过期会导致 Redis 延迟变大</strong>？</span></a></h3><p>这就需要我们了解 Redis 的过期策略是怎样的。</p><p>Redis 的过期数据采用被动过期 + 主动过期两种策略：</p><ul><li><strong>被动过期</strong>：只有当访问某个 key 时，才判断这个 key 是否已过期，如果已过期，则从实例中删除</li><li><strong>主动过期</strong>：Redis 内部维护了一个定时任务，默认每隔 100 毫秒（1秒10次）就会从全局的过期哈希表中随机取出 20 个 key，然后删除其中过期的 key，如果过期 key 的比例超过了 25%，则继续重复此过程，直到过期 key 的比例下降到 25% 以下，或者这次任务的执行耗时超过了 25 毫秒，才会退出循环</li></ul><p>注意，<strong>这个主动过期 key 的定时任务，是在 Redis 主线程中执行的</strong>。</p><p>也就是说如果在执行主动过期的过程中，出现了需要大量删除过期 key 的情况，那么此时应用程序在访问 Redis 时，必须要等待这个过期任务执行结束，Redis 才可以服务这个客户端请求。</p><p>此时就会出现，应用访问 Redis 延时变大。</p><p>如果此时需要过期删除的是一个 bigkey，那么这个耗时会更久。而且，这个操作延迟的命令并不会记录在慢日志中。</p><p>因为慢日志中只记录一个命令真正操作内存数据的耗时，而 Redis 主动删除过期 key 的逻辑，是在命令真正执行之前执行的。</p><p>所以，此时你会看到，<strong>慢日志中没有操作耗时的命令，但我们的应用程序却感知到了延迟变大，其实时间都花费在了删除过期 key 上</strong>，这种情况我们需要尤为注意。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019628.png" alt="image-20220627224145071" tabindex="0" loading="lazy"><figcaption>image-20220627224145071</figcaption></figure><h3 id="_5-2-那遇到这种情况-如何分析和排查" tabindex="-1"><a class="header-anchor" href="#_5-2-那遇到这种情况-如何分析和排查"><span>5.2 <strong>那遇到这种情况，如何分析和排查</strong>？</span></a></h3><p>此时，你需要检查你的业务代码，是否存在集中过期 key 的逻辑。</p><p>一般集中过期使用的是 expireat / pexpireat 命令，你需要在代码中搜索这个关键字。</p><p>排查代码后，如果确实存在集中过期 key 的逻辑存在，但这种逻辑又是业务所必须的，那此时如何优化，同时又不对 Redis 有性能影响呢？</p><h3 id="_5-3-规避问题" tabindex="-1"><a class="header-anchor" href="#_5-3-规避问题"><span>5.3 规避问题</span></a></h3><p>一般有两种方案来规避这个问题：</p><ul><li>集中过期 key 增加一个随机过期时间，把集中过期的时间打散，降低 Redis 清理过期 key 的压力</li><li>如果你使用的 Redis 是 4.0 以上版本，可以开启 lazy-free 机制，当删除过期 key 时，把释放内存的操作放到后台线程中执行，避免阻塞主线程</li></ul><p>第一种方案，在设置 key 的过期时间时，增加一个随机时间，伪代码可以这么写：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 在过期时间点之后的 5 分钟内随机过期掉</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis.expireat(key,</span><span style="color:#98C379;--shiki-dark:#98C379;"> expire_time</span><span style="color:#98C379;--shiki-dark:#98C379;"> +</span><span style="color:#98C379;--shiki-dark:#98C379;"> random</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">300</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span></code></pre></div><p>这样一来，Redis 在处理过期时，不会因为集中删除过多的 key 导致压力过大，从而避免阻塞主线程。</p><p>第二种方案，Redis 4.0 以上版本，开启 lazy-free 机制：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 释放过期 key 的内存，放到后台线程执行</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">lazyfree-lazy-expire</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span></code></pre></div><p>另外，除了业务层面的优化和修改配置之外，你还可以通过运维手段及时发现这种情况。</p><p>运维层面，你需要把 Redis 的各项运行状态数据监控起来，在 Redis 上执行 INFO 命令就可以拿到这个实例所有的运行状态数据。</p><p>在这里我们需要重点关注 expired_keys 这一项，它代表整个实例到目前为止，累计删除过期 key 的数量。</p><p>你需要把这个指标监控起来，<strong>当这个指标在很短时间内出现了突增，需要及时报警出来</strong>，然后与业务应用报慢的时间点进行对比分析，确认时间是否一致，如果一致，则可以确认确实是因为集中过期 key 导致的延迟变大。</p><h2 id="_6-实例内存达到上限" tabindex="-1"><a class="header-anchor" href="#_6-实例内存达到上限"><span>6. 实例内存达到上限</span></a></h2><blockquote><p>如果你的 Redis 实例设置了内存上限 maxmemory，那么也有可能导致 Redis 变慢。</p></blockquote><p>当我们把 Redis 当做纯缓存使用时，通常会给这个实例设置一个内存上限 maxmemory，然后设置一个数据淘汰策略。</p><p>而当实例的内存达到了 maxmemory 后，你可能会发现，在此之后每次写入新数据，操作延迟变大了。</p><p>这是为什么？</p><h3 id="_6-1-问题原因" tabindex="-1"><a class="header-anchor" href="#_6-1-问题原因"><span>6.1 问题原因</span></a></h3><p>原因在于，当 Redis 内存达到 maxmemory 后，每次写入新的数据之前，<strong>Redis 必须先从实例中踢出一部分数据，让整个实例的内存维持在 maxmemory 之下，然后才能把新数据写进来</strong>。</p><p>这个踢出旧数据的逻辑也是需要消耗时间的，而具体耗时的长短，要取决于你配置的淘汰策略：</p><ul><li><code>allkeys-lru</code>：不管 key 是否设置了过期，淘汰最近最少访问的 key</li><li><code>volatile-lru</code>：只淘汰最近最少访问、并设置了过期时间的 key</li><li><code>allkeys-random</code>：不管 key 是否设置了过期，随机淘汰 key</li><li><code>volatile-random</code>：只随机淘汰设置了过期时间的 key</li><li><code>allkeys-ttl</code>：不管 key 是否设置了过期，淘汰即将过期的 key</li><li><code>noeviction</code>：不淘汰任何 key，实例内存达到 maxmeory 后，再写入新数据直接返回错误</li><li><code>allkeys-lfu</code>：不管 key 是否设置了过期，淘汰访问频率最低的 key（4.0+版本支持）</li><li><code>volatile-lfu</code>：只淘汰访问频率最低、并设置了过期时间 key（4.0+版本支持）</li></ul><p>具体使用哪种策略，我们需要根据具体的业务场景来配置。</p><p>一般最常使用的是 allkeys-lru / volatile-lru 淘汰策略，它们的处理逻辑是，每次从实例中随机取出一批 key（这个数量可配置），然后淘汰一个最少访问的 key，之后把剩下的 key 暂存到一个池子中，继续随机取一批 key，并与之前池子中的 key 比较，再淘汰一个最少访问的 key。以此往复，直到实例内存降到 maxmemory 之下。</p><p>需要注意的是，Redis 的淘汰数据的逻辑与删除过期 key 的一样，也是在命令真正执行之前执行的，也就是说它也会增加我们操作 Redis 的延迟，而且，写 OPS 越高，延迟也会越明显。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019679.png" alt="image-20220627224651167" tabindex="0" loading="lazy"><figcaption>image-20220627224651167</figcaption></figure><p>另外，如果此时你的 Redis 实例中还存储了 bigkey，那么在淘汰删除 bigkey 释放内存时，也会耗时比较久。</p><p>看到了么？bigkey 的危害到处都是，这也是前面我提醒你尽量不存储 bigkey 的原因。</p><h3 id="_6-2-解决" tabindex="-1"><a class="header-anchor" href="#_6-2-解决"><span>6.2 解决</span></a></h3><p><strong>针对这种情况，如何解决呢</strong>？</p><p>我给你 4 个方面的优化建议：</p><ul><li>避免存储 bigkey，降低释放内存的耗时</li><li>淘汰策略改为随机淘汰，随机淘汰比 LRU 要快很多（视业务情况调整）</li><li>拆分实例，把淘汰 key 的压力分摊到多个实例上</li><li>如果使用的是 Redis 4.0 以上版本，开启 layz-free 机制，把淘汰 key 释放内存的操作放到后台线程中执行（配置 lazyfree-lazy-eviction = yes）</li></ul><h2 id="_7-fork耗时严重" tabindex="-1"><a class="header-anchor" href="#_7-fork耗时严重"><span>7. fork耗时严重</span></a></h2><blockquote><p>为了保证 Redis 数据的安全性，我们可能会开启后台定时 RDB 和 AOF rewrite 功能。但如果你发现，操作 Redis 延迟变大，都发生在 Redis 后台 RDB 和 AOF rewrite 期间，那你就需要排查，在这期间有可能导致变慢的情况。</p></blockquote><p>当 Redis 开启了后台 RDB 和 AOF rewrite 后，在执行时，它们都需要主进程创建出一个子进程进行数据的持久化。</p><p><strong>主进程创建子进程，会调用操作系统提供的 fork 函数</strong>。</p><p>而 fork 在执行过程中，主进程需要拷贝自己的内存页表给子进程，如果这个实例很大，那么这个拷贝的过程也会比较耗时。</p><p>而且这个 fork 过程会消耗大量的 CPU 资源，在完成 fork 之前，整个 Redis 实例会被阻塞住，无法处理任何客户端请求。</p><p>如果此时你的 CPU 资源本来就很紧张，那么 fork 的耗时会更长，甚至达到秒级，这会严重影响 Redis 的性能。</p><p>那如何确认确实是因为 fork 耗时导致的 Redis 延迟变大呢？</p><p>你可以在 Redis 上执行 INFO 命令，查看 latest_fork_usec 项，单位微秒。</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 上一次 fork 耗时，单位微秒</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">latest_fork_usec:59477</span></span></code></pre></div><p>这个时间就是主进程在 fork 子进程期间，整个实例阻塞无法处理客户端请求的时间。</p><p>如果你发现这个耗时很久，就要警惕起来了，这意味在这期间，你的整个 Redis 实例都处于不可用的状态。</p><p>除了数据持久化会生成 RDB 之外，当主从节点第一次建立数据同步时，主节点也创建子进程生成 RDB，然后发给从节点进行一次全量同步，所以，这个过程也会对 Redis 产生性能影响。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019711.png" alt="image-20220627225032103" tabindex="0" loading="lazy"><figcaption>image-20220627225032103</figcaption></figure><h3 id="_7-1-优化方案" tabindex="-1"><a class="header-anchor" href="#_7-1-优化方案"><span>7.1 优化方案</span></a></h3><p>要想避免这种情况，你可以采取以下方案进行优化：</p><ul><li>控制 Redis 实例的内存：尽量在 10G 以下，执行 fork 的耗时与实例大小有关，实例越大，耗时越久</li><li>合理配置数据持久化策略：在 slave 节点执行 RDB 备份，推荐在低峰期执行，而对于丢失数据不敏感的业务（例如把 Redis 当做纯缓存使用），可以关闭 AOF 和 AOF rewrite</li><li>Redis 实例不要部署在虚拟机上：fork 的耗时也与系统也有关，虚拟机比物理机耗时更久</li><li>降低主从库全量同步的概率：适当调大 repl-backlog-size 参数，避免主从全量同步</li></ul><h2 id="_8-开启内存大页" tabindex="-1"><a class="header-anchor" href="#_8-开启内存大页"><span>8. 开启内存大页</span></a></h2><blockquote><p>除了上面讲到的子进程 RDB 和 AOF rewrite 期间，fork 耗时导致的延时变大之外，这里还有一个方面也会导致性能问题，这就是操作系统是否开启了内存大页机制。</p></blockquote><h3 id="_8-1-什么是内存大页" tabindex="-1"><a class="header-anchor" href="#_8-1-什么是内存大页"><span>8.1 <strong>什么是内存大页</strong>？</span></a></h3><p>我们都知道，应用程序向操作系统申请内存时，是按内存页进行申请的，而常规的内存页大小是 4KB。</p><p>Linux 内核从 2.6.38 开始，支持了内存大页机制，该机制允许应用程序以 2MB 大小为单位，向操作系统申请内存。</p><p>应用程序每次向操作系统申请的内存单位变大了，但这也意味着申请内存的耗时变长。</p><h3 id="_8-2-这对-redis-会有什么影响呢" tabindex="-1"><a class="header-anchor" href="#_8-2-这对-redis-会有什么影响呢"><span>8.2 <strong>这对 Redis 会有什么影响呢</strong>？</span></a></h3><p>当 Redis 在执行后台 RDB 和 AOF rewrite 时，采用 fork 子进程的方式来处理。但主进程 fork 子进程后，此时的主进程依旧是可以接收写请求的，而进来的写请求，会采用 Copy On Write（写时复制）的方式操作内存数据。</p><p>也就是说，主进程一旦有数据需要修改，Redis 并不会直接修改现有内存中的数据，而是先将这块内存数据拷贝出来，再修改这块新内存的数据，这就是所谓的「写时复制」。</p><p>写时复制你也可以理解成，谁需要发生写操作，谁就需要先拷贝，再修改。</p><p>这样做的好处是，父进程有任何写操作，并不会影响子进程的数据持久化（子进程只持久化 fork 这一瞬间整个实例中的所有数据即可，不关心新的数据变更，因为子进程只需要一份内存快照，然后持久化到磁盘上）。</p><p>但是请注意，<strong>主进程在拷贝内存数据时，这个阶段就涉及到新内存的申请，如果此时操作系统开启了内存大页，那么在此期间，客户端即便只修改 10B 的数据，Redis 在申请内存时也会以 2MB 为单位向操作系统申请，申请内存的耗时变长，进而导致每个写请求的延迟增加，影响到 Redis 性能</strong>。</p><p>同样地，如果这个写请求操作的是一个 bigkey，那主进程在拷贝这个 bigkey 内存块时，一次申请的内存会更大，时间也会更久。可见，bigkey 在这里又一次影响到了性能。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019748.png" alt="image-20220627225331549" tabindex="0" loading="lazy"><figcaption>image-20220627225331549</figcaption></figure><h3 id="_8-3-那如何解决这个问题" tabindex="-1"><a class="header-anchor" href="#_8-3-那如何解决这个问题"><span>8.3 <strong>那如何解决这个问题</strong>？</span></a></h3><p>很简单，你只需要关闭内存大页机制就可以了。</p><p>首先，你需要查看 Redis 机器是否开启了内存大页：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> cat</span><span style="color:#98C379;--shiki-dark:#98C379;"> /sys/kernel/mm/transparent_hugepage/enabled</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[always] madvise never</span></span></code></pre></div><p>如果输出选项是 always，就表示目前开启了内存大页机制，我们需要关掉它：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> echo</span><span style="color:#98C379;--shiki-dark:#98C379;"> never</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">/sys/kernel/mm/transparent_hugepage/enabled</span></span></code></pre></div><p>其实，操作系统提供的内存大页机制，其优势是，可以在一定程序上降低应用程序申请内存的次数。</p><p>但是对于 Redis 这种对性能和延迟极其敏感的数据库来说，我们希望 Redis 在每次申请内存时，耗时尽量短，所以我不建议你在 Redis 机器上开启这个机制。</p><h2 id="_9-开启aof" tabindex="-1"><a class="header-anchor" href="#_9-开启aof"><span>9. 开启AOF</span></a></h2><blockquote><p>前面我们分析了 RDB 和 AOF rewrite 对 Redis 性能的影响，主要关注点在 fork 上。</p></blockquote><p>其实，关于数据持久化方面，还有影响 Redis 性能的因素，这次我们重点来看 AOF 数据持久化。</p><p>如果你的 AOF 配置不合理，还是有可能会导致性能问题。</p><p>当 Redis 开启 AOF 后，其工作原理如下：</p><ul><li>Redis 执行写命令后，把这个命令写入到 AOF 文件内存中（write 系统调用）</li><li>Redis 根据配置的 AOF 刷盘策略，把 AOF 内存数据刷到磁盘上（fsync 系统调用）</li></ul><p>为了保证 AOF 文件数据的安全性，Redis 提供了 3 种刷盘机制：</p><ul><li>appendfsync always：主线程每次执行写操作后立即刷盘，此方案会占用比较大的磁盘 IO 资源，但数据安全性最高</li><li>appendfsync no：主线程每次写操作只写内存就返回，内存数据什么时候刷到磁盘，交由操作系统决定，此方案对性能影响最小，但数据安全性也最低，Redis 宕机时丢失的数据取决于操作系统刷盘时机</li><li>appendfsync everysec：主线程每次写操作只写内存就返回，然后由后台线程每隔 1 秒执行一次刷盘操作（触发fsync系统调用），此方案对性能影响相对较小，但当 Redis 宕机时会丢失 1 秒的数据</li></ul><p>下面我们依次来分析，这几个机制对性能的影响。</p><p>如果你的 AOF 配置为 appendfsync always，那么 Redis 每处理一次写操作，都会把这个命令写入到磁盘中才返回，整个过程都是在主线程执行的，这个过程必然会加重 Redis 写负担。</p><p>原因也很简单，操作磁盘要比操作内存慢几百倍，采用这个配置会严重拖慢 Redis 的性能，因此我不建议你把 AOF 刷盘方式配置为 always。</p><p>我们接着来看 appendfsync no 配置项。</p><p>在这种配置下，Redis 每次写操作只写内存，什么时候把内存中的数据刷到磁盘，交给操作系统决定，此方案对 Redis 的性能影响最小，但当 Redis 宕机时，会丢失一部分数据，为了数据的安全性，一般我们也不采取这种配置。</p><blockquote><p>如果你的 Redis 只用作纯缓存，对于数据丢失不敏感，采用配置 appendfsync no 也是可以的。</p></blockquote><p>看到这里，我猜你肯定和大多数人的想法一样，选比较折中的方案 appendfsync everysec 就没问题了吧？</p><p>这个方案优势在于，Redis 主线程写完内存后就返回，具体的刷盘操作是放到后台线程中执行的，后台线程每隔 1 秒把内存中的数据刷到磁盘中。</p><p>这种方案既兼顾了性能，又尽可能地保证了数据安全，是不是觉得很完美？</p><p><strong>但是，这里我要给你泼一盆冷水了，采用这种方案你也要警惕一下，因为这种方案还是存在导致 Redis 延迟变大的情况发生，甚至会阻塞整个 Redis</strong>。</p><p>这是为什么？我把 AOF 最耗时的刷盘操作，放到后台线程中也会影响到 Redis 主线程？</p><p>你试想这样一种情况：当 Redis 后台线程在执行 AOF 文件刷盘时，如果此时磁盘的 IO 负载很高，那这个后台线程在执行刷盘操作（fsync系统调用）时就会被阻塞住。</p><p>此时的主线程依旧会接收写请求，紧接着，主线程又需要把数据写到文件内存中（write 系统调用），<strong>但此时的后台子线程由于磁盘负载过高，导致 fsync 发生阻塞，迟迟不能返回，那主线程在执行 write 系统调用时，也会被阻塞住，直到后台线程 fsync 执行完成后，主线程执行 write 才能成功返回</strong>。</p><p>看到了么？在这个过程中，主线程依旧有阻塞的风险</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019783.png" alt="image-20220627225820723" tabindex="0" loading="lazy"><figcaption>image-20220627225820723</figcaption></figure><p>所以，尽管你的 AOF 配置为 appendfsync everysec，也不能掉以轻心，要警惕磁盘压力过大导致的 Redis 有性能问题。</p><p>那什么情况下会导致磁盘 IO 负载过大？以及如何解决这个问题呢？</p><p>我总结了以下几种情况，你可以参考进行问题排查：</p><ul><li>子进程正在执行 AOF rewrite，这个过程会占用大量的磁盘 IO 资源</li><li>有其他应用程序在执行大量的写文件操作，也会占用磁盘 IO 资源</li></ul><p>对于情况1，说白了就是，Redis 的 AOF 后台子线程刷盘操作，撞上了子进程 AOF rewrite！</p><p>这怎么办？难道要关闭 AOF rewrite 才行？</p><p>幸运的是，Redis 提供了一个配置项，当子进程在 AOF rewrite 期间，可以让后台子线程不执行刷盘（不触发 fsync 系统调用）操作。</p><p>这相当于在 AOF rewrite 期间，临时把 appendfsync 设置为了 none，配置如下：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># AOF rewrite 期间，AOF 后台子线程不进行刷盘操作</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 相当于在这期间，临时把 appendfsync 设置为了 none</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">no-appendfsync-on-rewrite</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span></code></pre></div><p>当然，开启这个配置项，在 AOF rewrite 期间，如果实例发生宕机，那么此时会丢失更多的数据，性能和数据安全性，你需要权衡后进行选择。</p><p>如果占用磁盘资源的是其他应用程序，那就比较简单了，你需要定位到是哪个应用程序在大量写磁盘，然后把这个应用程序迁移到其他机器上执行就好了，避免对 Redis 产生影响。</p><p>当然，如果你对 Redis 的性能和数据安全都有很高的要求，那么我建议从硬件层面来优化，更换为 SSD 磁盘，提高磁盘的 IO 能力，保证 AOF 期间有充足的磁盘资源可以使用。</p><h2 id="_10-绑定cpu" tabindex="-1"><a class="header-anchor" href="#_10-绑定cpu"><span>10. 绑定CPU</span></a></h2><blockquote><p>很多时候，我们在部署服务时，为了提高服务性能，降低应用程序在多个 CPU 核心之间的上下文切换带来的性能损耗，通常采用的方案是进程绑定 CPU 的方式提高性能。</p></blockquote><p>但在部署 Redis 时，如果你需要绑定 CPU 来提高其性能，我建议你仔细斟酌后再做操作。</p><h3 id="_10-1-为什么" tabindex="-1"><a class="header-anchor" href="#_10-1-为什么"><span>10.1 <strong>为什么</strong>？</span></a></h3><p>因为 Redis 在绑定 CPU 时，是有很多考究的，如果你不了解 Redis 的运行原理，随意绑定 CPU 不仅不会提高性能，甚至有可能会带来相反的效果。</p><p>我们都知道，一般现代的服务器会有多个 CPU，而每个 CPU 又包含多个物理核心，每个物理核心又分为多个逻辑核心，每个物理核下的逻辑核共用 L1/L2 Cache。</p><p>而 Redis Server 除了主线程服务客户端请求之外，还会创建子进程、子线程。</p><p>其中子进程用于数据持久化，而子线程用于执行一些比较耗时操作，例如异步释放 fd、异步 AOF 刷盘、异步 lazy-free 等等。</p><p>如果你把 Redis 进程只绑定了一个 CPU 逻辑核心上，那么当 Redis 在进行数据持久化时，fork 出的子进程会继承父进程的 CPU 使用偏好。</p><p>而此时的子进程会消耗大量的 CPU 资源进行数据持久化（把实例数据全部扫描出来需要耗费CPU），这就会导致子进程会与主进程发生 CPU 争抢，进而影响到主进程服务客户端请求，访问延迟变大。</p><p>这就是 Redis 绑定 CPU 带来的性能问题。</p><h3 id="_10-2-那如何解决这个问题呢" tabindex="-1"><a class="header-anchor" href="#_10-2-那如何解决这个问题呢"><span>10.2 <strong>那如何解决这个问题呢</strong>？</span></a></h3><p>如果你确实想要绑定 CPU，可以优化的方案是，不要让 Redis 进程只绑定在一个 CPU 逻辑核上，而是绑定在多个逻辑核心上，而且，绑定的多个逻辑核心最好是同一个物理核心，这样它们还可以共用 L1/L2 Cache。</p><p>当然，即便我们把 Redis 绑定在多个逻辑核心上，也只能在一定程度上缓解主线程、子进程、后台线程在 CPU 资源上的竞争。</p><p>因为这些子进程、子线程还是会在这多个逻辑核心上进行切换，存在性能损耗。</p><h3 id="_10-3-如何再进一步优化" tabindex="-1"><a class="header-anchor" href="#_10-3-如何再进一步优化"><span>10.3 <strong>如何再进一步优化</strong>？</span></a></h3><p>可能你已经想到了，我们是否可以让主线程、子进程、后台线程，分别绑定在固定的 CPU 核心上，不让它们来回切换，这样一来，他们各自使用的 CPU 资源互不影响。</p><p>其实，这个方案 Redis 官方已经想到了。</p><p>Redis 在 6.0 版本已经推出了这个功能，我们可以通过以下配置，对主线程、后台线程、后台 RDB 进程、AOF rewrite 进程，绑定固定的 CPU 逻辑核心：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Redis Server 和 IO 线程绑定到 CPU核心 0,2,4,6</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">server_cpulist</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0-7:2</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 后台子线程绑定到 CPU核心 1,3</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">bio_cpulist</span><span style="color:#98C379;--shiki-dark:#98C379;"> 1,3</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 后台 AOF rewrite 进程绑定到 CPU 核心 8,9,10,11</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">aof_rewrite_cpulist</span><span style="color:#98C379;--shiki-dark:#98C379;"> 8-11</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 后台 RDB 进程绑定到 CPU 核心 1,10,11</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># bgsave_cpulist 1,10-1</span></span></code></pre></div><p>如果你使用的正好是 Redis 6.0 版本，就可以通过以上配置，来进一步提高 Redis 性能。</p><p>这里我需要提醒你的是，一般来说，Redis 的性能已经足够优秀，除非你对 Redis 的性能有更加严苛的要求，否则不建议你绑定 CPU。</p><p>从上面的分析你也能看出，绑定 CPU 需要你对计算机体系结构有非常清晰的了解，否则谨慎操作。</p><p>我们继续分析还有什么场景会导致 Redis 变慢。</p><h2 id="_11-使用swap" tabindex="-1"><a class="header-anchor" href="#_11-使用swap"><span>11. 使用Swap</span></a></h2><p>如果你发现 Redis 突然变得非常慢，<strong>每次的操作耗时都达到了几百毫秒甚至秒级</strong>，那此时你就需要检查 Redis 是否使用到了 Swap，在这种情况下 Redis 基本上已经无法提供高性能的服务了。</p><p>什么是 Swap？为什么使用 Swap 会导致 Redis 的性能下降？</p><p>如果你对操作系统有些了解，就会知道操作系统为了缓解内存不足对应用程序的影响，允许把一部分内存中的数据换到磁盘上，以达到应用程序对内存使用的缓冲，这些内存数据被换到磁盘上的区域，就是 Swap。</p><p>问题就在于，当内存中的数据被换到磁盘上后，Redis 再访问这些数据时，就需要从磁盘上读取，访问磁盘的速度要比访问内存慢几百倍！</p><p><strong>尤其是针对 Redis 这种对性能要求极高、性能极其敏感的数据库来说，这个操作延时是无法接受的</strong>。</p><p>此时，你需要检查 Redis 机器的内存使用情况，确认是否存在使用了 Swap。</p><p>你可以通过以下方式来查看 Redis 进程是否使用到了 Swap：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 先找到 Redis 的进程 ID</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> ps</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -aux</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">grep</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-server</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看 Redis Swap 使用情况</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> cat</span><span style="color:#98C379;--shiki-dark:#98C379;"> /proc/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$pid</span><span style="color:#98C379;--shiki-dark:#98C379;">/smaps</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">egrep</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;^(Swap|Size)&#39;</span></span></code></pre></div><p>输出结果如下：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">               1256</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  4</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                132</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">              63488</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                132</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">              65404</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Size:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">            1921024</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Swap:</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> kB</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个结果会列出 Redis 进程的内存使用情况。</p><p>每一行 Size 表示 Redis 所用的一块内存大小，Size 下面的 Swap 就表示这块 Size 大小的内存，有多少数据已经被换到磁盘上了，如果这两个值相等，说明这块内存的数据都已经完全被换到磁盘上了。</p><p>如果只是少量数据被换到磁盘上，例如每一块 Swap 占对应 Size 的比例很小，那影响并不是很大。<strong>如果是几百兆甚至上 GB 的内存被换到了磁盘上，那么你就需要警惕了，这种情况 Redis 的性能肯定会急剧下降</strong>。</p><p>此时的解决方案是：</p><ul><li>增加机器的内存，让 Redis 有足够的内存可以使用</li><li>整理内存空间，释放出足够的内存供 Redis 使用，然后释放 Redis 的 Swap，让 Redis 重新使用内存</li></ul><p>释放 Redis 的 Swap 过程通常要重启实例，为了避免重启实例对业务的影响，一般会先进行主从切换，然后释放旧主节点的 Swap，重启旧主节点实例，待从库数据同步完成后，再进行主从切换即可。</p><p>可见，当 Redis 使用到 Swap 后，此时的 Redis 性能基本已达不到高性能的要求（你可以理解为武功被废），所以你也需要提前预防这种情况。</p><p>预防的办法就是，你需要对 Redis 机器的内存和 Swap 使用情况进行监控，在内存不足或使用到 Swap 时报警出来，及时处理。</p><h2 id="_12-碎片整理" tabindex="-1"><a class="header-anchor" href="#_12-碎片整理"><span>12. 碎片整理</span></a></h2><blockquote><p>Redis 的数据都存储在内存中，当我们的应用程序频繁修改 Redis 中的数据时，就有可能会导致 Redis 产生内存碎片。</p></blockquote><p>内存碎片会降低 Redis 的内存使用率，我们可以通过执行 INFO 命令，得到这个实例的内存碎片率：</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Memory</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">used_memory:5709194824</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">used_memory_human:5.32G</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">used_memory_rss:8264855552</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">used_memory_rss_human:7.70G</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">mem_fragmentation_ratio:1.45</span></span></code></pre></div><p><strong>这个内存碎片率是怎么计算的</strong>？</p><p>很简单，mem_fragmentation_ratio = used_memory_rss / used_memory。</p><p>其中 used_memory 表示 Redis 存储数据的内存大小，而 used_memory_rss 表示操作系统实际分配给 Redis 进程的大小。</p><p>如果 mem_fragmentation_ratio &gt; 1.5，说明内存碎片率已经超过了 50%，这时我们就需要采取一些措施来降低内存碎片了。</p><p>解决的方案一般如下：</p><ul><li>如果你使用的是 Redis 4.0 以下版本，只能通过重启实例来解决</li><li>如果你使用的是 Redis 4.0 版本，它正好提供了自动碎片整理的功能，可以通过配置开启碎片自动整理</li></ul><p>但是，开启内存碎片整理，它也有可能会导致 Redis 性能下降。</p><p>原因在于，Redis 的碎片整理工作是也在主线程中执行的，当其进行碎片整理时，必然会消耗 CPU 资源，产生更多的耗时，从而影响到客户端的请求。</p><p>所以，当你需要开启这个功能时，最好提前测试评估它对 Redis 的影响。</p><p>Redis 碎片整理的参数配置如下：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 开启自动内存碎片整理（总开关）</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">activedefrag</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内存使用 100MB 以下，不进行碎片整理</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-ignore-bytes</span><span style="color:#98C379;--shiki-dark:#98C379;"> 100mb</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内存碎片率超过 10%，开始碎片整理</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-threshold-lower</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内存碎片率超过 100%，尽最大努力碎片整理</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-threshold-upper</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 100</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内存碎片整理占用 CPU 资源最小百分比</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-cycle-min</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内存碎片整理占用 CPU 资源最大百分比</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-cycle-max</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 25</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 碎片整理期间，对于 List/Set/Hash/ZSet 类型元素一次 Scan 的数量</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">active-defrag-max-scan-fields</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1000</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你需要结合 Redis 机器的负载情况，以及应用程序可接受的延迟范围进行评估，合理调整碎片整理的参数，尽可能降低碎片整理期间对 Redis 的影响。</p><h2 id="_13-网络带宽过载" tabindex="-1"><a class="header-anchor" href="#_13-网络带宽过载"><span>13. 网络带宽过载</span></a></h2><blockquote><p>如果以上产生性能问题的场景，你都规避掉了，而且 Redis 也稳定运行了很长时间，但在某个时间点之后开始，操作 Redis 突然开始变慢了，而且一直持续下去，这种情况又是什么原因导致？</p></blockquote><p>此时你需要排查一下 Redis 机器的网络带宽是否过载，是否存在某个实例把整个机器的网路带宽占满的情况。</p><p>网络带宽过载的情况下，服务器在 TCP 层和网络层就会出现数据包发送延迟、丢包等情况。</p><p>Redis 的高性能，除了操作内存之外，就在于网络 IO 了，如果网络 IO 存在瓶颈，那么也会严重影响 Redis 的性能。</p><p>如果确实出现这种情况，你需要及时确认占满网络带宽 Redis 实例，如果属于正常的业务访问，那就需要及时扩容或迁移实例了，避免因为这个实例流量过大，影响这个机器的其他实例。</p><p>运维层面，你需要对 Redis 机器的各项指标增加监控，包括网络流量，在网络流量达到一定阈值时提前报警，及时确认和扩容。</p><h2 id="_14-其他原因" tabindex="-1"><a class="header-anchor" href="#_14-其他原因"><span>14. 其他原因</span></a></h2><p>好了，以上这些方面就是如何排查 Redis 延迟问题的思路和路径。</p><p>除了以上这些，还有一些比较小的点，你也需要注意一下：</p><ul><li><strong>频繁短连接</strong></li></ul><p>你的业务应用，应该使用长连接操作 Redis，避免频繁的短连接。</p><p>频繁的短连接会导致 Redis 大量时间耗费在连接的建立和释放上，TCP 的三次握手和四次挥手同样也会增加访问延迟。</p><ul><li><strong>运维监控</strong></li></ul><p>前面我也提到了，要想提前预知 Redis 变慢的情况发生，必不可少的就是做好完善的监控。</p><p>监控其实就是对采集 Redis 的各项运行时指标，通常的做法是监控程序定时采集 Redis 的 INFO 信息，然后根据 INFO 信息中的状态数据做数据展示和报警。</p><p>这里我需要提醒你的是，在写一些监控脚本，或使用开源的监控组件时，也不能掉以轻心。</p><p>在写监控脚本访问 Redis 时，尽量采用长连接的方式采集状态信息，避免频繁短连接。同时，你还要注意控制访问 Redis 的频率，避免影响到业务请求。</p><p>在使用一些开源的监控组件时，最好了解一下这些组件的实现原理，以及正确配置这些组件，防止出现监控组件发生 Bug，导致短时大量操作 Redis，影响 Redis 性能的情况发生。</p><p>我们当时就发生过，DBA 在使用一些开源组件时，因为配置和使用问题，导致监控程序频繁地与 Redis 建立和断开连接，导致 Redis 响应变慢。</p><ul><li><strong>其它程序争抢资源</strong></li></ul><p>最后需要提醒你的是，你的 Redis 机器最好专项专用，只用来部署 Redis 实例，不要部署其他应用程序，尽量给 Redis 提供一个相对「安静」的环境，避免其它程序占用 CPU、内存、磁盘资源，导致分配给 Redis 的资源不足而受到影响。</p><h2 id="_15-总结" tabindex="-1"><a class="header-anchor" href="#_15-总结"><span>15. 总结</span></a></h2><blockquote><p>好了，以上就是我总结的在使用 Redis 过程中，常见的可能导致延迟、甚至阻塞的问题场景，以及如何快速定位和分析这些问题，并且针对性地提供了解决方案。</p></blockquote><p>这里我也汇总成了思维导图，方便你在排查 Redis 性能问题时，快速地去分析和定位。</p><figure><img src="https://cdn.jsdelivr.net/gh/MrJackC/PicGoImages/other/202403131019818.png" alt="image-20220627230852860" tabindex="0" loading="lazy"><figcaption>image-20220627230852860</figcaption></figure><p>这里再简单总结一下，Redis 的性能问题，既涉及到了业务开发人员的使用方面，也涉及到了 DBA 的运维方面。</p><p>作为业务开发人员，我们需要了解 Redis 的基本原理，例如各个命令执行的时间复杂度、数据过期策略、数据淘汰策略等，从而更合理地使用 Redis 命令，并且结合业务场景进行优化。</p><p>作为 DBA 和运维人员，需要了解 Redis 运行机制，例如数据持久化、内存碎片整理、进程绑核配置。除此之外，还需要了解操作系统相关知识，例如写时复制、内存大页、Swap 机制等等。</p><p>同时，DBA 在部署 Redis 时，需要提前对进行容量规划，预留足够的机器资源，还要对 Redis 机器和实例做好完善的监控，这样才能尽可能地保证 Redis 的稳定运行。</p><h2 id="_16-后记" tabindex="-1"><a class="header-anchor" href="#_16-后记"><span>16. 后记</span></a></h2><blockquote><p>如果你能耐心地看到这里，想必你肯定已经对 Redis 的性能调优有了很大的收获。</p></blockquote><p>你应该也发现了，Redis 的性能问题，涉及到的知识点非常广，几乎涵盖了 CPU、内存、网络、甚至磁盘的方方面面，同时，你还需要了解计算机的体系结构，以及操作系统的各种机制。</p><p>从资源使用角度来看，包含的知识点如下：</p><ul><li><strong>CPU 相关</strong>：使用复杂度过高命令、数据的持久化，都与耗费过多的 CPU 资源有关</li><li><strong>内存相关</strong>：bigkey 内存的申请和释放、数据过期、数据淘汰、碎片整理、内存大页、内存写时复制都与内存息息相关</li><li><strong>磁盘相关</strong>：数据持久化、AOF 刷盘策略，也会受到磁盘的影响</li><li><strong>网络相关</strong>：短连接、实例流量过载、网络流量过载，也会降低 Redis 性能</li><li><strong>计算机系统</strong>：CPU 结构、内存分配，都属于最基础的计算机系统知识</li><li><strong>操作系统</strong>：写时复制、内存大页、Swap、CPU 绑定，都属于操作系统层面的知识</li></ul><p>没想到吧？Redis 为了把性能做到极致，涉及到了这么多项优化。</p><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章"><span>参考文章</span></a></h2><p><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-performance.html" target="_blank" rel="noopener noreferrer"><strong>Redis进阶 - 性能调优：Redis性能调优详解</strong></a></p></div><!--[--><div class="sponsor" data-v-98f29c97><div id="drinks-box" data-v-98f29c97><div id="drinks-box-s" class="drinks-button left-100" data-v-98f29c97><div id="drinks-icons" class="left-100 tr3" data-v-98f29c97><div id="coffee-donate" class="icon-donate" data-v-98f29c97><span class="font-icon icon iconfont icon-hk-flutter" data-v-98f29c97></span> 赞助 </div></div><div id="drinks-button-box" class="tr3 left-100" data-v-98f29c97><div id="drinks-button-bg" class="left-100" data-v-98f29c97></div><div id="github-box" data-v-98f29c97><a href="https://github.com/OrageKK/sponsor-page" target="_blank" data-v-98f29c97>Github</a></div><ul id="donate-buttons" class="list tr3" data-v-98f29c97><li id="paypal_donate" data-v-98f29c97><a href="https://www.paypal.me/oragekk" target="_blank" data-v-98f29c97>Paypal</a></li><!-- <li id="btc_donate" class="donate-button">Bitcoin</li> --><li id="alipay_donate" class="donate-button" data-v-98f29c97>AliPay</li><li id="wechat_donate" class="donate-button2" data-v-98f29c97>WeChat</li></ul></div><div id="drinks-qrcodes" class="left-100 tr3" data-v-98f29c97><div id="drinks-qrcode" data-v-98f29c97></div></div></div></div></div><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/MrjackC/mrjackc.github.io/edit/main/src/posts/Redis/db-redis-x-performance.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 845886914@qq.com">MrJason</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/posts/Redis/db-redis-x-hot-key.html" aria-label="Redis进阶 - Redis热key问题"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Redis进阶 - Redis热key问题</div></a><a class="route-link auto-link next" href="/posts/Redis/redis-z-interview-overview.html" aria-label="Redis面试 - redis问题总结"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Redis面试 - redis问题总结<!----></div></a></nav><div id="vp-comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">你认为这篇文章怎么样？</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_agree.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_look_down.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sunglasses.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_pick_nose.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_awkward.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="//unpkg.com/@waline/emojis/tieba/tieba_sleep.png"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text"></div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址(可选)</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" aria-hidden="true" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片" aria-label="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <span>  /  <span class="">300</span></span>  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.3.2</div></div></div><!----><!--]--></main><!--]--><div style="--0dfcb062:;"><footer class="footer-wrapper" style="display:none;"><div class="busuanzi"><span id="busuanzi_container_site_pv" style="display:none;"> 本站总访问量 <span id="busuanzi_value_site_pv"></span>次 <span class="post-meta-divider">|</span></span><span id="busuanzi_container_site_uv" style="display:none;"> 您是本站第 <span id="busuanzi_value_site_uv"></span>位访问者 </span></div><div class="footer-content"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2020-2024 MrJason</div></div><span id="runtime_span"></span><div class="footer-link"><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="https://img.foreverblog.cn/wormhole_1.gif" alt="" style="width:auto;height:32px;" title="穿梭虫洞-随机访问十年之约友链博客"></a><a href="https://www.travellings.cn/go.html" target="_blank"><img src="https://www.travellings.cn/assets/logo.gif" alt="" style="width:auto;height:32px;" title="开往-友链接力"></a></div></footer></div></div><!--]--><!--[--><!----><!----><div></div><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BhoNqsD-.js" defer></script>
  </body>
</html>
