import{_ as a,c as n,a as i,o as l}from"./app-CQys7GfP.js";const p={};function r(B,s){return l(),n("div",null,s[0]||(s[0]=[i(`<h1 id="mysql-慢查询优化思路与案例" tabindex="-1"><a class="header-anchor" href="#mysql-慢查询优化思路与案例"><span>MySQL - 慢查询优化思路与案例</span></a></h1><h2 id="_1-建索引的几大原则" tabindex="-1"><a class="header-anchor" href="#_1-建索引的几大原则"><span>1. 建索引的几大原则</span></a></h2><ol><li>最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(<code>&gt;</code>、<code>&lt;</code>、<code>between</code>、<code>like</code>)就停止匹配，比如<code>a = 1 and b = 2 and c &gt; 3 and d = 4</code> 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</li><li>=和in可以乱序，比如<code>a = 1 and b = 2 and c = 3</code> 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式</li><li>尽量选择区分度高的列作为索引，区分度的公式是<code>count(distinct col)/count(*)</code>，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录。</li><li>索引列不能参与计算，保持列“干净”，比如<code>from_unixtime(create_time) = ’2014-05-29’</code>就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’)。</li><li>尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。</li></ol><h2 id="_2-优化步骤-explain命令" tabindex="-1"><a class="header-anchor" href="#_2-优化步骤-explain命令"><span>2. 优化步骤- explain命令</span></a></h2><blockquote><p>关于explain命令相信大家并不陌生，具体用法和字段含义可以参考官网explain-output，这里需要强调rows是核心指标，绝大部分rows小的语句执行一定很快（有例外，下面会讲到）。所以优化语句基本上都是在优化rows。</p></blockquote><ol><li>先运行看看是否真的很慢，注意设置SQL_NO_CACHE</li><li>where条件单表查，锁定最小返回记录表。这句话的意思是把查询语句的where都应用到表中返回的记录数最小的表开始查起，单表每个字段分别查询，看哪个字段的区分度最高</li><li>explain查看执行计划，是否与1预期一致（从锁定记录较少的表开始查询）</li><li>order by limit 形式的sql语句让排序的表优先查</li><li>了解业务方使用场景</li><li>加索引时参照建索引的几大原则</li><li>观察结果，不符合预期继续从0分析</li></ol><h2 id="_3-慢查询优化案例" tabindex="-1"><a class="header-anchor" href="#_3-慢查询优化案例"><span>3. 慢查询优化案例</span></a></h2><h3 id="_3-1-复杂语句写法-优化sql" tabindex="-1"><a class="header-anchor" href="#_3-1-复杂语句写法-优化sql"><span>3.1 复杂语句写法（优化sql）</span></a></h3><p>很多情况下，我们写SQL只是为了实现功能，这只是第一步，不同的语句书写方式对于效率往往有本质的差别，这要求我们对mysql的执行计划和索引原则有非常清楚的认识，请看下面的语句：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   distinct</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">emp_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   cm_log cl </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> emp_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         emp_cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cert_id </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         employee emp </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      left join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         emp_certificate emp_cert </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp_cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">emp_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_deleted</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   ) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_table</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Employee&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_oid</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">emp_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      ) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_table</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;EmpCertificate&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_oid</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cert_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      ) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-07 15:03:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-08 16:00:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong>先运行一下</strong>，53条记录 1.87秒，又没有用聚合语句，比较慢</li></ol><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">53</span><span style="color:#98C379;--shiki-dark:#98C379;"> rows</span><span style="color:#98C379;--shiki-dark:#98C379;"> in</span><span style="color:#98C379;--shiki-dark:#98C379;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (1.87 </span><span style="color:#98C379;--shiki-dark:#98C379;">sec</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><ol><li><strong>explain</strong></li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+------------+-------+---------------------------------+-----------------------+---------+-------------------+-------+--------------------------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| id | select_type | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  | possible_keys                   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                   | key_len | ref               | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">rows</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  | Extra                          |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+------------+-------+---------------------------------+-----------------------+---------+-------------------+-------+--------------------------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     | cl         | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">range</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | cm_log_cls_id,idx_last_upd_date | idx_last_upd_date     | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              |   </span><span style="color:#D19A66;--shiki-dark:#D19A66;">379</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> temporary   |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     | </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">derived2</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | ALL   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                            | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">63727</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> join</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> buffer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | DERIVED     | emp        | ALL   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                            | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">13317</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | DERIVED     | emp_cert   | ref   | emp_certificate_empid           | emp_certificate_empid | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituanorg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.id |     </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> index</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+------------+-------+---------------------------------+-----------------------+---------+-------------------+-------+--------------------------------+</span></span></code></pre></div><ol><li><strong>简述一下执行计划</strong>，首先mysql根据idx_last_upd_date索引扫描cm_log表获得379条记录；然后查表扫描了63727条记录，分为两部分，derived表示构造表，也就是不存在的表，可以简单理解成是一个语句形成的结果集，后面的数字表示语句的ID。derived2表示的是ID = 2的查询构造了虚拟表，并且返回了63727条记录。我们再来看看ID = 2的语句究竟做了写什么返回了这么大量的数据，首先全表扫描employee表13317条记录，然后根据索引emp_certificate_empid关联emp_certificate表，rows = 1表示，每个关联都只锁定了一条记录，效率比较高。获得后，再和cm_log的379条记录根据规则关联。从执行过程上可以看出返回了太多的数据，返回的数据绝大部分cm_log都用不到，因为cm_log只锁定了379条记录。</li><li><strong>如何优化呢</strong>？可以看到我们在运行完后还是要和cm_log做join,那么我们能不能之前和cm_log做join呢？仔细分析语句不难发现，其基本思想是如果cm_log的ref_table是EmpCertificate就关联emp_certificate表，如果ref_table是Employee就关联employee表，我们完全可以拆成两部分，并用union连接起来，注意这里用union，而不用union all是因为原语句有“distinct”来得到唯一的记录，而union恰好具备了这种功能。如果原语句中没有distinct不需要去重，我们就可以直接使用union all了，因为使用union需要去重的动作，会影响SQL性能。</li></ol><p>优化过的语句如下：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   cm_log cl </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   employee emp </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_table</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;Employee&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_oid</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-07 15:03:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-08 16:00:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_deleted</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">union</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   cm_log cl </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   emp_certificate ec </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_table</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;EmpCertificate&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ref_oid</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> ec</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   employee emp </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> ec</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">emp_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-07 15:03:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_upd_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2013-11-08 16:00:00&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> emp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_deleted</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>不需要了解业务场景，只需要改造的语句和改造之前的语句保持结果一致</li><li>现有索引可以满足，不需要建索引</li><li>用改造后的语句实验一下，只需要10ms 降低了近200倍！</li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+--------------+------------+--------+---------------------------------+-------------------+---------+-----------------------+------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| id | select_type  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   | possible_keys                   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">               | key_len | ref                   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">rows</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | Extra       |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+--------------+------------+--------+---------------------------------+-------------------+---------+-----------------------+------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | cl         | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">range</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  | cm_log_cls_id,idx_last_upd_date | idx_last_upd_date | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                  |  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">379</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | emp        | eq_ref | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                         | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituanorg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.ref_oid |    </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">UNION</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        | cl         | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">range</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  | cm_log_cls_id,idx_last_upd_date | idx_last_upd_date | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                  |  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">379</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">UNION</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        | ec         | eq_ref | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,emp_certificate_empid   | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituanorg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cl</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.ref_oid |    </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |             |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">UNION</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        | emp        | eq_ref | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                         | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituanorg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">ec</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.emp_id  |    </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">UNION</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> RESULT | </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">union1,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | ALL    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                            | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |             |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+--------------+------------+--------+---------------------------------+-------------------+---------+-----------------------+------+-------------+</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">53</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> rows</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre></div><h3 id="_3-2-明确应用场景-区分度低加索引" tabindex="-1"><a class="header-anchor" href="#_3-2-明确应用场景-区分度低加索引"><span>3.2 明确应用场景（区分度低加索引）</span></a></h3><p>举这个例子的目的在于颠覆我们对列的区分度的认知，一般上我们认为区分度越高的列，越容易锁定更少的记录，但在一些特殊的情况下，这种理论是有局限性的。</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   * </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   stage_poi sp </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   sp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">accurate_result</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      sp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sync_status</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      or</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> sp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sync_status</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      or</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> sp</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sync_status</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   );</span></span></code></pre></div><ol><li><strong>先看看运行多长时间</strong>,951条数据6.22秒，真的很慢。</li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">951</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> rows</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">6</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">22</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre></div><ol><li><strong>先explain</strong>，rows达到了361万，type = ALL表明是全表扫描。</li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+------+---------------+------+---------+------+---------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| id | select_type | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | possible_keys | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  | key_len | ref  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">rows</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    | Extra       |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+------+---------------+------+---------+------+---------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SIMPLE</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | sp    | ALL  | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">NULL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3613155</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+------+---------------+------+---------+------+---------+-------------+</span></span></code></pre></div><ol><li>所有字段都应用查询返回记录数，因为是单表查询 0已经做过了951条。</li><li>让explain的rows 尽量逼近951。</li></ol><p>看一下accurate_result = 1的记录数：</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*),accurate_result </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stage_poi  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> accurate_result;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-----------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) | accurate_result |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-----------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|     </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1023</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |              -</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2114655</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |               </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|   </span><span style="color:#D19A66;--shiki-dark:#D19A66;">972815</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |               </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-----------------+</span></span></code></pre></div><p>我们看到accurate_result这个字段的区分度非常低，整个表只有-1,0,1三个值，加上索引也无法锁定特别少量的数据。</p><p>再看一下sync_status字段的情况：</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*),sync_status </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stage_poi  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sync_status;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) | sync_status |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|     </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3080</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |           </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3085413</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |           </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+-------------+</span></span></code></pre></div><p>同样的区分度也很低，根据理论，也不适合建立索引。</p><p>问题分析到这，好像得出了这个表无法优化的结论，两个列的区分度都很低，即便加上索引也只能适应这种情况，很难做普遍性的优化，比如当sync_status 0、3分布的很平均，那么锁定记录也是百万级别的。</p><ol><li><p><strong>找业务方去沟通，看看使用场景</strong>。业务方是这么来使用这个SQL语句的，每隔五分钟会扫描符合条件的数据，处理完成后把sync_status这个字段变成1,五分钟符合条件的记录数并不会太多，1000个左右。了解了业务方的使用场景后，优化这个SQL就变得简单了，因为业务方保证了数据的不平衡，如果加上索引可以过滤掉绝大部分不需要的数据。</p></li><li><p><strong>根据建立索引规则</strong>，使用如下语句建立索引</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">alter</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stage_poi </span><span style="color:#C678DD;--shiki-dark:#C678DD;">add</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> index</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> idx_acc_status(accurate_result,sync_status);</span></span></code></pre></div></li><li><p><strong>观察预期结果</strong>,发现只需要200ms，快了30多倍。</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">952</span><span style="color:#98C379;--shiki-dark:#98C379;"> rows</span><span style="color:#98C379;--shiki-dark:#98C379;"> in</span><span style="color:#98C379;--shiki-dark:#98C379;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (0.20 </span><span style="color:#98C379;--shiki-dark:#98C379;">sec</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div></li></ol><p>我们再来回顾一下分析问题的过程，单表查询相对来说比较好优化，大部分时候只需要把where条件里面的字段依照规则加上索引就好，如果只是这种“无脑”优化的话，显然一些区分度非常低的列，不应该加索引的列也会被加上索引，这样会对插入、更新性能造成严重的影响，同时也有可能影响其它的查询语句。所以我们第4步调差SQL的使用场景非常关键，我们只有知道这个业务场景，才能更好地辅助我们更好的分析和优化查询语句。</p><h3 id="_3-3-无法优化的语句-对大数据量排序导致的问题" tabindex="-1"><a class="header-anchor" href="#_3-3-无法优化的语句-对大数据量排序导致的问题"><span>3.3 无法优化的语句(对大数据量排序导致的问题)</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">position</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sex</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">office_phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">feature_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">birthday</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">creator_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_keyperson</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">giveup_reason</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_source</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> created_time,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> last_modified,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified_user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact c  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact_branch cb </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">contact_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   branch_user bu </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      org_emp_info oei </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_left</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2875</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_right</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &lt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10802</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">org_category</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> - </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   order by</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> desc</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还是几个步骤。</p><ol><li><strong>先看语句运行多长时间</strong>，10条记录用了13秒，已经不可忍受。</li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> rows</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">13</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre></div><ol><li><strong>explain</strong></li></ol><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+--------+-------------------------------------+-------------------------+---------+--------------------------+------+----------------------------------------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| id | select_type | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   | possible_keys                       | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                     | key_len | ref                      | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">rows</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | Extra                                        |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+--------+-------------------------------------+-------------------------+---------+--------------------------+------+----------------------------------------------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SIMPLE</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | oei   | ref    | idx_category_left_right,idx_data_id | idx_category_left_right | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | const                    | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">8849</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> temporary; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> filesort |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SIMPLE</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | bu    | ref    | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,idx_userid_status           | idx_userid_status       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituancrm</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.data_id   |   </span><span style="color:#D19A66;--shiki-dark:#D19A66;">76</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">Using</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> index</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                     |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SIMPLE</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | cb    | ref    | idx_branch_id,idx_contact_branch_id | idx_branch_id           | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituancrm</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.branch_id  |    </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |                                              |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|  </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">SIMPLE</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      | c     | eq_ref | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                             | </span><span style="color:#C678DD;--shiki-dark:#C678DD;">PRIMARY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                 | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">108</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     | </span><span style="color:#D19A66;--shiki-dark:#D19A66;">meituancrm</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.contact_id |    </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |                                              |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+-------------+-------+--------+-------------------------------------+-------------------------+---------+--------------------------+------+----------------------------------------------+</span></span></code></pre></div><p>从执行计划上看，mysql先查org_emp_info表扫描8849记录，再用索引idx_userid_status关联branch_user表，再用索引idx_branch_id关联contact_branch表，最后主键关联contact表。</p><p>rows返回的都非常少，看不到有什么异常情况。我们在看一下语句，发现后面有order by + limit组合，会不会是排序量太大搞的？于是我们简化SQL，去掉后面的order by 和 limit，看看到底用了多少记录来排序。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact c  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact_branch cb </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">contact_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   branch_user bu </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      org_emp_info oei </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_left</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2875</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_right</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &lt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10802</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">org_category</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> - </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">| </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">|   </span><span style="color:#D19A66;--shiki-dark:#D19A66;">778878</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----------+</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> row</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">19</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发现排序之前居然锁定了778878条记录，如果针对70万的结果集排序，将是灾难性的，怪不得这么慢，那我们能不能换个思路，先根据contact的created_time排序，再来join会不会比较快呢？</p><p>于是改造成下面的语句，也可以用straight_join来优化：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">position</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sex</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">office_phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">feature_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">birthday</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">creator_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_keyperson</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">giveup_reason</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_source</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> created_time,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> last_modified,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified_user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact c  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         contact_branch cb  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         branch_user bu        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">               1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">            2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)      </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            org_emp_info oei           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_left</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2875</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_right</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &lt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10802</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">org_category</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> - </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">            c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">contact_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      )    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   order by</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> desc</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>验证一下效果 预计在1ms内，提升了13000多倍！</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> rows</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">00</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre></div><p>本以为至此大工告成，但我们在前面的分析中漏了一个细节，先排序再join和先join再排序理论上开销是一样的，为何提升这么多是因为有一个limit！大致执行过程是：mysql先按索引排序得到前10条记录，然后再去join过滤，当发现不够10条的时候，再次去10条，再次join，这显然在内层join过滤的数据非常多的时候，将是灾难的，极端情况，内层一条数据都找不到，mysql还傻乎乎的每次取10条，几乎遍历了这个数据表！</p><p>用不同参数的SQL试验下：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   sql_no_cache   </span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">position</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sex</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">office_phone</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">feature_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">birthday</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">creator_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">is_keyperson</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">giveup_reason</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_source</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> created_time,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   from_unixtime(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> last_modified,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">last_modified_user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   contact c   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         contact_branch cb         </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         branch_user bu                     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">branch_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">status</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">               1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">            2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)                </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         inner join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            org_emp_info oei                           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">data_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> bu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_left</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2875</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">node_right</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &lt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2875</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                           </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">               and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> oei</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">org_category</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> - </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         where</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">            c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> cb</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">contact_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      )        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   order by</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      c</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">created_time</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> desc</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">Empty</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> set</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> min </span><span style="color:#D19A66;--shiki-dark:#D19A66;">18</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">99</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sec)</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2 min 18.99 sec！比之前的情况还糟糕很多。由于mysql的nested loop机制，遇到这种情况，基本是无法优化的。这条语句最终也只能交给应用系统去优化自己的逻辑了。</p><p><strong>通过这个例子我们可以看到，并不是所有语句都能优化，而往往我们优化时，由于SQL用例回归时落掉一些极端情况，会造成比原来还严重的后果。所以，第一：不要指望所有语句都能通过SQL优化，第二：不要过于自信，只针对具体case来优化，而忽略了更复杂的情况。</strong></p><h3 id="_3-4-联合索引" tabindex="-1"><a class="header-anchor" href="#_3-4-联合索引"><span>3.4 联合索引</span></a></h3><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   task </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   status</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> operator_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20839</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> operate_time</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1371169729</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> operate_time</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1371174603</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> type</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><p>错误方式：</p><p>给每个字段都加上索引。</p><p>正确方式：</p><p>根据最左匹配原则。对 status、operator_id、type、operate_time的建联合索引，其中status、operator_id、type的顺序可以颠倒，operate_time放在最后</p><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章"><span>参考文章</span></a></h2><p><a href="https://pdai.tech/md/db/sql-mysql/sql-mysql-index-improve-mt.html" target="_blank" rel="noopener noreferrer"><strong>大厂实践 - 美团: MySQL索引原理及慢查询优化</strong></a></p>`,64)]))}const e=a(p,[["render",r],["__file","mysql-x-optimize-slow.html.vue"]]),k=JSON.parse('{"path":"/posts/Database/MySQL/mysql-x-optimize-slow.html","title":"MySQL - 慢查询优化思路与案例","lang":"zh-CN","frontmatter":{"aliases":"MySQL - 慢查询优化思路与案例","tags":null,"cssclass":null,"source":null,"order":230,"category":["Mysql","数据库"],"created":"2024-02-22 10:49","updated":"2024-03-13 08:52","description":"MySQL - 慢查询优化思路与案例 1. 建索引的几大原则 最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，比如a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可...","head":[["meta",{"property":"og:url","content":"https://mrjackc.github.io/posts/Database/MySQL/mysql-x-optimize-slow.html"}],["meta",{"property":"og:site_name","content":"mrjason’s Blog"}],["meta",{"property":"og:title","content":"MySQL - 慢查询优化思路与案例"}],["meta",{"property":"og:description","content":"MySQL - 慢查询优化思路与案例 1. 建索引的几大原则 最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，比如a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-21T07:03:09.000Z"}],["meta",{"property":"article:author","content":"MrJason"}],["meta",{"property":"article:modified_time","content":"2024-10-21T07:03:09.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL - 慢查询优化思路与案例\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-21T07:03:09.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"MrJason\\",\\"url\\":\\"https://mrjackc.github.io\\"}]}"]]},"headers":[{"level":2,"title":"1. 建索引的几大原则","slug":"_1-建索引的几大原则","link":"#_1-建索引的几大原则","children":[]},{"level":2,"title":"2. 优化步骤- explain命令","slug":"_2-优化步骤-explain命令","link":"#_2-优化步骤-explain命令","children":[]},{"level":2,"title":"3. 慢查询优化案例","slug":"_3-慢查询优化案例","link":"#_3-慢查询优化案例","children":[{"level":3,"title":"3.1 复杂语句写法（优化sql）","slug":"_3-1-复杂语句写法-优化sql","link":"#_3-1-复杂语句写法-优化sql","children":[]},{"level":3,"title":"3.2 明确应用场景（区分度低加索引）","slug":"_3-2-明确应用场景-区分度低加索引","link":"#_3-2-明确应用场景-区分度低加索引","children":[]},{"level":3,"title":"3.3 无法优化的语句(对大数据量排序导致的问题)","slug":"_3-3-无法优化的语句-对大数据量排序导致的问题","link":"#_3-3-无法优化的语句-对大数据量排序导致的问题","children":[]},{"level":3,"title":"3.4 联合索引","slug":"_3-4-联合索引","link":"#_3-4-联合索引","children":[]}]},{"level":2,"title":"参考文章","slug":"参考文章","link":"#参考文章","children":[]}],"git":{"createdTime":1729494189000,"updatedTime":1729494189000,"contributors":[{"name":"MrJason","email":"845886914@qq.com","commits":1}]},"readingTime":{"minutes":11.62,"words":3486},"filePathRelative":"posts/Database/MySQL/mysql-x-optimize-slow.md","localizedDate":"2024年10月21日","excerpt":"\\n<h2>1. 建索引的几大原则</h2>\\n<ol>\\n<li>最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(<code>&gt;</code>、<code>&lt;</code>、<code>between</code>、<code>like</code>)就停止匹配，比如<code>a = 1 and b = 2 and c &gt; 3 and d = 4</code> 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</li>\\n<li>=和in可以乱序，比如<code>a = 1 and b = 2 and c = 3</code> 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式</li>\\n<li>尽量选择区分度高的列作为索引，区分度的公式是<code>count(distinct col)/count(*)</code>，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录。</li>\\n<li>索引列不能参与计算，保持列“干净”，比如<code>from_unixtime(create_time) = ’2014-05-29’</code>就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’)。</li>\\n<li>尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。</li>\\n</ol>","autoDesc":true}');export{e as comp,k as data};
