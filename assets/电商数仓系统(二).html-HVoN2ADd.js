import{_ as a,c as n,a as i,o as l}from"./app-BOcQBfH9.js";const p={};function r(e,s){return l(),n("div",null,s[0]||(s[0]=[i(`<h1 id="电商数仓系统-二" tabindex="-1"><a class="header-anchor" href="#电商数仓系统-二"><span>电商数仓系统(二)</span></a></h1><hr><p>##一、DWS/DWT准备</p><h3 id="_1-1-业务术语" tabindex="-1"><a class="header-anchor" href="#_1-1-业务术语"><span>1.1 业务术语</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、统计流量相关的需求：使用设备id，如统计活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    b、统计业务相关的指标，使用用户id，如统计下单数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--2. 新增用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、如果一个用户首次打开某APP，那这个用户定义为新增用户；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    b、卸载再安装的设备，不会被算作一次新增。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    c、新增用户包括日新增用户、周新增用户、月新增用户。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、打开应用的用户即为活跃用户，不考虑用户的使用情况。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、每天一台设备打开多次会被计为一个活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 周活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、某个自然周（月）内启动过应用的用户；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、该周（月）内的多次启动只记一个活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 月活跃率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、当月活跃用户 / 总用户数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 6. 沉默用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、用户仅在安装当天（次日）启动一次，后续时间无再启动行为</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、指标可以反映新增用户质量和用户与APP的匹配程度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 7. 版本分布</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、不同版本的周内各天新增用户数，活跃用户数和启动次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、判断APP各个版本之间的优劣和用户行为习惯</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 8. 本周回流用</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、上周未启动应用, 本周启动了应用的用户，且不是本周新增用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 9. 连续n周</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续n周, 每周至少启动一次</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 10. 忠诚用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、连续活跃5周以上的用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 10. 连续活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续两周以上的活跃用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 11. 近期流失用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、连续n(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-4周)周没有启动应用的用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 12. 留存用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、例如，5月份新增用户200，这200人启动情况：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  6月份：启动人数为100人，5月份新增用户一个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  7月份：启动人数为80人，5月份新增用户二个月后的留存率是40%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  8月份：启动人数为100人，5月份新增用户三个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	c、留存用户一般是统计留存率，同时必须有两个参数：哪个月份的几月的留存率</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 13. 用户新鲜度</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、每天启动应用的新老用户比例</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、用户新鲜度 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 新用户数量 / 当日活跃用户数 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 14. 单次使用时长</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、每次启动使用的时间长度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 15. 日使用时长</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	a、累计一天内的使用时间长度。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 16. 启动次数计算标准</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;背景&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：IOS平台应用退到后台，是真的退出应用，后台会释放资源</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          Android平台应用退到后台，并不会立即退出应用，因为应用和应用之间存在互相唤醒的问题。</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;统计方式&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        IOS平台应用退到后台就算一次独立的启动</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        Android平台我们规定，两次启动之间的间隔小于30秒，被计算一次启动</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-系统函数" tabindex="-1"><a class="header-anchor" href="#_1-2-系统函数"><span>1.2 系统函数</span></a></h3><h4 id="_1-2-1-celloect-set" tabindex="-1"><a class="header-anchor" href="#_1-2-1-celloect-set"><span>1.2.1 celloect_set</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 作用：将一列数据收集变成一行数据,返回一个数组</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 区别：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      collect_set : 会去重</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      collect_list: 不会去重</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--  3. 案例：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 数据准备：</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">          drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">          create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> stud</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#C678DD;--shiki-dark:#C678DD;">name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, area string, course string, score </span><span style="color:#C678DD;--shiki-dark:#C678DD;">int</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 插入数据：</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;zhang3&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;math&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">88</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;li4&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;math&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">99</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;wang5&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sh&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">92</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;zhao6&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sh&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">54</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">values</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;tian7&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;bj&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;chinese&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">91</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 查询数据：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course , collect_set(area),</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">avg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(score) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            &#39;打印结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            course	_c1	_c2</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            chinese	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;sh&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	79</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            math	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	93</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course ,collset_list(area),</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">avg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(score) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stud </span><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> course</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            &#39;打印结果&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            course	_c1	_c2</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            math	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;bj&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	93</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">5</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            chinese	</span><span style="color:#E06C75;--shiki-dark:#E06C75;">[&quot;sh&quot;,&quot;sh&quot;,&quot;bj&quot;]</span><span style="color:#D19A66;--shiki-dark:#D19A66;">	79</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-nvl" tabindex="-1"><a class="header-anchor" href="#_1-2-2-nvl"><span>1.2.2 nvl</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 函数：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     nvl（表达式1，表达式2）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 返回值：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      只能传递两个参数，从左往右找，找到一个非null的值，就返回，如果两个表示式都为null，则返回null</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 参数说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.表达式类型：数字型、字符型和日期型</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.两个表达式的数据类型必须相同</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 4. 案例：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lianzp&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">); </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">结果：</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       报错：The </span><span style="color:#C678DD;--shiki-dark:#C678DD;">first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> seconds</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> arguments of </span><span style="color:#C678DD;--shiki-dark:#C678DD;">function</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> NLV should have the same </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;lianzp&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">+</span><span style="color:#D19A66;--shiki-dark:#D19A66;">10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">; </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 结果为null</span></span></code></pre></div><h4 id="_1-2-3-coalesce" tabindex="-1"><a class="header-anchor" href="#_1-2-3-coalesce"><span>1.2.3 coalesce</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1.  coalesce(a1, a2, ...) </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2.  作用：- Returns the first non-null argument，返回第一不为null的值</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3.  和nvl主要区别是：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       a、可以有多个参数</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 要求所有参数的类型保持一致：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       The expressions </span><span style="color:#C678DD;--shiki-dark:#C678DD;">after</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COALESCE should all have the same </span><span style="color:#C678DD;--shiki-dark:#C678DD;">type</span></span></code></pre></div><h4 id="_1-2-4日期函数-重要" tabindex="-1"><a class="header-anchor" href="#_1-2-4日期函数-重要"><span>1.2.4日期函数(重要)</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. date_format函数（根据格式整理日期）</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. date_add函数（加减日期）</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">13</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      hive (gmall)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">06</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">15</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. next_day(start_date, day_of_week) </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 返回当期日期的下一个周几。</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. day_of_week：可选参数：</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 可以写前面两个字母，实际开发中，周一和周末使用频率最高</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      	星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    Returns</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> which </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> later than </span><span style="color:#C678DD;--shiki-dark:#C678DD;">start_date</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> named </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> indicated.</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 需求：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          a、需求1：返回下一个周一</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">             select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">13</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          b、需求2：返回本周末：求出下一个周一再减1天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">12</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          c、需求3：返回上个周日，求出下一个周一再减8天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">             select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">05</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. last_day(date) </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     返回当前日期的最后一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     Returns</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">last</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> day</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> of the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">month</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> which the </span><span style="color:#C678DD;--shiki-dark:#C678DD;">date</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> belongs </span><span style="color:#C678DD;--shiki-dark:#C678DD;">to</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> last_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-07-07&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">); </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 当前日期：current_date</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> current_day;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      =&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2020</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">07</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、dws-dwt层" tabindex="-1"><a class="header-anchor" href="#二、dws-dwt层"><span>二、DWS/DWT层</span></a></h2><h3 id="_2-1-dws-dwt思想" tabindex="-1"><a class="header-anchor" href="#_2-1-dws-dwt思想"><span>2.1 DWS/DWT思想</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. dwd层和dws/dwt的区别？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     	DWD层建表时不要考虑用户的需求，而dws和dwd层，以用户需求为驱动，统计各个维度的相关指标；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. dws和dwt都是建宽表，建宽表的目的是优化查询,减少重复查询的步骤。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 用户后续的需求是什么样的呢？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       主要是报表，体现的指标有个数、次数、金额等指标。</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;体现的方式&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：维度 + 时间 + 指标</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;案例&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           a、地区维度：北京地区今天的下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           b、商品维度：1号商品今天下单数量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 建宽表的思路：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 一个维度作为一个宽表；</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 字段：以维度作为关键字 + 和该维度相关的所有事实表的度量值</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. DWS和DWT的主要区别：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dws的数据来源于DWD层，站在维度的角度，看事实表的度量值，统计每个主题当天的行为</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt的主要数据来源dws，站在维度的角度，看事实表的开始时间、结束时间、累积到现在的度量值，累积一段时间的度量值，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       统计每个主题累计行为，如统计最近7天的下单金额。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 6. 宽表是应对一些常用的需求，并不是所有的需求都会包含进来，如果一些特殊需求，可以去到dwd层获取数据</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-用户行为数据" tabindex="-1"><a class="header-anchor" href="#_2-2-用户行为数据"><span>2.2 用户行为数据</span></a></h3><h4 id="_2-2-1-每日设备dws层" tabindex="-1"><a class="header-anchor" href="#_2-2-1-每日设备dws层"><span>2.2.1 每日设备DWS层</span></a></h4><ul><li>建表语句</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`mid_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`brand\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`model\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`page_stats\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">page_id:string,page_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;页面访问统计&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">partitioned </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_uv_detail_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>加载数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_start_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        model,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,brand,model</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_page_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            model,      </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;page_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,page_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;page_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,page_count)) page_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                model,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                page_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">                count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) page_count     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_page_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  mid_id ,brand,model,page_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  mid_id ,brand,model</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        page_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_page_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-设备主题dwt层" tabindex="-1"><a class="header-anchor" href="#_2-2-2-设备主题dwt层"><span>2.2.2 设备主题DWT层</span></a></h4><ul><li>建表语句</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`mid_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`brand\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`model\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_date_first\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次活跃时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_date_last\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次活跃时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日活跃次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积活跃天数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_uv_topic&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">brand</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic old </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        brand , </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        model, </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-业务数据" tabindex="-1"><a class="header-anchor" href="#_2-3-业务数据"><span>2.3 业务数据</span></a></h3><h4 id="_2-3-1-会员行为" tabindex="-1"><a class="header-anchor" href="#_2-3-1-会员行为"><span>2.3.1 会员行为</span></a></h4><h5 id="_2-3-1-1-会员dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-1-1-会员dws层"><span>2.3.1.1 会员DWS层</span></a></h5><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 建表过程：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;准备&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：  事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：找到和用户维度相关的所有事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: 找到这些事实表的所有度量值字段：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：维度主键 + 第二步获取的字段作为dws宽表的字段。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 备注：理论上上述所有事实表都需要进行统计，但是在本案例中，只统计了订单、订单详情表、支付，加购物车四个事实表的数据。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 数据的来源：来自于DWD层</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 表中的数据说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是分区表，每个分区为当天的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 每一行数据代表一个用户当天的行为</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 根据建表字段，确定每个字段来自于哪张表中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 5. 数据存储格式：列式存储 + lzo压缩</span></span></code></pre></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户 id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;登录次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount    </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_detail_stats </span><span style="color:#C678DD;--shiki-dark:#C678DD;">array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">sku_id:string,sku_num:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单明细统计&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日用户行为&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">\`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_user_action_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>第一步：确定各个字段来自哪个表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">user_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户 id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--从dwd_start_log获取 </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;登录次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--从dwd_start_log获取</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_action_log</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount    </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--dwd_fact_order_info </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_detail_stats </span><span style="color:#C678DD;--shiki-dark:#C678DD;">array</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">struct</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">sku_id:string,sku_num:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount:</span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comm</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	  -- dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	 说明：</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 加入购车的数据，需要去启动日志中获取，因为加购事实表是每天一个快照，不保留中间操作的过程，所以去到日志action</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	      	获取，点击一次加购物车操作，记一次加入购物车的次数</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 用户登录次数，从启动日志中获取，启动一次算作今天登录一次，但是要注意有些登录不是会员，所以需要过滤user_id为</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	         null的数据；</span></span></code></pre></div><ul><li>第二步：确定dws一行数据代表什么意思？</li></ul><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>用户行为表的一行数据代表：一个用户今天登陆次数、加购物车数量、下单数量、下单金额等数据</span></span></code></pre></div><ul><li>第三步：确定dwd层所有相关表的同步策略</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_start_log&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：每日新增数据</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_action_log&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：每日新增数据</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_order_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：事务型</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_order_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：事务型</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;dwd_fact_payment_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">:事务型</span></span></code></pre></div><ul><li>第四步：从各个表中获取对应的字段</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 1. 获取用户id和登录次数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		  user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	---------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 2. 获取加购物车的次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		 select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id		</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  ------------------------------------------ </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 3. 获取下单的次数和下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_total_amount)  order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   ------------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 4. 获取支付的金额和支付次数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		 user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		 count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		 sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	 group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   ----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 5. 获取下单明细</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_num&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_num,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_amount&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount))order_detail_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			  user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			  sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  cast</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> demical(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		   group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id,sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	   )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	   group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>第五步：组装以后插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_start_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_action_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id        </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_order_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_total_amount)  order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tmp_payment_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   tmp_order_detail </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            collect_set(named_struct(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_id&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_id,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;sku_num&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,sku_num,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_count&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;order_amount&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount)) order_detail_stats</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              user_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">              sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              cast</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">           group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id,sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       )tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        login_count ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)   ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        nvl(payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_detail_stats       </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_start_log </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action_log </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_payment_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_payment_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order_detail </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_start_log</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order_detail</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-1-2-会员dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-1-2-会员dwt层"><span>2.3.1.2 会员DWT层</span></a></h5><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt和dws层的字段基本是一一对应的。</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dws是当天的数据，dwt是累积数据，累积涉及到时间，比如累积7天，累积3天</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. dwt和dws的维度字段，我们也可以直接放到表中，后续统计需求可以用到。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. dwt数据说明：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是维度全量表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 数据源来自于dws层</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">     3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 不是分区表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 4. 如何维护dwt表，即如何向这个全量表中插入数据？</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. dwt的数据每天都需要进行更新；</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 更新涉及到新数据和老数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 更新方式：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       a、取累积时间周期的数据；</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       b、如果是累积字段，使用聚合函数求值</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       c、如果非累积字段，使用判断语句求当天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       d、然后新旧数据今天合并，由于旧数据不是分区数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         那么累积数据直接使用新表累积值，而非累积字段，采用更新的方式</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户主题宽表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_user_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>分析</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	旧表：dwt前一天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   新表：从dws层获取的累积30天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    user_id string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--如果旧表中有登录时间就使用旧表中的时间，否则使用当天时间</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次登录时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表中今天的登入次数大于0，那么末次登录时间使用今天时间，否则使用旧时间</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表中的登入次数大于0，那么旧表中数据 + 1 </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日登录天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 使用新表中累积计算数据，如果为null，则选择0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果旧表中首次下单时间为null且新表中下单次数大于0，那么使用今天时间，否则使用旧表数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次下单时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 如果新表的下单数据大于0，则使用当天时间，否则使用旧表数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 将旧表下单数据和新表下单次数直接相加</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--将旧表下单金额和新表下单金额相加</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--直接使用新表数据，如果新表数据为null，则使用0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--直接使用新表数据，如果新表数据为null，则使用0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_first string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_date_last string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;末次支付时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日支付金额&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>装载数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;"> insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is not null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_first</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> is</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> null</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_first</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> &gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_date_last</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dwt_user_topic old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   full join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           user_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,login_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天登录次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天加入购物车次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天支付次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--当天支付金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--累积30天登录次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_last_30d_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_last_30d_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">           sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_last_30d_amount</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--最近30日下单金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(dt , -</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">       group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   )new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-商品行为" tabindex="-1"><a class="header-anchor" href="#_2-3-2-商品行为"><span>2.3.2 商品行为</span></a></h4><h5 id="_2-3-2-1-商品dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-2-1-商品dws层"><span>2.3.2.1 商品DWS层</span></a></h5><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 解析：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表的字段如何创建</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;准备&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：  事实表：订单、订单详情、优惠券领用、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：找到和商品这个维度相关的所有事实表：订单详情、支付、退款、收藏、加购物车、评价</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：获取上述事实表的并取其度量值</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：将商品维度id + 第二步度量值的字段作为dws层的字段，创建商品行为的dws层表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 如何向表中插入数据？</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第一步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：根据dws层表的字段，确定每个字段来自于哪个表</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第二步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：确定第一步中所有表的同步策略，确定表中存储的数据是什么及每行数据存储的是什么</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;第三步&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：一个一个字段来获取最后进行合并</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表保存什么数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 表中每行数据是什么</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 存储格式</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 分区表，每个分区保留当前最新的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">       2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 列式存储 + lzo压缩</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日商品行为&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">\`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_sku_action_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>分析过程</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">==================================================</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：订单详情事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单的创建时间为分区数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有的下单的信息</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	   sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单次数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) order_num, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单件数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(original_amount_d) order_amount </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--被下单金额	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-------------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：支付事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单支付时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有的支付信息</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 说明： 有一种情况，昨天晚上下单，但是今天才支付,那么下单的sku_id不在支付中，这样可能会导致数据丢失</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	payment_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 	    </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">				order_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 1. 相关表：退款事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，退款时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：一个分区保存当天所有退款的数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		refund_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		      sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			  sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount		  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dwd_fact_order_refund_info </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 1. 相关表：加购车</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：周期型快照事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每天一个快照</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_cart_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> create_time </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   -- 1. 相关表：收藏表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：周期型快照事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每天一个快照</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">			sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">			count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_favor_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> create_time </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">			group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-----------------------------------------------</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     -- 1. 相关表：评价事实表</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">      2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 同步策略：事务型事实表，以订单支付时间为分区</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 保存的数据：每个分区保留当天的评价数据</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	  4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 相关字段如下：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1201&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_good_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1202&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1203&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">		sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1204&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_default_count,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_comment_info </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">		group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) order_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) order_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_payment </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(sku_num) payment_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_refund </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) refund_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_refund_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_cart </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),tmp_favor </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_action_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> user_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> action_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;favor_add&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_appraise </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1201&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_good_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1202&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1203&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1204&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_comment_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(favor_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_good_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_mid_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_bad_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_default_count)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_payment</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count        </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_refund</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_cart</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        favor_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_good_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_mid_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_favor</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_num,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_amount,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        appraise_default_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_appraise</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)tmp</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-2-2-商品dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-2-2-商品dwt层"><span>2.3.2.2 商品DWT层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    spu_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu_id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_last_30d_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_count   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近三十日退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_num </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款件数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积退款金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被加入购物车次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_last_30d_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积被收藏次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_last_30d_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30日默认评价数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_good_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积好评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_mid_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积中评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_bad_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积差评数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    appraise_default_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积默认评价数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品主题宽表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_sku_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    sku_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">spu_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_num</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">refund_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">cart_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">favor_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_good_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_mid_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_bad_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) + nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">appraise_default_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">dwt_sku_topic old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        sku_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_num ,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ))  order_num, </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) order_amount ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_num,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) payment_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_num,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_num,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,refund_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) refund_amount,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,cart_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) cart_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,favor_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) favor_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_good_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_good_count,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_mid_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ) ) appraise_mid_count ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_bad_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_bad_count,  </span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,appraise_default_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> )) appraise_default_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count30 ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_num) order_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_num) payment_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_count) refund_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_num) refund_num30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(refund_amount) refund_amount30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count) cart_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(favor_count) favor_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_good_count) appraise_good_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_mid_count) appraise_mid_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_bad_count) appraise_bad_count30,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(appraise_default_count) appraise_default_count30 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add (</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, -</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id    </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> * </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_sku_info </span><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) sku_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> sku_info</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-4-活动统计" tabindex="-1"><a class="header-anchor" href="#_2-3-4-活动统计"><span>2.3.4 活动统计</span></a></h4><h5 id="_2-3-4-1-活动dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-4-1-活动dws层"><span>2.3.4.1 活动DWS层</span></a></h5><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`activity_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`activity_type\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动类型&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`start_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;开始时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`end_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;结束时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`create_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`display_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`display_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_activity_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>插入数据</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        activity_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> activity_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> activity_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_display </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        item activity_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) display_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_display_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item_type</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;activity_id&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> item</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_activity </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_activity_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_activity_info_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_op</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_display </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_activity </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_display</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_activity</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-4-2-活动dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-4-2-活动dwt层"><span>2.3.4.2 活动DWT层</span></a></h5><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`activity_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`activity_type\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动类型&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`start_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;开始时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`end_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;结束时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`create_time\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`display_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`display_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积曝光次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;累积支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活动主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_activity_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">activity_type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">start_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">end_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">create_time</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">display_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)+nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_activity_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_activity_info_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-5-地区统计" tabindex="-1"><a class="header-anchor" href="#_2-3-5-地区统计"><span>2.3.5 地区统计</span></a></h4><h5 id="_2-3-5-1-地区dws层" tabindex="-1"><a class="header-anchor" href="#_2-3-5-1-地区dws层"><span>2.3.5.1 地区DWS层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`id\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`province_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`area_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`iso_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_count\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">20</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日地区信息表&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PARTITIONED </span><span style="color:#C678DD;--shiki-dark:#C678DD;">BY</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">\`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string)</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">stored </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> parquet</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dws/dws_area_stats_daycount/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_login </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        area_code,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) login_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_start_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> area_code</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        province_id,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(create_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_time,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM-dd&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,final_total_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> or</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> province_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_login</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_base_province pro</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_login </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_login</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">left join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_op </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> pro</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_op</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-5-2-地区dwt层" tabindex="-1"><a class="header-anchor" href="#_2-3-5-2-地区dwt层"><span>2.3.5.2 地区DWT层</span></a></h5><ul><li>建表语句</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`id\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`province_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`area_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`iso_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_day_count\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_last_30d_count\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_last_30d_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_last_30d_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_last_30d_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_last_30d_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近30天支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/dwt/dwt_area_topic/&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tblproperties (</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;parquet.compression&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;lzo&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">province_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">area_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">iso_code</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">region_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">login_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_day_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_day_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_day_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    nvl(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">payment_last_30d_amount</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        *</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)old</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">full outer join</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        region_name,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,login_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) login_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,order_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_day_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_count,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,payment_amount,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_day_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_count) login_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_area_stats_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">30</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> id,province_name,area_code,iso_code,region_id,region_name</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)new</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> old</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">new</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-脚本"><span>2.4 脚本</span></a></h3><h4 id="_2-4-1-dws脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-1-dws脚本"><span>2.4.1 DWS脚本</span></a></h4><ol><li>在/home/atguigu/bin目录下创建脚本dwd_to_dws.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dwd_to_dws.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">\`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F\`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_start as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        model,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id,brand,model</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_page as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        model,        </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        collect_set(named_struct(&#39;page_id&#39;,page_id,&#39;page_count&#39;,page_count)) page_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            brand,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            model,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            page_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            count(*) page_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_page_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id,brand,model,page_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id,brand,model</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.mid_id,tmp_page.mid_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.brand,tmp_page.brand),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_start.model,tmp_page.model),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_start.login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_page.page_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_start </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join tmp_page</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on tmp_start.mid_id=tmp_page.mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and tmp_start.brand=tmp_page.brand</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and tmp_start.model=tmp_page.model;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_login as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cart as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_total_amount) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_payment as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_payment_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order_detail as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        collect_set(named_struct(&#39;sku_id&#39;,sku_id,&#39;sku_num&#39;,sku_num,&#39;order_count&#39;,order_count,&#39;order_amount&#39;,order_amount)) order_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            sum(sku_num) sku_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            cast(sum(final_amount_d) as decimal(20,2)) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by user_id,sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_login.user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(cart_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(payment_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_stats</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_login</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_cart on tmp_login.user_id=tmp_cart.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_order on tmp_login.user_id=tmp_order.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_payment on tmp_login.user_id=tmp_payment.user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left outer join tmp_order_detail on tmp_login.user_id=tmp_order_detail.user_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(sku_num) order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_amount_d) order_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_payment as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(sku_num) payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(final_amount_d) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_detail</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and order_id in</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_refund as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_num) refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_amount) refund_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_refund_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cart as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;cart_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),tmp_favor as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) favor_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_action_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and user_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and action_id=&#39;favor_add&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_appraise as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1201&#39;,1,0)) appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1202&#39;,1,0)) appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1203&#39;,1,0)) appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(appraise=&#39;1204&#39;,1,0)) appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_comment_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(payment_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_num),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(refund_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(cart_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(favor_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_good_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_mid_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_bad_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(appraise_default_count)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_order</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_payment</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count        </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_refund</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_cart</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_favor</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    union all</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        0 favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_default_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_appraise</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by sku_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_login as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) login_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_start_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by area_code</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_op as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        province_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by province_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_area_stats_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    pro.region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_login.login_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.payment_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_base_province pro</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_login on pro.area_code=tmp_login.area_code</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_op on pro.id=tmp_op.province_id;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_op as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        activity_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,final_total_amount,0)) payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where (dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; or dt=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and activity_id is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by activity_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_display as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        item activity_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) display_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_display_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and item_type=&#39;activity_id&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by item</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_activity as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_activity_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_activity_info_daycount partition(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(tmp_op.activity_id,tmp_display.activity_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.activity_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.activity_type,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.start_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.end_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_activity.create_time,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_display.display_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_op.payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_op</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join tmp_display on tmp_op.activity_id=tmp_display.activity_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join tmp_activity on nvl(tmp_op.activity_id,tmp_display.activity_id)=tmp_activity.id;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-2-dwt脚本" tabindex="-1"><a class="header-anchor" href="#_2-4-2-dwt脚本"><span>2.4.2 DWT脚本</span></a></h4><ol><li>在/home/atguigu/bin目录下创建脚本dws_to_dwt.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dws_to_dwt.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">\`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F\`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.mid_id,old.mid_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.model,old.model),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.brand,old.brand),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.mid_id is null,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.mid_id is not null,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.mid_id is not null, new.login_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.login_count,0)+if(new.login_count&gt;0,1,0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.mid_id=new.mid_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.user_id,old.user_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.login_date_first is null and new.login_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.login_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.login_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.login_count,0)+if(new.login_count&gt;0,1,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.order_date_first is null and new.order_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.order_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.order_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.order_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_count,0)+nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_amount,0)+nvl(new.order_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(old.payment_date_first is null and new.payment_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.payment_date_first),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(new.payment_count&gt;0,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,old.payment_date_last),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_count,0)+nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_amount,0)+nvl(new.payment_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_amount,0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">\${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,login_count,0)) login_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_count,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0)) order_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0)) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0)) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(login_count&gt;0,1,0)) login_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add( &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by user_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.user_id=new.user_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.sku_id,old.sku_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_info.spu_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_count,0) + nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_num,0) + nvl(new.order_num,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.order_amount,0) + nvl(new.order_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_count,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_num,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.payment_amount,0) + nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_num30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.refund_amount30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_count,0) + nvl(new.refund_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_num,0) + nvl(new.refund_num,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.refund_amount,0) + nvl(new.refund_amount,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.cart_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.cart_count,0) + nvl(new.cart_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.favor_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.favor_count,0) + nvl(new.favor_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_good_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_mid_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_bad_count30,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.appraise_default_count30,0)  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_good_count,0) + nvl(new.appraise_good_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_mid_count,0) + nvl(new.appraise_mid_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_bad_count,0) + nvl(new.appraise_bad_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.appraise_default_count,0) + nvl(new.appraise_default_count,0) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        spu_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_amount  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        refund_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_last_30d_default_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_good_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_mid_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_bad_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        appraise_default_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;, order_count,0 )) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_num ,0 ))  order_num, </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0 )) order_amount ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0 )) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_num,0 )) payment_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0 )) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_count,0 )) refund_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_num,0 )) refund_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,refund_amount,0 )) refund_amount,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,cart_count,0 )) cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,favor_count,0 )) favor_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_good_count,0 )) appraise_good_count,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_mid_count,0 ) ) appraise_mid_count ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_bad_count,0 )) appraise_bad_count,  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,appraise_default_count,0 )) appraise_default_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_count30 ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_num) order_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_num) payment_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_count) refund_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_num) refund_num30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(refund_amount) refund_amount30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(cart_count) cart_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(favor_count) favor_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_good_count) appraise_good_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_mid_count) appraise_mid_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_bad_count) appraise_bad_count30,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(appraise_default_count) appraise_default_count30 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt &gt;= date_add (&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;, -30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by sku_id    </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on new.sku_id = old.sku_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(select * from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_sku_info where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;) sku_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on nvl(new.sku_id,old.sku_id)= sku_info.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_activity_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.id,old.id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.activity_name,old.activity_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.activity_type,old.activity_type),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.start_time,old.start_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.end_time,old.end_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.create_time,old.create_time),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.display_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.display_count,0)+nvl(old.display_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_count,0)+nvl(old.order_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_amount,0.0)+nvl(old.order_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_count,0)+nvl(old.payment_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_amount,0.0)+nvl(old.payment_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_activity_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_activity_info_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.id=new.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert overwrite table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.id,new.id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.province_name,new.province_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.area_code,new.area_code),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.iso_code,new.iso_code),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.region_id,new.region_id),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(old.region_name,new.region_name),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.login_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_day_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.order_last_30d_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_day_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_day_amount,0.0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_count,0),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    nvl(new.payment_last_30d_amount,0.0)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        *</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)old</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">full outer join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,login_count,0)) login_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_count,0)) order_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,order_amount,0.0)) order_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_count,0)) payment_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,payment_amount,0.0)) payment_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(login_count) login_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_amount) order_last_30d_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_last_30d_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_last_30d_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_area_stats_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-30)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by id,province_name,area_code,iso_code,region_id,region_name</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)new</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on old.id=new.id;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三、数仓搭建ads层" tabindex="-1"><a class="header-anchor" href="#三、数仓搭建ads层"><span>三、数仓搭建ADS层</span></a></h2><h3 id="_3-0-ads层思想" tabindex="-1"><a class="header-anchor" href="#_3-0-ads层思想"><span>3.0 ADS层思想</span></a></h3><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 解题思路：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：分析指标，明确指标具体的含义，不可有歧义</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：确定数据来源，寻找数据的方式，先从dwt层 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd 层依次往回找，找到能满足需求的表</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三表: 找步骤2表的方式：找相关主题的表，因为在ads层的统计指标，也是按照维度 + 时间 + 指标的方式今天统计。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 统计流量，使用用户行为数据，统计和业务相关的指标，使用业务数据。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 老生常谈：知道每一张表中存储了什么数据。每行数据代表什么意思。关键、关键、关键。</span></span></code></pre></div><h3 id="_3-1-设备主题" tabindex="-1"><a class="header-anchor" href="#_3-1-设备主题"><span>3.1 设备主题</span></a></h3><h4 id="_3-1-1-活跃设备数" tabindex="-1"><a class="header-anchor" href="#_3-1-1-活跃设备数"><span>3.1.1 活跃设备数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是活跃设备</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      a、打开应用的用户即为活跃用户，不考虑用户的使用情况。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  b、每天一台设备打开多次会被计为一个活跃用户</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 需求：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;日活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当日活跃的设备数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;周活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当周活跃的设备数,在这一周内，多次活跃也计算为1次</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;月活&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：当月活跃的设备数,在这一月内，多次活跃也计算为1次</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当日用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wk_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当周用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`mn_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当月用户数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`is_weekend\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y,N是否是周末,用于得到本周最终结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`is_monthend\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y,N是否是月末,用于得到本月最终结果&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃设备数&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_uv_count/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_uv_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    wk_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    mn_count ,       </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;N&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  is_weekend ,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">last_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;Y&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;N&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)    is_monthend</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">         &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_day_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ))  day_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last  </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) wk_count,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  mn_count     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-2-每日新增设备" tabindex="-1"><a class="header-anchor" href="#_3-1-2-每日新增设备"><span>3.1.2 每日新增设备</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`create_date\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`new_mid_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">   BIGINT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增设备数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日新增设备信息数量&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_new_mid_count/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_new_mid_count </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-1-3-留存率" tabindex="-1"><a class="header-anchor" href="#_3-1-3-留存率"><span>3.1.3 留存率</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是留存率？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    a、某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	b、例如，5月份新增用户200，这200人启动情况：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  6月份：启动人数为100人，5月份新增用户一个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  7月份：启动人数为80人，5月份新增用户二个月后的留存率是40%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	  8月份：启动人数为100人，5月份新增用户三个月后的留存率是50%</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	c、留存用户一般是统计留存率，同时必须有两个参数：哪个月份的几月的留存率</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 本案例需要统计的指标是：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    计算每天的1、</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">、3日留存率</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 实现方式</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第一步：统计当天所有的活跃用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第二步：统计昨天的1日留存率，求出昨天的新用户但是今天上线的用户/昨天的新用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第三步：统计前天的2日留存率，求出前天的新用户但是今天上线的用户/前天的新用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    所以需要统计的数量有：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 昨天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 昨天的新用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">    4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 前天的新用户</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>![image-20200708203545115](<a href="https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic" target="_blank" rel="noopener noreferrer">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</a> GO/20200709012005.png)</p><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`stat_date\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`create_date\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       string  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;设备新增日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`retention_day\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">     int</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;截止当前日期留存天数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`retention_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">    bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;留存数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`new_mid_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">     bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;设备新增数量&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     \`retention_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">   decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;留存率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日用户留存情况&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_retention_day_rate/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">             &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  1day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 昨天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_1day ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--昨天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  2day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 前天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_2day ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  3day_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 大前天的新用户</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">             sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) new_3day </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--大前天的新用户但是今天上线的用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_retention_day_rate</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_1day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          1day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_1day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> /1day_count retention_ratio</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_2day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          2day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_2day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / 2day_count retention_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    union all</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">          &#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  stat_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-26&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) create_date,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增日期</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">          3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> retention_day,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--截止当前日期留存天数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_3day retention_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          3day_count new_mid_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--设备新增数量</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          new_3day * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / 3day_count retention_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--留存率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  tmp_uv_topic</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-4-沉默用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-4-沉默用户数"><span>3.1.4 沉默用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是沉默用户？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   只在安装当天启动过，且启动时间是在7天前</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现过程</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 统计首次活跃时间 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 最后末次活跃时间，且最后活跃时间在7天前的用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`silent_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;沉默设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_silent_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_silent_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">login_date_last</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre></div><h4 id="_3-1-5-本周回流用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-5-本周回流用户数"><span>3.1.5 本周回流用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是本周回流用户？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   上周未活跃，本周活跃的设备，且不是本周新增设备</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现步骤：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：获取本周活跃的用户且不是本周新增的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：获取上周的活跃的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三步：第一步获取的用户减少第二步获取的用户就是本周回流的用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wk_dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期所在周&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wastage_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;回流设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_back_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_back_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) wk_dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">not</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">             mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)         </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-6-流失用户" tabindex="-1"><a class="header-anchor" href="#_3-1-6-流失用户"><span>3.1.6 流失用户</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是流失用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	最近7天未活跃的设备</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 实现步骤</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    第一步：获取最近活跃时间小于7天</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wastage_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;流失设备数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_wastage_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_wastage_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">         &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">         count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_uv_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><h4 id="_3-1-7-最近连续三周活跃用户数" tabindex="-1"><a class="header-anchor" href="#_3-1-7-最近连续三周活跃用户数"><span>3.1.7 最近连续三周活跃用户数</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 实现步骤</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步: 从dws层获取前一周、前两周以及当前周的所有活跃的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步： 然后进行内连接，能连接上的，则说明这连续的3周都活跃了，最后按照用户进行分组去重后求count。</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_wk_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_wk_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期,一般用结束周周日日期,如果每天计算一次,可用当天日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wk_dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;持续时间&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`continuity_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃次数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_continuity_wk_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 1wk_mid</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id     </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    2wk_mid  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    3wk_mid  </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">21</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;mo&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">14</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  ads_continuity_wk_count</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,date_add(next_day(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;MO&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 1wk_mid </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 2wk_mid </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 3wk_mid </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3wk_mid</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">mid_id</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-8-最近七天内连续三天活跃" tabindex="-1"><a class="header-anchor" href="#_3-1-8-最近七天内连续三天活跃"><span>3.1.8 最近七天内连续三天活跃</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 思路：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第一步：从dws层获取最近7天的数据,对数据按照用户分组进行开窗，按照活跃时间进行降序排序</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第二步：使用活跃时间减去排名，获取一列</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第三步：按照用户和第三步的列进行分组，求count(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 3的用户</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第四步：分组去重</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   第五步：求7天内连续3天的活跃用户</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`wk_dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;最近7天日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`continuity_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;连续活跃设备数&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_continuity_uv_count&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>分析</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -- 第一步：从dws层获取最近7天的数据,对数据按照用户分组进行开窗，按照活跃时间进行降序排序</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        row_number</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="color:#C678DD;--shiki-dark:#C678DD;">over</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ) rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t1</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第二步：使用活跃时间减去排名，获取一列</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        dt ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">		date_add(dt,-rk) dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t1    </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第三步：按照用户和第三步的列进行分组，求count(*) &gt; =3的用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	    mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t2 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    having</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> 	count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	-- 第四步：分组去重</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	     mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t3</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--t4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	--第五步：求7天内连续3天的活跃用户</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">	&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">6</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) wk_dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">	count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) continuity_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">	from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> t4</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_continuity_uv_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        concat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;_&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) wk_dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) continuity_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                mid_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    dt ,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                    date_add(dt,rk) dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                        mid_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                        dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">                        row_number</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="color:#C678DD;--shiki-dark:#C678DD;">over</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">partition</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ) rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> date_add(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                )t1</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            )t2 </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id,dt_rk</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            having</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        )t3</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )t4</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-会员主题" tabindex="-1"><a class="header-anchor" href="#_3-2-会员主题"><span>3.2 会员主题</span></a></h3><h4 id="_3-2-1-会员主题信息" tabindex="-1"><a class="header-anchor" href="#_3-2-1-会员主题信息"><span>3.2.1 会员主题信息</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 几个指标说明</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 总付费会员数：指付费的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员活跃率 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天会员活跃数量 /  总的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员付费率 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天会员付费人数 /  总的会员数量</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 会员新鲜度 </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 今天新增会员数量 / 今天活跃的会员数量</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_users\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;活跃会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_new_users\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_new_payment_users\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;新增消费会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_users\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;总付费会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`users\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;总会员数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_users2users\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员活跃率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_users2users\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员付费率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`day_new_users2users\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员新鲜度&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;会员主题信息表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_topic&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天活跃会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_new_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天新增会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) day_new_payment_users,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--今天新增消费会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_users , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--总付费会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 总会员数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)    day_users2users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员活跃率</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)  payment_users2users ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员付费率</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">   sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_first </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(login_date_last </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))    day_new_users2users </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--会员新鲜度</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_user_topic</span></span></code></pre></div><h4 id="_3-2-2-漏斗分析" tabindex="-1"><a class="header-anchor" href="#_3-2-2-漏斗分析"><span>3.2.2 漏斗分析</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 什么是漏斗分析？</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   其实是指转化率，同一个会员同一次操作业务过程为：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   浏览页面 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 进入详情的页面 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 加入购物车 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 下单 -</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 支付</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   理论上从左往右的人数是越来越少，所以称之为漏斗</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 2. 说明：</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   理论上：进入详情页面的方式有很多，不止是通过浏览页面，所以我们在计算从浏览页面以后进入详情页面应该是连续的，才能算作从浏览</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   页面到页面详情的转换率，但是在本案例中，比较简单粗暴，处理的方式是：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 3. 统计方式：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计浏览首页的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">:统计今天浏览过详情页面的人数，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                          同一个人多次浏览首页算作1次,数据来源每日设备行为:dwd_page_log</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览商品详情页面的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天浏览过详情页面的人数，</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                          同一个用户多次浏览商品详情算作1次，数据来源每日设备行为:dwd_page_log</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加购物车的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天加购物车的人数，数据来源：每日会员行为dws_user_action_daycount</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   4</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天下单的人数,数据来源：每日会员行为dws_user_action_daycount</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">：统计今天支付的人数,数据来源：每日会员行为dws_user_action_daycount</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`home_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览首页人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`good_detail_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;浏览商品详情页人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`home2good_detail_convert_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;首页到商品详情转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`cart_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车的人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`good_detail2cart_convert_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品详情页到加入购物车转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`cart2order_convert_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;">  decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车到下单转化率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order2payment_convert_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单到支付的转化率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;用户行为漏斗分析&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited  fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_user_action_convert_day/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(cart_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车的人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) order_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_count  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--支付人数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_page </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) home_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览首页人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) good_detail_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览商品详情页人数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> /</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(array_contains(pages,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) home2good_detail_convert_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--首页到商品详情转化率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        mid_id,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        --对用户进行分组，过滤出今天进入首页和详情页的用户，获取当天用户的页面行为，去重后放到一个集合中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 那么一行数据有如下2种情况</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 用户     page_id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 243  [&quot;good_detail&quot;,&quot;home&quot;]</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 63   [&quot;home&quot;]</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        collect_set(page_id) pages</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_page_log</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> page_id </span><span style="color:#C678DD;--shiki-dark:#C678DD;">in</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;home&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;good_detail&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> mid_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_user_action_convert_day</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     home_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览首页人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     good_detail_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--浏览商品详情页人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     home2good_detail_convert_ratio ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--首页到商品详情转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     cart_count,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车的人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     cart_count *</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/good_detail_count good_detail2cart_convert_ratio,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品详情页到加入购物车转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     order_count , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     order_count *</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/cart_count  cart2order_convert_ratio ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--加入购物车到下单转化率</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     payment_count,  </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--支付人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     payment_count * </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> / order_count order2payment_convert_ratio </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的转化率</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_page </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_page</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-商品主题" tabindex="-1"><a class="header-anchor" href="#_3-3-商品主题"><span>3.3 商品主题</span></a></h3><h4 id="_3-3-1-商品个数信息" tabindex="-1"><a class="header-anchor" href="#_3-3-1-商品个数信息"><span>3.3.1 商品个数信息</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 需求分析：</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_num\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku个数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    统计到目前为止的sku数量</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`spu_num\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu个数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    统计到目前为止的spu数量</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_num\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;sku个数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`spu_num\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;spu个数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品个数信息&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_info&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_sku </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) sku_num </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--sku个数  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  ),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_spu </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">       count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*) spu_num </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--spu个数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">           &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">           spu_id</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> spu_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    )tmp   </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  )</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">      &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      sku_num,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      spu_num</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_sku </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_spu </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_spu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-商品销量排名" tabindex="-1"><a class="header-anchor" href="#_3-3-2-商品销量排名"><span>3.3.2 商品销量排名</span></a></h4><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 1. 商品销量排名：</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. 是按照什么规则进行排名？本需求是按照当天的产品的支付金额的大小进行排名</span></span></code></pre></div><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;销量&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品个数信息&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_sale_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_sale_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_amount </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span></span></code></pre></div><h4 id="_3-3-3-商品收藏排名" tabindex="-1"><a class="header-anchor" href="#_3-3-3-商品收藏排名"><span>3.3.3 商品收藏排名</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`favor_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;收藏量&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品收藏TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_favor_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_favor_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    favor_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> favor_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-4-商品加入购物车排名" tabindex="-1"><a class="header-anchor" href="#_3-3-4-商品加入购物车排名"><span>3.3.4 商品加入购物车排名</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`cart_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;加入购物车次数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品加入购物车TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_cart_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_cart_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    cart_count</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> cart_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-5-商品退款率排名-近30天" tabindex="-1"><a class="header-anchor" href="#_3-3-5-商品退款率排名-近30天"><span>3.3.5 商品退款率排名(近30天)</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`refund_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;退款率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品退款率TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_product_refund_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> overwrite </span><span style="color:#C678DD;--shiki-dark:#C678DD;">table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_product_refund_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    refund_last_30d_count/payment_last_30d_count*</span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_ratio</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_sku_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> refund_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-3-6-商品差评率" tabindex="-1"><a class="header-anchor" href="#_3-3-6-商品差评率"><span>3.3.6 商品差评率</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`sku_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`appraise_bad_ratio\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;差评率&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;商品差评率TopN&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_appraise_bad_topN&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_appraise_bad_topN</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    sku_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">appraise_bad_count/(appraise_good_count+appraise_mid_count+appraise_bad_count+appraise_default_count) appraise_bad_ratio</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">order by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> appraise_bad_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">desc</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">limit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h3 id="_3-4-营销主题" tabindex="-1"><a class="header-anchor" href="#_3-4-营销主题"><span>3.4 营销主题</span></a></h3><h4 id="_3-4-1-下单数目统计" tabindex="-1"><a class="header-anchor" href="#_3-4-1-下单数目统计"><span>3.4.1 下单数目统计</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单笔数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_users </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日下单用户数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日订单总计表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_order_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><p>插入数据</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">   &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单笔数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount ) order_amount ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日下单用户数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span></code></pre></div><p>分析</p><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_order_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_amount),</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><h4 id="_3-4-2-支付信息统计" tabindex="-1"><a class="header-anchor" href="#_3-4-2-支付信息统计"><span>3.4.2 支付信息统计</span></a></h4><ul><li>建表</li></ul><div class="language-sql" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    dt string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付笔数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_amount </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_user_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_sku_count </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单日支付商品数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_avg_time </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;下单到支付的平均时长，取分钟数&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;每日订单总计表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_payment_daycount&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_user </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_count) order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付笔数</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount) order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付金额</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> , </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_user_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付人数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">      &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(payment_amount </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) payment_sku_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付商品数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">   select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(unix_timestamp(payment_time)-unix_timestamp(create_time))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(*)/</span><span style="color:#D19A66;--shiki-dark:#D19A66;">60</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_avg_time </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的平均时长，取分钟数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_fact_order_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    and</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> payment_time </span><span style="color:#C678DD;--shiki-dark:#C678DD;">is not null</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  )</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  insert into</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_payment_daycount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt , </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--统计日期</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_count, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付笔数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        order_amount,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付金额</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_user_count ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付人数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_sku_count ,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--单日支付商品数</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        payment_avg_time </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--下单到支付的平均时长，取分钟数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_user</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_action </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_user</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_action</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">dt</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-品牌复购率-月复购" tabindex="-1"><a class="header-anchor" href="#_3-4-3-品牌复购率-月复购"><span>3.4.3 品牌复购率(月复购)</span></a></h4><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(  </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tm_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;品牌id&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_id string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1级品类id &#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_name string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;1级品类名称 &#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buycount   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_twice_last </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;两次以上购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_twice_last_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;单次复购率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_3times_last   </span><span style="color:#C678DD;--shiki-dark:#C678DD;">bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> comment   </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;三次以上购买人数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    buy_3times_last_ratio </span><span style="color:#C678DD;--shiki-dark:#C678DD;">decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)  comment  </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;多次复购率&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    stat_mn string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计月份&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    stat_date string comment </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)   COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;复购率统计&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_sale_tm_category1_stat_mn/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">with</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_order </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        user_id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--用户di</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        order_stats_struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> sku_id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品id</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        order_stats_struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">order_count</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品被购买的次数</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 使用侧写的方式，将一个用户当天购买的每个商品的明细（数组）进行侧写，形成多行</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dws_user_action_daycount lateral view explode(order_detail_stats) tmp </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> order_stats_struct </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(dt,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#C678DD;--shiki-dark:#C678DD;">date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--取当天的数据</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">tmp_sku </span><span style="color:#C678DD;--shiki-dark:#C678DD;">as</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        id,</span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--商品id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        tm_id, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 品牌id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        category1_id, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一次品类的id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        category1_name </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--一次品类的名字</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwd_dim_sku_info</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    where</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dt</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    tm_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    category1_name,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buycount,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buyTwiceLast,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">( </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buyTwiceLastRatio,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))  buy3timeLast  ,</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))/</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">( </span><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) buy3timeLastRatio ,</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    date_format</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ,</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;yyyy-MM&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) stat_mn,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> stat_date</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    select</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--用户</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一级品类</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 一级品类的名字</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">        tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tm_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 品牌</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        sum</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(order_count) order_count </span><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 购买同一品牌数量</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_order</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    join</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tmp_sku</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    on</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">sku_id</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">id</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 按照用户 + 1级品类 + 品牌id分组，得到一个用户购买某一个1级品类的某一品牌的个数</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    group by</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> tmp_order</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">user_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">category1_name</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tmp_sku</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#D19A66;--shiki-dark:#D19A66;">tm_id</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)tmp</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 按照品牌进行 + </span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">group by</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> tm_id, category1_id, category1_name;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-地区主题" tabindex="-1"><a class="header-anchor" href="#_3-5-地区主题"><span>3.5 地区主题</span></a></h3><h4 id="_3-5-1-地区主题信息" tabindex="-1"><a class="header-anchor" href="#_3-5-1-地区主题信息"><span>3.5.1 地区主题信息</span></a></h4><ul><li>建表</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">drop</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> if</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> exists</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">create</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> external</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`dt\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;统计日期&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`id\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;编号&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`province_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;省份名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`area_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`iso_code\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;iso编码&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_id\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区ID&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`region_name\`</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> string COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区名称&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`login_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天活跃设备数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`order_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天下单金额&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_count\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> bigint</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付次数&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \`payment_day_amount\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> decimal</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">16</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;当天支付金额&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) COMMENT </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;地区主题宽表&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">row</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> format delimited fields terminated </span><span style="color:#C678DD;--shiki-dark:#C678DD;">by</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;\\t&#39;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">location</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/warehouse/gmall/ads/ads_area_topic/&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>插入数据</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-25&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_amount</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">insert into</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> table</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ads_area_topic</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;2020-06-14&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    province_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    area_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    iso_code,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_id,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    region_name,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    login_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    order_day_amount,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_count,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    payment_day_amount</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 直接导入dwt的地区表</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dwt_area_topic;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-导入脚本" tabindex="-1"><a class="header-anchor" href="#_3-6-导入脚本"><span>3.6 导入脚本</span></a></h3><ol><li>在/home/atguigu/bin目录下创建脚本dwt_to_ads.sh</li></ol><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>[atguigu@hadoop102 bin]$ vim dwt_to_ads.sh</span></span></code></pre></div><ol start="2"><li>脚本内容</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">hive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">/opt/module/hive/bin/hive</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">gmall</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-n</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ] ;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E06C75;font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">else</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    do_date</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">\`</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">date</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -d</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;-1 day&quot; +%F\`</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">sql</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">set mapreduce.job.queuename=hive;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_uv_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    daycount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    wkcount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    mncount.ct,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;Y&#39;,&#39;N&#39;) ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    if(last_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;)=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;Y&#39;,&#39;N&#39;) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)daycount join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count (*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_last&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) wkcount on daycount.dt=wkcount.dt</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">( </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count (*) ct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where date_format(login_date_last,&#39;yyyy-MM&#39;)=date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;yyyy-MM&#39;)  </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)mncount on daycount.dt=mncount.dt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_new_mid_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_date_first,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by login_date_first;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_silent_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where login_date_first=login_date_last</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">and login_date_last&lt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-7);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_back_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">concat(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7),&#39;_&#39;, date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_last&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and login_date_first&lt;date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)current_wk</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">left join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7*2) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and dt&lt;= date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7-1) </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)last_wk</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on current_wk.mid_id=last_wk.mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where last_wk.mid_id is null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_wastage_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">     count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where login_date_last&lt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t1;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_retention_day_rate</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    1,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的1日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-1),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    2,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的2日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-2),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,--统计日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),--新增日期</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    3,--留存天数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date的3日留存数</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),1,0)),--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date新增</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3) and login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_first=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-3),1,0))*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_uv_topic;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_continuity_wk_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    concat(date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-7*3),&#39;_&#39;,date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;MO&#39;),-1)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*2)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        union all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt&gt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*3)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and dt&lt;=date_add(next_day(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;monday&#39;),-7*2-1)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )t1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    having count(*)=3</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t2;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_continuity_uv_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    concat(date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-6),&#39;_&#39;,&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select mid_id      </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                date_sub(dt,rank) date_dif</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                    rank() over(partition by mid_id order by dt) rank</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_uv_detail_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">                where dt&gt;=date_add(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,-6) and dt&lt;=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            )t1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        )t2 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id,date_dif</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        having count(*)&gt;=3</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )t3 </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)t4;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_count&gt;0,1,0)),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(payment_count&gt;0,1,0))/count(*),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(login_date_first=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))/sum(if(login_date_last=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,1,0))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_user_topic;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_uv as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(array_contains(pages,&#39;home&#39;),1,0)) home_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(array_contains(pages,&#39;good_detail&#39;),1,0)) good_detail_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            mid_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            collect_set(page_id) pages</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_page_log</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        and page_id in (&#39;home&#39;,&#39;good_detail&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by mid_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    )tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_cop as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(cart_count&gt;0,1,0)) cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(order_count&gt;0,1,0)) order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_user_action_convert_day</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.home_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.good_detail_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_uv.good_detail_count/tmp_uv.home_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.cart_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.cart_count/tmp_uv.good_detail_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.order_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.order_count/tmp_cop.cart_count*100,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_cop.payment_count/tmp_cop.order_count*100</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from tmp_uv</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join tmp_cop</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on tmp_uv.dt=tmp_cop.dt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_num,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) sku_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) tmp_sku_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        count(*) spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    (</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        group by</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">            spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ) tmp_spu_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">) tmp_spu_num</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">on</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_sku_num.dt=tmp_spu_num.dt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_sale_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by payment_amount desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_favor_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    favor_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by favor_count desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_cart_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    cart_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by cart_count desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_product_refund_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    refund_last_30d_count/payment_last_30d_count*100 refund_ratio</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_sku_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by refund_ratio desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_appraise_bad_topN</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">appraise_bad_count/(appraise_good_count+appraise_mid_count+appraise_bad_count+appraise_default_count) appraise_bad_ratio</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">order by appraise_bad_ratio desc</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">limit 10;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_order_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_count),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(order_amount),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;0,1,0))</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_payment_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_payment.payment_user_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_skucount.payment_sku_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tmp_time.payment_avg_time</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_count) payment_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(payment_amount) payment_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_user_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_payment</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(if(payment_count&gt;0,1,0)) payment_sku_count </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_sku_action_daycount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_skucount on tmp_payment.dt=tmp_skucount.dt</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">join</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; dt,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(unix_timestamp(payment_time)-unix_timestamp(create_time))/count(*)/60 payment_avg_time</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_fact_order_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    and payment_time is not null</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp_time on tmp_payment.dt=tmp_time.dt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">with </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_order as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_stats_struct.sku_id sku_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        order_stats_struct.order_count order_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dws_user_action_daycount lateral view explode(order_detail_stats) tmp as order_stats_struct</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where date_format(dt,&#39;yyyy-MM&#39;)=date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,&#39;yyyy-MM&#39;)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">),</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">tmp_sku as</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        category1_name</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwd_dim_sku_info</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    where dt=&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_sale_tm_category1_stat_mn</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    category1_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=1,1,0)) buycount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=2,1,0)) buyTwiceLast,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=2,1,0))/sum( if(order_count&gt;=1,1,0)) buyTwiceLastRatio,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=3,1,0))  buy3timeLast  ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    sum(if(order_count&gt;=3,1,0))/sum( if(order_count&gt;=1,1,0)) buy3timeLastRatio ,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    date_format(&#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; ,&#39;yyyy-MM&#39;) stat_mn,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39; stat_date</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">(</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    select </span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_order.user_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.category1_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.category1_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        tmp_sku.tm_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        sum(order_count) order_count</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    from tmp_order</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    join tmp_sku</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    on tmp_order.sku_id=tmp_sku.id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    group by tmp_order.user_id,tmp_sku.category1_id,tmp_sku.category1_name,tmp_sku.tm_id</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">)tmp</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">group by tm_id, category1_id, category1_name;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">insert into table \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.ads_area_topic</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">select</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &#39;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$do_date</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    province_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    area_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    iso_code,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    region_id,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    region_name,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    login_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    order_day_amount,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_day_count,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    payment_day_amount</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">from \${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">APP</span><span style="color:#98C379;--shiki-dark:#98C379;">}.dwt_area_topic;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">$hive</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> -e </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">$sql</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>ods层：24张</span></span>
<span class="line"><span>    log：1张</span></span>
<span class="line"><span>    业务数据：23张。</span></span>
<span class="line"><span>dwd层：19张</span></span>
<span class="line"><span>    log：5张</span></span>
<span class="line"><span>    业务数据：6张维度表，8张事实表</span></span>
<span class="line"><span>dws和dwt层：12张</span></span>
<span class="line"><span>    维度：设备、会员、商品、地区、时间、活动：12张</span></span>
<span class="line"><span>ads层：20张</span></span>
<span class="line"><span>    设备：8张</span></span>
<span class="line"><span>    会员：2张</span></span>
<span class="line"><span>    商品：6张</span></span>
<span class="line"><span>    营销：3张</span></span>
<span class="line"><span>    地区：1张</span></span>
<span class="line"><span>共计：20 + 12 + 19 + 24 = 75张</span></span>
<span class="line"><span>另外：</span></span>
<span class="line"><span>临时表：拉链表：1张</span></span>
<span class="line"><span>       时间表：1张</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,231)]))}const B=a(p,[["render",r],["__file","电商数仓系统(二).html.vue"]]),d=JSON.parse(`{"path":"/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html","title":"电商数仓系统(二)","lang":"zh-CN","frontmatter":{"description":"电商数仓系统(二) ##一、DWS/DWT准备 1.1 业务术语 1.2 系统函数 1.2.1 celloect_set 1.2.2 nvl 1.2.3 coalesce 1.2.4日期函数(重要) 二、DWS/DWT层 2.1 DWS/DWT思想 2.2 用户行为数据 2.2.1 每日设备DWS层 建表语句 加载数据 2.2.2 设备主题DWT层 建...","head":[["meta",{"property":"og:url","content":"https://mrjackc.github.io/posts/BigData/11_%E6%95%B0%E4%BB%93/%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93%E7%B3%BB%E7%BB%9F(%E4%BA%8C).html"}],["meta",{"property":"og:site_name","content":"mrjason’s Blog"}],["meta",{"property":"og:title","content":"电商数仓系统(二)"}],["meta",{"property":"og:description","content":"电商数仓系统(二) ##一、DWS/DWT准备 1.1 业务术语 1.2 系统函数 1.2.1 celloect_set 1.2.2 nvl 1.2.3 coalesce 1.2.4日期函数(重要) 二、DWS/DWT层 2.1 DWS/DWT思想 2.2 用户行为数据 2.2.1 每日设备DWS层 建表语句 加载数据 2.2.2 设备主题DWT层 建..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic GO/20200709012005.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-28T01:58:08.000Z"}],["meta",{"property":"article:author","content":"MrJason"}],["meta",{"property":"article:modified_time","content":"2024-10-28T01:58:08.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"电商数仓系统(二)\\",\\"image\\":[\\"https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic GO/20200709012005.png\\"],\\"dateModified\\":\\"2024-10-28T01:58:08.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"MrJason\\",\\"url\\":\\"https://mrjackc.github.io\\"}]}"]]},"headers":[{"level":3,"title":"1.1 业务术语","slug":"_1-1-业务术语","link":"#_1-1-业务术语","children":[]},{"level":3,"title":"1.2 系统函数","slug":"_1-2-系统函数","link":"#_1-2-系统函数","children":[]},{"level":2,"title":"二、DWS/DWT层","slug":"二、dws-dwt层","link":"#二、dws-dwt层","children":[{"level":3,"title":"2.1 DWS/DWT思想","slug":"_2-1-dws-dwt思想","link":"#_2-1-dws-dwt思想","children":[]},{"level":3,"title":"2.2 用户行为数据","slug":"_2-2-用户行为数据","link":"#_2-2-用户行为数据","children":[]},{"level":3,"title":"2.3 业务数据","slug":"_2-3-业务数据","link":"#_2-3-业务数据","children":[]},{"level":3,"title":"2.4 脚本","slug":"_2-4-脚本","link":"#_2-4-脚本","children":[]}]},{"level":2,"title":"三、数仓搭建ADS层","slug":"三、数仓搭建ads层","link":"#三、数仓搭建ads层","children":[{"level":3,"title":"3.0 ADS层思想","slug":"_3-0-ads层思想","link":"#_3-0-ads层思想","children":[]},{"level":3,"title":"3.1 设备主题","slug":"_3-1-设备主题","link":"#_3-1-设备主题","children":[]},{"level":3,"title":"3.2 会员主题","slug":"_3-2-会员主题","link":"#_3-2-会员主题","children":[]},{"level":3,"title":"3.3 商品主题","slug":"_3-3-商品主题","link":"#_3-3-商品主题","children":[]},{"level":3,"title":"3.4 营销主题","slug":"_3-4-营销主题","link":"#_3-4-营销主题","children":[]},{"level":3,"title":"3.5 地区主题","slug":"_3-5-地区主题","link":"#_3-5-地区主题","children":[]},{"level":3,"title":"3.6 导入脚本","slug":"_3-6-导入脚本","link":"#_3-6-导入脚本","children":[]}]}],"git":{"createdTime":1730080688000,"updatedTime":1730080688000,"contributors":[{"name":"MrJason","email":"845886914@qq.com","commits":1}]},"readingTime":{"minutes":55.39,"words":16618},"filePathRelative":"posts/BigData/11_数仓/电商数仓系统(二).md","localizedDate":"2024年10月28日","excerpt":"\\n<hr>\\n<p>##一、DWS/DWT准备</p>\\n<h3>1.1 业务术语</h3>\\n<div class=\\"language-sql line-numbers-mode\\" data-ext=\\"sql\\" data-title=\\"sql\\"><pre class=\\"shiki shiki-themes one-dark-pro one-dark-pro vp-code\\" style=\\"background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf\\" tabindex=\\"0\\"><code><span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 1. 用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    a、统计流量相关的需求：使用设备id，如统计活跃用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    b、统计业务相关的指标，使用用户id，如统计下单数量</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">--2. 新增用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    a、如果一个用户首次打开某APP，那这个用户定义为新增用户；</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    b、卸载再安装的设备，不会被算作一次新增。</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    c、新增用户包括日新增用户、周新增用户、月新增用户。</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 3. 活跃用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、打开应用的用户即为活跃用户，不考虑用户的使用情况。</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、每天一台设备打开多次会被计为一个活跃用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 4. 周活跃用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、某个自然周（月）内启动过应用的用户；</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、该周（月）内的多次启动只记一个活跃用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 5. 月活跃率</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、当月活跃用户 / 总用户数</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 6. 沉默用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、用户仅在安装当天（次日）启动一次，后续时间无再启动行为</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、指标可以反映新增用户质量和用户与APP的匹配程度</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 7. 版本分布</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、不同版本的周内各天新增用户数，活跃用户数和启动次数</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、判断APP各个版本之间的优劣和用户行为习惯</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 8. 本周回流用</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、上周未启动应用, 本周启动了应用的用户，且不是本周新增用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 9. 连续n周</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、连续n周, 每周至少启动一次</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 10. 忠诚用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">    a、连续活跃5周以上的用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 10. 连续活跃用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、连续两周以上的活跃用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 11. 近期流失用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、连续n(</span><span style=\\"color:#D19A66;--shiki-dark:#D19A66\\">2</span><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">-4周)周没有启动应用的用户</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 12. 留存用户</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、某段时间内的新增用户，经过一段时间后，仍然使用应用的被认作是留存用户；这部分用户占当时新增用户的比例即是留存率。</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、例如，5月份新增用户200，这200人启动情况：</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\t  6月份：启动人数为100人，5月份新增用户一个月后的留存率是50%</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\t  7月份：启动人数为80人，5月份新增用户二个月后的留存率是40%</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\t  8月份：启动人数为100人，5月份新增用户三个月后的留存率是50%</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tc、留存用户一般是统计留存率，同时必须有两个参数：哪个月份的几月的留存率</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 13. 用户新鲜度</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、每天启动应用的新老用户比例</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\tb、用户新鲜度 </span><span style=\\"color:#56B6C2;--shiki-dark:#56B6C2\\">=</span><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\"> 新用户数量 / 当日活跃用户数 </span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 14. 单次使用时长</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、每次启动使用的时间长度</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 15. 日使用时长</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">\\ta、累计一天内的使用时间长度。</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">-- 16. 启动次数计算标准</span></span>\\n<span class=\\"line\\"><span style=\\"color:#98C379;--shiki-dark:#98C379\\">   '背景'</span><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">：IOS平台应用退到后台，是真的退出应用，后台会释放资源</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">          Android平台应用退到后台，并不会立即退出应用，因为应用和应用之间存在互相唤醒的问题。</span></span>\\n<span class=\\"line\\"><span style=\\"color:#98C379;--shiki-dark:#98C379\\">    '统计方式'</span><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">：</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">        IOS平台应用退到后台就算一次独立的启动</span></span>\\n<span class=\\"line\\"><span style=\\"color:#ABB2BF;--shiki-dark:#ABB2BF\\">        Android平台我们规定，两次启动之间的间隔小于30秒，被计算一次启动</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}`);export{B as comp,d as data};
